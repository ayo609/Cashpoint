<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cashpoint | Admin Dashboard</title>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>

<style>
:root {
  --primary:#0052FF;
  --primary-dark:#0038B8;
  --primary-glow:rgba(0,82,255,0.18);
  --accent:#00D4A0;
  --danger:#FF4D6D;
  --warning:#FFB800;
  --success:#00C48C;
  --text:#0D1B3E;
  --muted:#6B7A99;
  --border:#D8E0F0;
  --bg:#EEF2FF;
  --card:#FFFFFF;
  --gift-gradient:linear-gradient(135deg, #FF6B6B, #FF8E53);
  --gift-gold:linear-gradient(135deg, #FFD700, #FFA500);
  --gift-claim:linear-gradient(135deg, #00C48C, #00A87E);
  --gift-expiry:linear-gradient(135deg, #FF4D6D, #c0392b);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading-overlay{
  position:fixed;inset:0;background:white;
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;
  z-index:9999;transition:opacity .5s,visibility .5s;
}
.loading-overlay.hidden{opacity:0;visibility:hidden;pointer-events:none}
.loader{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{font-family:'Sora',sans-serif;font-size:13px;font-weight:700;color:var(--muted)}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{
  background:white;border-bottom:1px solid var(--border);
  padding:0 28px;height:66px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 2px 20px rgba(0,82,255,0.07);
  position:sticky;top:0;z-index:100;
}
.topbar-brand{display:flex;align-items:center;gap:12px}
.brand-icon{
  width:40px;height:40px;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  border-radius:12px;display:flex;align-items:center;justify-content:center;
  font-size:18px;box-shadow:0 4px 14px var(--primary-glow);
}
.brand-name{font-family:'Sora',sans-serif;font-size:19px;font-weight:800;color:var(--text)}
.brand-badge{background:var(--danger);color:white;font-size:9px;font-weight:800;padding:3px 7px;border-radius:6px;letter-spacing:.5px;}
.topbar-right{display:flex;align-items:center;gap:10px}
.admin-pill{
  display:flex;align-items:center;gap:8px;background:var(--bg);
  border-radius:99px;padding:6px 14px 6px 8px;font-size:13px;font-weight:700;border:1px solid var(--border);
}
.admin-av{
  width:30px;height:30px;border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  color:white;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;
}
.topbar-btn{
  padding:8px 16px;border-radius:10px;border:none;font-size:13px;font-weight:700;
  font-family:inherit;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .2s;
}
.logout-btn{background:#FFF0F3;color:var(--danger)}
.logout-btn:hover{background:var(--danger);color:white;transform:translateY(-1px)}

/* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
.page{max-width:1060px;margin:0 auto;padding:32px 20px 80px}

/* ‚îÄ‚îÄ WELCOME BANNER ‚îÄ‚îÄ */
.welcome{
  background:linear-gradient(135deg,#0052FF 0%,#001c6b 100%);
  border-radius:24px;padding:32px;color:white;margin-bottom:28px;
  display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap;
  position:relative;overflow:hidden;
  box-shadow:0 10px 40px rgba(0,82,255,0.3);
  animation:slideDown .6s ease;
}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
.welcome::before{content:'';position:absolute;top:-80px;right:-80px;width:280px;height:280px;background:radial-gradient(circle,rgba(255,255,255,0.08),transparent);border-radius:50%;}
.welcome::after{content:'';position:absolute;bottom:-60px;left:30%;width:200px;height:200px;background:radial-gradient(circle,rgba(0,212,160,0.12),transparent);border-radius:50%;}
.welcome-left{position:relative;z-index:1}
.welcome-left h1{font-family:'Sora',sans-serif;font-size:24px;font-weight:800;margin-bottom:6px;}
.welcome-left p{font-size:14px;opacity:.8;font-weight:500}
.welcome-stats{display:flex;gap:16px;flex-wrap:wrap;position:relative;z-index:1;}
.wstat{
  text-align:center;background:rgba(255,255,255,0.13);
  border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:14px 22px;
  backdrop-filter:blur(4px);transition:transform .2s;cursor:default;
}
.wstat:hover{transform:translateY(-3px)}
.wstat-val{font-family:'Sora',sans-serif;font-size:26px;font-weight:800;line-height:1;margin-bottom:4px;}
.wstat-lbl{font-size:11px;opacity:.75;font-weight:600;text-transform:uppercase;letter-spacing:.5px}

/* live dot */
.live-badge{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(0,196,140,0.2);border:1px solid rgba(0,196,140,0.4);
  border-radius:99px;padding:4px 10px;font-size:11px;font-weight:700;color:#00C48C;
  margin-top:10px;
}
.live-dot{width:6px;height:6px;border-radius:50%;background:#00C48C;animation:pulseDot 2s infinite;}
@keyframes pulseDot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}

/* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
.section-title{
  font-family:'Sora',sans-serif;font-size:13px;font-weight:800;
  color:var(--muted);margin-bottom:16px;
  display:flex;align-items:center;gap:10px;
  text-transform:uppercase;letter-spacing:.8px;
}
.section-title::after{content:'';flex:1;height:1px;background:var(--border)}

/* ‚îÄ‚îÄ QUICK STATS ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:14px;margin-bottom:32px;}
.stat-card{
  background:white;border-radius:18px;padding:20px 16px;
  box-shadow:0 2px 12px rgba(0,82,255,0.06);border:1px solid var(--border);
  transition:transform .2s,box-shadow .2s;animation:fadeUp .5s ease both;
  cursor:default;
}
.stat-card:hover{transform:translateY(-4px);box-shadow:0 8px 28px rgba(0,82,255,0.12)}
.stat-card:nth-child(1){animation-delay:.05s}
.stat-card:nth-child(2){animation-delay:.1s}
.stat-card:nth-child(3){animation-delay:.15s}
.stat-card:nth-child(4){animation-delay:.2s}
.stat-card:nth-child(5){animation-delay:.25s}
.stat-card:nth-child(6){animation-delay:.3s}
.stat-card:nth-child(7){animation-delay:.35s}
.stat-card:nth-child(8){animation-delay:.4s}
.stat-card:nth-child(9){animation-delay:.45s}
.stat-card:nth-child(10){animation-delay:.5s}
.stat-card:nth-child(11){animation-delay:.55s}
.stat-card:nth-child(12){animation-delay:.6s}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.stat-icon-wrap{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:12px;}
.si-blue{background:#E8F0FF}.si-green{background:#E8FFF6}.si-orange{background:#FFF8E8}
.si-red{background:#FFF0F3}.si-purple{background:#F3EFFF}.si-teal{background:#E6FBF6}
.si-indigo{background:#e0e0ff}.si-pink{background:#ffe6f2}
.si-gift{background:var(--gift-gradient);color:white}
.si-gold{background:var(--gift-gold);color:white}
.si-claim{background:var(--gift-claim);color:white}
.si-expiry{background:var(--gift-expiry);color:white}
.stat-val{font-family:'Sora',sans-serif;font-size:22px;font-weight:800;color:var(--text);margin-bottom:4px;line-height:1;}
.stat-lbl{font-size:11.5px;color:var(--muted);font-weight:600}
.stat-trend{font-size:11px;font-weight:700;margin-top:6px;display:flex;align-items:center;gap:3px;}
.trend-up{color:var(--success)}.trend-down{color:var(--danger)}.trend-flat{color:var(--muted)}

/* ‚îÄ‚îÄ NAV GRID ‚îÄ‚îÄ */
.nav-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-bottom:36px;}
.nav-card{
  background:white;border-radius:20px;padding:22px 20px;
  display:flex;flex-direction:column;align-items:flex-start;gap:10px;
  cursor:pointer;text-decoration:none;color:inherit;
  border:2px solid transparent;box-shadow:0 3px 16px rgba(0,82,255,0.07);
  transition:transform .2s,box-shadow .2s,border-color .2s;
  position:relative;overflow:hidden;animation:fadeUp .5s ease both;
}
.nav-card:nth-child(1){animation-delay:.1s}.nav-card:nth-child(2){animation-delay:.12s}
.nav-card:nth-child(3){animation-delay:.14s}.nav-card:nth-child(4){animation-delay:.16s}
.nav-card:nth-child(5){animation-delay:.18s}.nav-card:nth-child(6){animation-delay:.2s}
.nav-card:nth-child(7){animation-delay:.22s}.nav-card:nth-child(8){animation-delay:.24s}
.nav-card:nth-child(9){animation-delay:.26s}.nav-card:nth-child(10){animation-delay:.28s}
.nav-card:nth-child(11){animation-delay:.3s}.nav-card:nth-child(12){animation-delay:.32s}
.nav-card:hover{transform:translateY(-5px);box-shadow:0 14px 36px rgba(0,82,255,0.13);border-color:var(--card-color,var(--primary));}
.nav-card-icon{width:50px;height:50px;border-radius:15px;display:flex;align-items:center;justify-content:center;font-size:22px;}
.nav-card-title{font-family:'Sora',sans-serif;font-size:15px;font-weight:700}
.nav-card-desc{font-size:12px;color:var(--muted);font-weight:500;line-height:1.6}
.nav-card-arrow{position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--border);transition:color .2s,transform .2s;}
.nav-card:hover .nav-card-arrow{color:var(--card-color,var(--primary));transform:translateY(-50%) translateX(4px);}
.nav-badge{
  position:absolute;top:14px;right:14px;background:var(--danger);color:white;
  font-size:10px;font-weight:800;padding:3px 8px;border-radius:99px;
  min-width:22px;text-align:center;animation:pulseBadge 2s ease-in-out infinite;
}
@keyframes pulseBadge{0%,100%{box-shadow:0 0 0 0 rgba(255,77,109,.4)}50%{box-shadow:0 0 0 5px rgba(255,77,109,0)}}
.nav-badge.hidden{display:none}
.c-blue{--card-color:#0052FF;background:#E8F0FF}
.c-green{--card-color:#00C48C;background:#E8FFF6}
.c-orange{--card-color:#FFB800;background:#FFF8E8}
.c-red{--card-color:#FF4D6D;background:#FFF0F3}
.c-purple{--card-color:#7C3AED;background:#F3EFFF}
.c-teal{--card-color:#00D4A0;background:#E6FBF6}
.c-indigo{--card-color:#4B0082;background:#f0e6ff}
.c-pink{--card-color:#FF1493;background:#ffe6f2}
.c-gift{--card-color:#FF6B6B;background:var(--gift-gradient);color:white}
.c-gift i{color:white}

/* ‚îÄ‚îÄ PLATFORM STATUS BAR ‚îÄ‚îÄ */
.status-bar{
  background:white;border-radius:18px;padding:18px 24px;margin-bottom:28px;
  border:1px solid var(--border);box-shadow:0 2px 12px rgba(0,82,255,0.06);
  display:flex;align-items:center;gap:20px;flex-wrap:wrap;
  animation:fadeUp .5s ease .35s both;
}
.status-item{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.status-dot.green{background:var(--success);box-shadow:0 0 0 3px rgba(0,196,140,0.2);}
.status-dot.orange{background:var(--warning);box-shadow:0 0 0 3px rgba(255,184,0,0.2);}
.status-dot.red{background:var(--danger);box-shadow:0 0 0 3px rgba(255,77,109,0.2);}
.status-divider{width:1px;height:20px;background:var(--border);}
.status-refresh{margin-left:auto;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;color:var(--muted);cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:5px;transition:all .2s;}
.status-refresh:hover{border-color:var(--primary);color:var(--primary);}
.status-refresh.spinning i{animation:spin .7s linear infinite;}

/* ‚îÄ‚îÄ DANGER ZONE ‚îÄ‚îÄ */
.danger-zone{
  background:white;border-radius:24px;border:2px solid #FFE0E6;
  padding:28px;margin-bottom:20px;animation:fadeUp .6s ease .4s both;
}
.danger-zone-header{display:flex;align-items:center;gap:14px;margin-bottom:22px;}
.danger-icon-wrap{
  width:52px;height:52px;border-radius:14px;background:#FFF0F3;
  display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;
}
.danger-info h3{font-family:'Sora',sans-serif;font-size:17px;font-weight:800;color:var(--danger);margin-bottom:4px;}
.danger-info p{font-size:13px;color:var(--muted);font-weight:500;line-height:1.5}

.reset-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:16px;}
.reset-btn{
  padding:14px 18px;border-radius:14px;border:2px solid #FFD0D9;
  background:#FFF8F9;color:var(--danger);
  font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;
  display:flex;align-items:center;gap:9px;
  transition:all .2s;text-align:left;
}
.reset-btn:hover{background:var(--danger);color:white;border-color:var(--danger);transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,77,109,.3);}
.reset-btn-icon{width:32px;height:32px;border-radius:9px;background:rgba(255,77,109,0.12);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;transition:background .2s;}
.reset-btn:hover .reset-btn-icon{background:rgba(255,255,255,0.2);}
.reset-btn-text{display:flex;flex-direction:column;}
.reset-btn-title{font-size:13px;font-weight:700;line-height:1;}
.reset-btn-sub{font-size:10.5px;font-weight:500;opacity:.7;margin-top:2px;}

.full-reset-btn{
  width:100%;padding:16px 24px;border-radius:14px;border:none;
  background:linear-gradient(135deg,var(--danger),#c41a40);
  color:white;font-size:15px;font-weight:800;font-family:'Sora',sans-serif;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;
  transition:all .25s;box-shadow:0 6px 24px rgba(255,77,109,.35);letter-spacing:.02em;
}
.full-reset-btn:hover{transform:translateY(-3px);box-shadow:0 12px 36px rgba(255,77,109,.45);background:linear-gradient(135deg,#ff2d55,#c41a40);}
.full-reset-btn:active{transform:translateY(0);}

.danger-note{
  background:#FFF0F3;border:1px solid #FFD0D9;border-radius:12px;
  padding:12px 16px;margin-top:14px;font-size:12px;color:#B02040;font-weight:600;
  display:flex;align-items:flex-start;gap:8px;line-height:1.5;
}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(13,27,62,0.65);backdrop-filter:blur(8px);
  display:flex;align-items:center;justify-content:center;z-index:10001;
  opacity:0;visibility:hidden;transition:.3s;padding:1rem;
}
.modal-overlay.active{opacity:1;visibility:visible}
.modal-box{
  background:white;border-radius:28px;padding:40px;max-width:500px;width:100%;
  box-shadow:0 30px 90px rgba(13,27,62,0.25);
  transform:scale(.92) translateY(20px);
  transition:.35s cubic-bezier(.34,1.56,.64,1);
  text-align:center;
}
.modal-overlay.active .modal-box{transform:scale(1) translateY(0)}
.modal-emoji{font-size:56px;margin-bottom:18px;display:block;animation:bounce .6s ease;}
@keyframes bounce{0%,100%{transform:scale(1)}40%{transform:scale(1.15)}70%{transform:scale(.95)}}
.modal-title{font-family:'Sora',sans-serif;font-size:22px;font-weight:800;color:var(--text);margin-bottom:10px;}
.modal-msg{font-size:14px;color:var(--muted);line-height:1.7;margin-bottom:8px}
.modal-warning{
  background:#FFF0F3;border:1.5px solid #FFD0D9;border-radius:14px;padding:16px;margin:20px 0;
  font-size:13px;color:#C41A40;font-weight:600;line-height:1.6;text-align:left;
}
.modal-confirm-label{font-size:13px;color:var(--muted);font-weight:600;margin-bottom:8px;}
.modal-confirm-input{
  width:100%;padding:13px 16px;background:var(--bg);border:2px solid var(--border);
  border-radius:12px;font-size:15px;font-weight:800;font-family:'Sora',sans-serif;
  color:var(--text);text-align:center;margin-bottom:20px;transition:.3s;letter-spacing:2px;
}
.modal-confirm-input:focus{outline:none;border-color:var(--danger);}
.modal-confirm-input.valid{border-color:var(--danger);background:#FFF0F3;color:var(--danger);}
.modal-buttons{display:flex;gap:12px;}
.modal-btn{flex:1;padding:14px;border-radius:12px;border:none;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s;}
.modal-btn-cancel{background:var(--bg);color:var(--muted);border:1.5px solid var(--border);}
.modal-btn-cancel:hover{background:var(--border);}
.modal-btn-confirm{background:var(--danger);color:white;font-family:'Sora',sans-serif;}
.modal-btn-confirm:hover{background:#d63851;transform:translateY(-2px);box-shadow:0 5px 18px rgba(255,77,109,.4);}
.modal-btn-confirm:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.progress-bar{height:6px;background:var(--border);border-radius:99px;margin:16px 0;overflow:hidden;display:none;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--danger),#ff8fa3);border-radius:99px;width:0%;transition:width .4s ease;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast-wrap{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;}
.toast{
  min-width:300px;background:white;border-radius:16px;padding:14px 18px;
  box-shadow:0 8px 32px rgba(0,82,255,0.15);display:flex;align-items:center;gap:12px;
  border-left:4px solid;animation:toastIn .35s cubic-bezier(.34,1.56,.64,1);
}
@keyframes toastIn{from{transform:translateX(120%);opacity:0}to{transform:translateX(0);opacity:1}}
.toast.success{border-left-color:var(--success)}.toast.error{border-left-color:var(--danger)}
.toast.info{border-left-color:var(--primary)}.toast.warning{border-left-color:var(--warning)}
.toast-icon{font-size:20px}
.toast-body{flex:1}.toast-title{font-weight:700;font-size:.9rem;color:var(--text);margin-bottom:2px}
.toast-msg{font-size:.8rem;color:var(--muted)}
.toast-x{font-size:1.3rem;color:var(--border);cursor:pointer;transition:.2s}.toast-x:hover{color:var(--muted)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:640px){
  .topbar{padding:0 16px}.page{padding:20px 14px 60px}
  .welcome{padding:22px 20px}.welcome-left h1{font-size:19px}
  .welcome-stats{gap:10px}.wstat{padding:10px 14px}.wstat-val{font-size:20px}
  .stats-grid{grid-template-columns:repeat(2,1fr)}.nav-grid{grid-template-columns:1fr}
  .reset-grid{grid-template-columns:1fr}.modal-buttons{flex-direction:column}
  .toast-wrap{right:12px;left:12px;top:12px}.toast{min-width:auto}
  .brand-name{font-size:16px}.status-bar{gap:12px}
  .status-divider{display:none}
  .topbar-btn span{display:none}
}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loader"></div>
  <div class="loader-text">Loading Dashboard‚Ä¶</div>
</div>

<!-- TOASTS -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- ‚îÄ‚îÄ RESET MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="resetModal">
  <div class="modal-box">
    <span class="modal-emoji" id="resetEmoji">üóëÔ∏è</span>
    <div class="modal-title" id="resetModalTitle">Factory Reset</div>
    <p class="modal-msg" id="resetModalMsg">This will permanently delete all data.</p>
    <div class="modal-warning" id="resetModalWarning">
      ‚ö†Ô∏è This action is <strong>IRREVERSIBLE</strong>. All data will be permanently wiped. There is no undo.
    </div>
    <p class="modal-confirm-label">Type <strong style="color:var(--danger)">RESET</strong> to confirm</p>
    <input type="text" class="modal-confirm-input" id="resetConfirmInput" placeholder="RESET" autocomplete="off"/>
    <div class="progress-bar" id="resetProgress">
      <div class="progress-fill" id="resetProgressFill"></div>
    </div>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-cancel" onclick="closeResetModal()"><i class="fas fa-times"></i> Cancel</button>
      <button class="modal-btn modal-btn-confirm" id="resetConfirmBtn" disabled onclick="executeReset()">
        <i class="fas fa-trash"></i> Reset Now
      </button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ -->
<div class="topbar">
  <div class="topbar-brand">
    <div class="brand-icon">üí∞</div>
    <div>
      <span class="brand-name">Cashpoint</span>
      <span class="brand-badge">ADMIN</span>
    </div>
  </div>
  <div class="topbar-right">
    <div class="admin-pill">
      <div class="admin-av" id="adminAv">A</div>
      <span id="adminEmail">Admin</span>
    </div>
    <button class="topbar-btn logout-btn" onclick="doLogout()">
      <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
    </button>
  </div>
</div>

<!-- ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ -->
<div class="page">

  <!-- Welcome Banner -->
  <div class="welcome">
    <div class="welcome-left">
      <h1>üëã Welcome back, Admin</h1>
      <p>Real-time overview of your Cashpoint platform.</p>
      <div class="live-badge">
        <span class="live-dot"></span> Live Data
      </div>
    </div>
    <div class="welcome-stats">
      <div class="wstat">
        <div class="wstat-val" id="s-users">‚Äî</div>
        <div class="wstat-lbl">Total Users</div>
      </div>
      <div class="wstat">
        <div class="wstat-val" id="s-pending">‚Äî</div>
        <div class="wstat-lbl">Pending Deposits</div>
      </div>
      <div class="wstat">
        <div class="wstat-val" id="s-active">‚Äî</div>
        <div class="wstat-lbl">Active Plans</div>
      </div>
    </div>
  </div>

  <!-- Platform Status Bar -->
  <div class="status-bar">
    <div class="status-item">
      <span class="status-dot green"></span>
      Firebase Auth
    </div>
    <div class="status-divider"></div>
    <div class="status-item">
      <span class="status-dot green"></span>
      Firestore DB
    </div>
    <div class="status-divider"></div>
    <div class="status-item">
      <span class="status-dot green"></span>
      Platform Online
    </div>
    <div class="status-divider"></div>
    <div class="status-item" style="color:var(--muted);font-size:12px;" id="lastRefreshed">
      <i class="fas fa-clock" style="font-size:11px;"></i> ‚Äî
    </div>
    <button class="status-refresh" id="refreshBtn" onclick="refreshStats()">
      <i class="fas fa-sync-alt"></i> Refresh
    </button>
  </div>

  <!-- Quick Stats -->
  <div class="section-title">üìä Overview</div>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon-wrap si-blue">üë•</div>
      <div class="stat-val" id="st-users">‚Äî</div>
      <div class="stat-lbl">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-wrap si-green">üí≥</div>
      <div class="stat-val" id="st-deposits">‚Äî</div>
      <div class="stat-lbl">Total Deposits</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-wrap si-orange">‚è≥</div>
      <div class="stat-val" id="st-pending">‚Äî</div>
      <div class="stat-lbl">Pending Deposits</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-wrap si-red">üí∏</div>
      <div class="stat-val" id="st-withdrawals">‚Äî</div>
      <div class="stat-lbl">Pending Withdrawals</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-wrap si-purple">üìà</div>
      <div class="stat-val" id="st-plans">‚Äî</div>
      <div class="stat-lbl">Active Plans</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-wrap si-teal">üéÅ</div>
      <div class="stat-val" id="st-refs">‚Äî</div>
      <div class="stat-lbl">Referral Bonuses</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-wrap si-indigo">üë§</div>
      <div class="stat-val" id="st-active-users">‚Äî</div>
      <div class="stat-lbl">Active Today</div>
      <div class="stat-trend trend-up" id="activeTrend">‚Üë 0%</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon-wrap si-pink">üí∞</div>
      <div class="stat-val" id="st-total-invested">‚Äî</div>
      <div class="stat-lbl">Total Invested</div>
    </div>
    
    <!-- NEW GIFT SYSTEM STATS -->
    <div class="stat-card">
      <div class="stat-icon-wrap si-gift">üéÅ</div>
      <div class="stat-val" id="st-total-gifts">0</div>
      <div class="stat-lbl">Total Gifts</div>
      <div class="stat-trend trend-up" id="giftTrend">+0 this week</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon-wrap si-gold">üí∞</div>
      <div class="stat-val" id="st-gift-value">‚Ç¶0</div>
      <div class="stat-lbl">Gift Value</div>
      <div class="stat-trend trend-up" id="giftValueTrend">Total bonuses</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon-wrap si-claim">‚úÖ</div>
      <div class="stat-val" id="st-gift-claims">0</div>
      <div class="stat-lbl">Gift Claims</div>
      <div class="stat-trend trend-up" id="claimTrend">Successful claims</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon-wrap si-expiry">‚è∞</div>
      <div class="stat-val" id="st-expiring-soon">0</div>
      <div class="stat-lbl">Expiring Soon</div>
      <div class="stat-trend trend-down" id="expiringTrend">Next 7 days</div>
    </div>
  </div>

  <!-- Manage -->
  <div class="section-title">‚öôÔ∏è Manage</div>
  <div class="nav-grid">
    <!-- USER LIST PAGE -->
    <a class="nav-card" href="admin-users.html">
      <div class="nav-card-icon c-blue">üìã</div>
      <div>
        <div class="nav-card-title">User List</div>
        <div class="nav-card-desc">View all users in a table, search, filter & quick actions</div>
      </div>
      <span class="nav-badge hidden" id="usersBadge">0</span>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- USER DETAIL PAGE -->
    <a class="nav-card" href="admin-user.html">
      <div class="nav-card-icon c-indigo">üë§</div>
      <div>
        <div class="nav-card-title">User Details</div>
        <div class="nav-card-desc">Complete user profile: investments, referrals, withdrawals, ROI logs</div>
      </div>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- DEPOSITS -->
    <a class="nav-card" href="admin-deposits.html">
      <div class="nav-card-icon c-green">üí≥</div>
      <div>
        <div class="nav-card-title">Deposits</div>
        <div class="nav-card-desc">Approve or reject pending deposit requests</div>
      </div>
      <span class="nav-badge hidden" id="depBadge">0</span>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- WITHDRAWALS -->
    <a class="nav-card" href="admin-withdrawals.html">
      <div class="nav-card-icon c-orange">üí∏</div>
      <div>
        <div class="nav-card-title">Withdrawals</div>
        <div class="nav-card-desc">Process pending withdrawal requests</div>
      </div>
      <span class="nav-badge hidden" id="wdlBadge">0</span>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- INVESTMENTS -->
    <a class="nav-card" href="admin-investments.html">
      <div class="nav-card-icon c-purple">üìà</div>
      <div>
        <div class="nav-card-title">Investments</div>
        <div class="nav-card-desc">Monitor all active and completed plans</div>
      </div>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- REFERRALS -->
    <a class="nav-card" href="admin-referrals.html">
      <div class="nav-card-icon c-teal">üéÅ</div>
      <div>
        <div class="nav-card-title">Referrals</div>
        <div class="nav-card-desc">View all referral bonus transactions</div>
      </div>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- GIFT MANAGEMENT - NEW -->
    <a class="nav-card c-gift" href="admin-gifts.html">
      <div class="nav-card-icon" style="color:white;">üéÅ</div>
      <div>
        <div class="nav-card-title" style="color:white;">Gift Management</div>
        <div class="nav-card-desc" style="color:rgba(255,255,255,0.9);">Create & manage gift codes, track claims, expiry dates</div>
      </div>
      <span class="nav-badge" id="giftBadge" style="display:none;">0</span>
      <i class="fas fa-chevron-right nav-card-arrow" style="color:rgba(255,255,255,0.5);"></i>
    </a>
    
    <!-- SUPPORT CHAT -->
    <a class="nav-card" href="admin-support.html">
      <div class="nav-card-icon c-red">üéß</div>
      <div>
        <div class="nav-card-title">Support Chat</div>
        <div class="nav-card-desc">Reply to user support messages in real-time</div>
      </div>
      <span class="nav-badge hidden" id="supportBadge">0</span>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- TRANSACTIONS -->
    <a class="nav-card" href="admin-transactions.html">
      <div class="nav-card-icon c-pink">üìã</div>
      <div>
        <div class="nav-card-title">Transactions</div>
        <div class="nav-card-desc">View all financial transactions</div>
      </div>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- ROI LOGS -->
    <a class="nav-card" href="admin-roi.html">
      <div class="nav-card-icon c-teal">‚è±Ô∏è</div>
      <div>
        <div class="nav-card-title">ROI Logs</div>
        <div class="nav-card-desc">Track daily ROI credit history</div>
      </div>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
    
    <!-- SYSTEM SETTINGS -->
    <a class="nav-card" href="admin-settings.html">
      <div class="nav-card-icon c-orange">‚öôÔ∏è</div>
      <div>
        <div class="nav-card-title">System Settings</div>
        <div class="nav-card-desc">Configure platform settings, withdrawal limits, fees</div>
      </div>
      <i class="fas fa-chevron-right nav-card-arrow"></i>
    </a>
  </div>

  <!-- Danger Zone -->
  <div class="section-title">üî• Danger Zone</div>
  <div class="danger-zone">
    <div class="danger-zone-header">
      <div class="danger-icon-wrap">‚ö†Ô∏è</div>
      <div class="danger-info">
        <h3>Factory Reset</h3>
        <p>Permanently wipe platform data. These actions are irreversible ‚Äî use with extreme caution.</p>
      </div>
    </div>

    <div class="reset-grid">
      <button class="reset-btn" onclick="openResetModal('deposits')">
        <div class="reset-btn-icon"><i class="fas fa-credit-card"></i></div>
        <div class="reset-btn-text">
          <div class="reset-btn-title">Clear Deposits</div>
          <div class="reset-btn-sub">Wipe all deposit records</div>
        </div>
      </button>
      <button class="reset-btn" onclick="openResetModal('withdrawals')">
        <div class="reset-btn-icon"><i class="fas fa-money-bill-wave"></i></div>
        <div class="reset-btn-text">
          <div class="reset-btn-title">Clear Withdrawals</div>
          <div class="reset-btn-sub">Wipe all withdrawal records</div>
        </div>
      </button>
      <button class="reset-btn" onclick="openResetModal('investments')">
        <div class="reset-btn-icon"><i class="fas fa-chart-line"></i></div>
        <div class="reset-btn-text">
          <div class="reset-btn-title">Clear Investments</div>
          <div class="reset-btn-sub">Remove all active plans</div>
        </div>
      </button>
      <button class="reset-btn" onclick="openResetModal('referral_bonuses')">
        <div class="reset-btn-icon"><i class="fas fa-gift"></i></div>
        <div class="reset-btn-text">
          <div class="reset-btn-title">Clear Referrals</div>
          <div class="reset-btn-sub">Delete all referral bonus logs</div>
        </div>
      </button>
      <button class="reset-btn" onclick="openResetModal('users')">
        <div class="reset-btn-icon"><i class="fas fa-users-slash"></i></div>
        <div class="reset-btn-text">
          <div class="reset-btn-title">Clear Users</div>
          <div class="reset-btn-sub">Delete all user accounts</div>
        </div>
      </button>
      <button class="reset-btn" onclick="openResetModal('support_messages')">
        <div class="reset-btn-icon"><i class="fas fa-comments-slash"></i></div>
        <div class="reset-btn-text">
          <div class="reset-btn-title">Clear Support</div>
          <div class="reset-btn-sub">Delete all support messages</div>
        </div>
      </button>
    </div>

    <button class="full-reset-btn" onclick="openResetModal('ALL')">
      <i class="fas fa-bomb"></i> Full Factory Reset ‚Äî Wipe Everything
    </button>

    <div class="danger-note">
      <i class="fas fa-shield-alt" style="margin-top:1px;flex-shrink:0;"></i>
      You must type <strong>RESET</strong> in the confirmation dialog to proceed. All deletions are permanent and cannot be recovered from Firestore.
    </div>
  </div>

</div><!-- end .page -->

<script>
/* ‚îÄ‚îÄ Firebase Init ‚îÄ‚îÄ */
const firebaseConfig = {
  apiKey:            "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
  authDomain:        "cashpoint-ac4f4.firebaseapp.com",
  projectId:         "cashpoint-ac4f4",
  storageBucket:     "cashpoint-ac4f4.firebasestorage.app",
  messagingSenderId: "16133206416",
  appId:             "1:16133206416:web:a093f4e153ad2c9bcc8315"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
auth.onAuthStateChanged(user => {
  if (!user) { window.location.href = 'admin-login.html'; return; }
  
  // Check if user is admin
  db.collection('users').doc(user.uid).get().then(doc => {
    if (!doc.exists || !doc.data().isAdmin) {
      auth.signOut();
      window.location.href = 'login.html';
      return;
    }
    
    const email = user.email || 'Admin';
    document.getElementById('adminEmail').textContent = email.split('@')[0];
    document.getElementById('adminAv').textContent    = email.charAt(0).toUpperCase();
    loadStats();
    setTimeout(() => document.getElementById('loadingOverlay').classList.add('hidden'), 700);
  });
});

/* ‚îÄ‚îÄ Load Stats ‚îÄ‚îÄ */
async function loadStats() {
  try {
    const [users, deposits, withdrawals, plans, refs, threads] = await Promise.all([
      db.collection('users').get(),
      db.collection('deposits').get(),
      db.collection('withdrawals').get(),
      db.collection('investments').where('status','==','active').get(),
      db.collection('referral_bonuses').get(),
      db.collection('support_threads').get()
    ]);

    const pendingDep  = deposits.docs.filter(d => d.data().status === 'pending').length;
    const pendingWdl  = withdrawals.docs.filter(d => d.data().status === 'pending').length;
    const unreadSupport = threads.docs.filter(d => (d.data().unreadByAdmin || 0) > 0).length;
    
    // Calculate total invested amount
    const allInvestments = await db.collection('investments').get();
    const totalInvested = allInvestments.docs.reduce((sum, doc) => {
      return sum + (doc.data().amount || doc.data().capital || 0);
    }, 0);
    
    // Calculate active users today
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const activeToday = users.docs.filter(doc => {
      const lastLogin = doc.data().lastLogin?.toDate?.();
      return lastLogin && lastLogin >= today;
    }).length;

    /* Welcome stats */
    document.getElementById('s-users').textContent   = users.size;
    document.getElementById('s-pending').textContent = pendingDep;
    document.getElementById('s-active').textContent  = plans.size;

    /* Grid stats */
    document.getElementById('st-users').textContent       = users.size;
    document.getElementById('st-deposits').textContent    = deposits.size;
    document.getElementById('st-pending').textContent     = pendingDep;
    document.getElementById('st-withdrawals').textContent = pendingWdl;
    document.getElementById('st-plans').textContent       = plans.size;
    document.getElementById('st-refs').textContent        = refs.size;
    document.getElementById('st-active-users').textContent = activeToday;
    document.getElementById('st-total-invested').textContent = '‚Ç¶' + (totalInvested / 1000000).toFixed(1) + 'M';
    
    // Calculate trend percentage
    const activeTrend = users.size > 0 ? Math.round((activeToday / users.size) * 100) : 0;
    document.getElementById('activeTrend').innerHTML = `‚Üë ${activeTrend}%`;

    /* Load Gift Stats */
    await loadGiftStats();

    /* Nav badges */
    setBadge('usersBadge', users.size);
    setBadge('depBadge', pendingDep);
    setBadge('wdlBadge', pendingWdl);
    setBadge('supportBadge', unreadSupport);

    /* Last refreshed */
    const now = new Date();
    document.getElementById('lastRefreshed').innerHTML =
      `<i class="fas fa-clock" style="font-size:11px;"></i> Updated ${now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`;

  } catch(e) {
    console.error('Stats error:', e);
    showToast('error','Load Error','Could not load statistics ‚Äî check Firestore rules.');
  }
}

/* ‚îÄ‚îÄ Load Gift Stats ‚îÄ‚îÄ */
async function loadGiftStats() {
  try {
    // Get all gifts
    const giftsSnap = await db.collection('gifts').get();
    const gifts = giftsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Get all gift claims
    const claimsSnap = await db.collection('gift_claims').get();
    const claims = claimsSnap.docs.map(doc => doc.data());
    
    // Total gifts
    document.getElementById('st-total-gifts').textContent = gifts.length;
    
    // Total gift value
    const totalValue = gifts.reduce((sum, gift) => sum + (gift.amount || 0), 0);
    document.getElementById('st-gift-value').textContent = '‚Ç¶' + totalValue.toLocaleString();
    
    // Total claims
    document.getElementById('st-gift-claims').textContent = claims.length;
    
    // Calculate gifts expiring soon (next 7 days)
    const now = new Date();
    const nextWeek = new Date();
    nextWeek.setDate(now.getDate() + 7);
    
    const expiringSoon = gifts.filter(gift => {
      const expiry = gift.expiresAt?.toDate?.();
      return expiry && expiry > now && expiry < nextWeek && gift.isActive !== false;
    }).length;
    
    document.getElementById('st-expiring-soon').textContent = expiringSoon;
    
    // Calculate trends
    const lastWeek = new Date();
    lastWeek.setDate(lastWeek.getDate() - 7);
    
    const giftsThisWeek = gifts.filter(gift => {
      const created = gift.createdAt?.toDate?.();
      return created && created > lastWeek;
    }).length;
    
    document.getElementById('giftTrend').innerHTML = `+${giftsThisWeek} this week`;
    
    const claimsThisWeek = claims.filter(claim => {
      const claimed = claim.claimedAt?.toDate?.();
      return claimed && claimed > lastWeek;
    }).length;
    
    document.getElementById('claimTrend').innerHTML = `+${claimsThisWeek} this week`;
    document.getElementById('giftValueTrend').innerHTML = `Total bonuses`;
    
    // Check for expiring soon badge
    if (expiringSoon > 0) {
      const giftBadge = document.getElementById('giftBadge');
      giftBadge.textContent = expiringSoon > 9 ? '9+' : expiringSoon;
      giftBadge.style.display = 'block';
    }
    
  } catch (error) {
    console.error('Error loading gift stats:', error);
  }
}

function setBadge(id, count) {
  const el = document.getElementById(id);
  if (!el) return;
  if (count > 0) { 
    el.textContent = count > 99 ? '99+' : count; 
    el.classList.remove('hidden'); 
  }
  else el.classList.add('hidden');
}

async function refreshStats() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  btn.disabled = true;
  await loadStats();
  setTimeout(() => { btn.classList.remove('spinning'); btn.disabled = false; }, 600);
}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
function showToast(type, title, msg) {
  const wrap  = document.getElementById('toastWrap');
  const el    = document.createElement('div');
  const icons = { success:'‚úÖ', error:'‚ùå', info:'‚ÑπÔ∏è', warning:'‚ö†Ô∏è' };
  el.className = `toast ${type}`;
  el.innerHTML = `
    <span class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</span>
    <div class="toast-body">
      <div class="toast-title">${title}</div>
      <div class="toast-msg">${msg}</div>
    </div>
    <span class="toast-x" onclick="this.parentElement.remove()">√ó</span>`;
  wrap.appendChild(el);
  setTimeout(()=>{
    el.style.opacity='0';el.style.transform='translateX(120%)';el.style.transition='.4s';
    setTimeout(()=>el.remove(),400);
  },5000);
}

/* ‚îÄ‚îÄ Logout ‚îÄ‚îÄ */
function doLogout() {
  auth.signOut().then(() => window.location.href = 'admin-login.html');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FACTORY RESET
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let resetTarget = null;

const RESET_COLLECTIONS = [
  'deposits','withdrawals','investments',
  'referral_bonuses','referral_credits','users',
  'support_messages','support_threads','transactions','roi_logs',
  'gifts','gift_claims' // Added gift collections
];

const RESET_META = {
  deposits:         { emoji:'üí≥', label:'All Deposits',         sub:'All deposit records will be permanently deleted.' },
  withdrawals:      { emoji:'üí∏', label:'All Withdrawals',      sub:'All withdrawal records will be permanently deleted.' },
  investments:      { emoji:'üìà', label:'All Investments',      sub:'All active and past investment plans will be deleted.' },
  referral_bonuses: { emoji:'üéÅ', label:'All Referral Bonuses', sub:'All referral bonus audit logs will be deleted.' },
  users:            { emoji:'üë•', label:'All Users',            sub:'Every user account doc in Firestore will be deleted. Auth accounts are NOT deleted ‚Äî do that manually in Firebase Console.' },
  support_messages: { emoji:'üí¨', label:'All Support Messages', sub:'All chat messages and support threads will be permanently deleted.' },
  gifts:            { emoji:'üéÅ', label:'All Gifts',            sub:'All gift codes and records will be permanently deleted.' },
  gift_claims:      { emoji:'‚úÖ', label:'All Gift Claims',      sub:'All gift claim records will be permanently deleted.' },
  ALL:              { emoji:'üí•', label:'ENTIRE PLATFORM',      sub:'Every record across ALL collections will be wiped. This cannot be undone.' },
};

function openResetModal(target) {
  resetTarget = target;
  const meta   = RESET_META[target] || { emoji:'üóëÔ∏è', label:target, sub:'This data will be permanently deleted.' };
  const isFull = target === 'ALL';

  document.getElementById('resetEmoji').textContent       = meta.emoji;
  document.getElementById('resetModalTitle').textContent  = isFull ? 'üí• Full Factory Reset' : `üóëÔ∏è Clear ${meta.label}`;
  document.getElementById('resetModalMsg').textContent    = meta.sub;
  document.getElementById('resetModalWarning').innerHTML  = isFull
    ? 'üí• <strong>FULL FACTORY RESET:</strong> Every single record across deposits, withdrawals, investments, referrals, users, support messages, transactions, gifts, and gift claims will be permanently destroyed. <strong>This cannot be undone.</strong>'
    : `‚ö†Ô∏è You are about to permanently delete <strong>${meta.label.toUpperCase()}</strong>. This is <strong>IRREVERSIBLE</strong> ‚Äî there is no way to recover this data.`;

  document.getElementById('resetConfirmInput').value      = '';
  document.getElementById('resetConfirmInput').classList.remove('valid');
  document.getElementById('resetConfirmBtn').disabled    = true;
  document.getElementById('resetProgress').style.display = 'none';
  document.getElementById('resetProgressFill').style.width = '0%';
  document.getElementById('resetConfirmBtn').innerHTML   = '<i class="fas fa-trash"></i> Reset Now';
  document.getElementById('resetModal').classList.add('active');

  setTimeout(() => document.getElementById('resetConfirmInput').focus(), 350);
}

function closeResetModal() {
  document.getElementById('resetModal').classList.remove('active');
  resetTarget = null;
}

document.getElementById('resetConfirmInput').addEventListener('input', function() {
  const valid = this.value.trim().toUpperCase() === 'RESET';
  this.classList.toggle('valid', valid);
  document.getElementById('resetConfirmBtn').disabled = !valid;
});

async function executeReset() {
  if (!resetTarget) return;

  const btn          = document.getElementById('resetConfirmBtn');
  const progressBar  = document.getElementById('resetProgress');
  const progressFill = document.getElementById('resetProgressFill');

  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting‚Ä¶';
  progressBar.style.display = 'block';

  const collections = resetTarget === 'ALL' ? RESET_COLLECTIONS : [resetTarget];
  const total       = collections.length;

  try {
    for (let i = 0; i < collections.length; i++) {
      const colName = collections[i];
      progressFill.style.width = `${(i / total) * 100}%`;
      await deleteCollection(colName);
      progressFill.style.width = `${((i + 1) / total) * 100}%`;
    }

    progressFill.style.width = '100%';

    setTimeout(() => {
      closeResetModal();
      const meta  = RESET_META[resetTarget] || { label: resetTarget };
      showToast('success', '‚úÖ Reset Complete', `${meta.label} has been permanently wiped.`);
      loadStats();
    }, 700);

  } catch(e) {
    console.error('Reset error:', e);
    showToast('error', 'Reset Failed', e.message || 'An error occurred during reset.');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-trash"></i> Reset Now';
  }
}

async function deleteCollection(colName) {
  let hasMore = true;
  let total   = 0;
  while (hasMore) {
    const snap = await db.collection(colName).limit(400).get();
    if (snap.empty) { hasMore = false; break; }
    const batch = db.batch();
    snap.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    total += snap.size;
    if (snap.size < 400) hasMore = false;
  }
  return total;
}

/* Close modal on backdrop click */
document.getElementById('resetModal').addEventListener('click', function(e) {
  if (e.target === this) closeResetModal();
});

/* ‚îÄ‚îÄ Preload links ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', () => {
  console.log('Admin Dashboard Ready');
});
</script>
</body>
</html>

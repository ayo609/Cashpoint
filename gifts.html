<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"/>
<title>Cashpoint | Gift Center üéÅ</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<!-- SweetAlert2 for beautiful modals -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #0052FF;
  --primary-dark: #0039b3;
  --accent: #00D4A0;
  --accent-dark: #00a87e;
  --warning: #FFB800;
  --danger: #FF4D6D;
  --success: #00C48C;
  --bg: #F0F4FF;
  --card: #ffffff;
  --text: #0D1B3E;
  --muted: #6B7A99;
  --border: #D8E0F0;
  --nav-h: 70px;
  --bottom-h: 72px;
  --gift-gradient: linear-gradient(135deg, #FF6B6B, #FF8E53);
  --gold-gradient: linear-gradient(135deg, #FFD700, #FFA500);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  padding-bottom: calc(var(--bottom-h) + 20px);
  overflow-x: hidden;
  min-height: 100vh;
}

/* ========== TOP BAR ========== */
.topbar {
  position: sticky; top: 0; z-index: 900;
  height: var(--nav-h);
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  justify-content: space-between;
  padding: 0 20px; gap: 12px;
}
.topbar-left { display: flex; align-items: center; gap: 10px; }
.topbar-logo {
  width: 38px; height: 38px; background: var(--primary);
  border-radius: 11px; display: flex; align-items: center;
  justify-content: center; font-size: 20px; flex-shrink: 0;
}
.topbar-brand {
  font-family: 'Sora', sans-serif; font-size: 20px;
  font-weight: 700; color: var(--text); letter-spacing: -0.3px;
}
.topbar-right { display: flex; align-items: center; gap: 10px; }
.topbar-clock { font-size: 12.5px; color: var(--muted); font-weight: 600; display: none; }
@media(min-width:520px){ .topbar-clock { display: block; } }
.user-avatar {
  width: 38px; height: 38px; border-radius: 11px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex; align-items: center; justify-content: center;
  color: white; font-weight: 800; font-size: 15px; cursor: pointer;
}
.back-btn {
  width: 38px; height: 38px;
  border-radius: 11px;
  background: var(--bg);
  border: 1.5px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: var(--muted);
  text-decoration: none;
  transition: all 0.2s;
}
.back-btn:hover {
  background: var(--border);
}

/* ========== HERO SECTION ========== */
.hero {
  background: var(--gift-gradient);
  padding: 30px 22px 80px;
  position: relative;
  overflow: hidden;
}
.hero::before {
  content: '';
  position: absolute;
  width: 400px; height: 400px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  top: -150px; right: -100px;
}
.hero::after {
  content: '';
  position: absolute;
  width: 250px; height: 250px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  bottom: -80px; left: -50px;
}
.hero-content {
  position: relative;
  z-index: 2;
  max-width: 1200px;
  margin: 0 auto;
}
.hero-tag {
  font-size: 12px;
  font-weight: 700;
  color: rgba(255,255,255,0.8);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
}
.hero-title {
  font-family: 'Sora', sans-serif;
  font-size: clamp(28px, 6vw, 42px);
  font-weight: 800;
  color: white;
  line-height: 1.2;
  margin-bottom: 12px;
}
.hero-desc {
  font-size: 16px;
  color: rgba(255,255,255,0.9);
  line-height: 1.6;
  max-width: 600px;
}

/* ========== BALANCE CARD ========== */
.balance-card {
  background: white;
  border-radius: 22px;
  padding: 20px 24px;
  margin: -50px 20px 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  border: 1px solid var(--border);
  position: relative;
  z-index: 10;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
}
.balance-info {}
.balance-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 700;
  text-transform: uppercase;
  margin-bottom: 6px;
}
.balance-amount {
  font-family: 'Sora', sans-serif;
  font-size: 32px;
  font-weight: 800;
  color: var(--primary);
}
.balance-note {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}
.balance-actions {
  display: flex;
  gap: 12px;
}

/* ========== GIFT ENTRY SECTION ========== */
.gift-section {
  padding: 20px;
  max-width: 800px;
  margin: 0 auto;
}
.gift-card {
  background: white;
  border-radius: 24px;
  padding: 40px 32px;
  box-shadow: 0 15px 50px rgba(255, 107, 107, 0.15);
  border: 2px solid transparent;
  background: linear-gradient(white, white) padding-box,
              var(--gift-gradient) border-box;
  animation: float 3s ease-in-out infinite;
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}
.gift-header {
  text-align: center;
  margin-bottom: 30px;
}
.gift-icon {
  font-size: 64px;
  margin-bottom: 16px;
  animation: bounce 2s infinite;
}
@keyframes bounce {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
.gift-header h2 {
  font-family: 'Sora', sans-serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 8px;
}
.gift-header p {
  color: var(--muted);
  font-size: 15px;
}
.gift-input-group {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}
.gift-input {
  flex: 1;
  padding: 18px 20px;
  border: 2px solid var(--border);
  border-radius: 16px;
  font-size: 18px;
  font-weight: 600;
  font-family: inherit;
  text-transform: uppercase;
  letter-spacing: 2px;
  text-align: center;
  transition: all 0.3s;
}
.gift-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 4px rgba(0,212,160,0.1);
}
.gift-input::placeholder {
  text-transform: none;
  letter-spacing: normal;
  color: var(--border);
  font-weight: 400;
}
.gift-btn {
  padding: 18px 36px;
  border: none;
  border-radius: 16px;
  background: var(--gift-gradient);
  color: white;
  font-size: 16px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  transition: all 0.3s;
  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
}
.gift-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
}
.gift-btn:active {
  transform: translateY(0);
}
.gift-btn i {
  font-size: 18px;
}

/* ========== AVAILABLE GIFTS SECTION ========== */
.gifts-available {
  padding: 40px 20px;
  max-width: 1200px;
  margin: 0 auto;
}
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}
.section-header h3 {
  font-family: 'Sora', sans-serif;
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}
.see-all {
  color: var(--primary);
  font-weight: 600;
  text-decoration: none;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.gifts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 16px;
}
.gift-preview-card {
  background: white;
  border-radius: 16px;
  padding: 20px 16px;
  text-align: center;
  border: 2px solid var(--border);
  transition: all 0.3s;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.gift-preview-card:hover {
  transform: translateY(-5px);
  border-color: var(--accent);
  box-shadow: 0 10px 30px rgba(0,212,160,0.15);
}
.gift-preview-card.limited {
  border-color: var(--warning);
}
.gift-preview-icon {
  font-size: 32px;
  margin-bottom: 10px;
}
.gift-preview-amount {
  font-family: 'Sora', sans-serif;
  font-size: 24px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 5px;
}
.gift-preview-code {
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  background: var(--bg);
  padding: 4px 8px;
  border-radius: 99px;
  display: inline-block;
  margin-bottom: 8px;
}
.gift-preview-uses {
  font-size: 11px;
  color: var(--muted);
}
.gift-preview-uses span {
  font-weight: 700;
  color: var(--success);
}
.gift-preview-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--warning);
  color: var(--text);
  font-size: 10px;
  font-weight: 800;
  padding: 3px 8px;
  border-radius: 99px;
}

/* ========== CLAIM HISTORY ========== */
.history-section {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}
.history-list {
  background: white;
  border-radius: 20px;
  padding: 20px;
}
.history-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 0;
  border-bottom: 1px solid var(--border);
}
.history-item:last-child {
  border-bottom: none;
}
.history-left {
  display: flex;
  align-items: center;
  gap: 15px;
}
.history-icon {
  width: 40px;
  height: 40px;
  background: var(--bg);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: var(--success);
}
.history-info h4 {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 3px;
}
.history-info p {
  font-size: 12px;
  color: var(--muted);
}
.history-amount {
  font-family: 'Sora', sans-serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--success);
}
.empty-history {
  text-align: center;
  padding: 30px;
  color: var(--muted);
}
.empty-history i {
  font-size: 48px;
  margin-bottom: 10px;
  opacity: 0.5;
}

/* ========== BOTTOM NAV ========== */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: var(--bottom-h);
  background: white;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0 10px;
  z-index: 800;
  box-shadow: 0 -4px 20px rgba(0, 82, 255, 0.06);
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  color: var(--muted);
  text-decoration: none;
  font-size: 11px;
  font-weight: 700;
  transition: all 0.2s;
  padding: 8px 12px;
  border-radius: 12px;
  min-width: 60px;
}
.nav-item i {
  font-size: 20px;
}
.nav-item.active {
  color: var(--accent);
}
.nav-center {
  width: 56px;
  height: 56px;
  background: var(--gift-gradient);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
  text-decoration: none;
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
  margin-bottom: 10px;
  animation: pulse-gift 2s infinite;
}
@keyframes pulse-gift {
  0%, 100% { box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3); }
  50% { box-shadow: 0 10px 30px rgba(255, 107, 107, 0.5); }
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .gift-input-group {
    flex-direction: column;
  }
  .gift-btn {
    width: 100%;
    justify-content: center;
  }
  .balance-card {
    flex-direction: column;
    align-items: flex-start;
  }
  .gift-card {
    padding: 30px 20px;
  }
  .gift-header h2 {
    font-size: 24px;
  }
}
@media (max-width: 480px) {
  .gifts-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .history-left {
    gap: 10px;
  }
  .history-icon {
    width: 35px;
    height: 35px;
  }
  .history-info h4 {
    font-size: 13px;
  }
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <a href="home.html" class="back-btn">
      <i class="fas fa-arrow-left"></i>
    </a>
    <div class="topbar-logo">üéÅ</div>
    <span class="topbar-brand">Gift Center</span>
  </div>
  <div class="topbar-right">
    <span class="topbar-clock" id="topClock">--:--</span>
    <div class="user-avatar" id="avatarBox">?</div>
  </div>
</div>

<!-- HERO SECTION -->
<div class="hero">
  <div class="hero-content">
    <div class="hero-tag">üéâ Special Gifts & Bonuses</div>
    <div class="hero-title">Claim Your Free Cash Bonus!</div>
    <div class="hero-desc">
      Enter a gift code below and get instant cash added to your wallet. 
      Hurry! Each code can only be used by a limited number of people.
    </div>
  </div>
</div>

<!-- BALANCE CARD -->
<div class="balance-card">
  <div class="balance-info">
    <div class="balance-label">üí∞ Your Wallet Balance</div>
    <div class="balance-amount" id="balanceDisplay">‚Ç¶0.00</div>
    <div class="balance-note">Gift bonuses are added instantly</div>
  </div>
  <div class="balance-actions">
    <a href="deposit.html" class="nav-btn btn-login" style="padding:12px 20px;">
      <i class="fas fa-plus"></i> Deposit
    </a>
  </div>
</div>

<!-- GIFT ENTRY SECTION -->
<div class="gift-section">
  <div class="gift-card">
    <div class="gift-header">
      <div class="gift-icon">üéÅ</div>
      <h2>Have a Gift Code?</h2>
      <p>Enter it below to claim your bonus instantly!</p>
    </div>
    <div class="gift-input-group">
      <input type="text" class="gift-input" id="giftCodeInput" placeholder="ENTER CODE" autocomplete="off">
      <button class="gift-btn" onclick="checkGiftCode()">
        <i class="fas fa-gift"></i>
        Claim Gift
      </button>
    </div>
    <div style="text-align:center; color:var(--muted); font-size:13px;">
      <i class="fas fa-info-circle"></i> Codes are case-sensitive and limited in usage
    </div>
  </div>
</div>

<!-- AVAILABLE GIFTS PREVIEW -->
<div class="gifts-available">
  <div class="section-header">
    <h3><i class="fas fa-fire" style="color:var(--warning);"></i> Hot Gifts Available</h3>
    <a href="#" class="see-all" onclick="showAllGifts()">
      See All <i class="fas fa-arrow-right"></i>
    </a>
  </div>
  <div class="gifts-grid" id="giftsGrid">
    <!-- Gifts will be loaded here -->
  </div>
</div>

<!-- CLAIM HISTORY -->
<div class="history-section">
  <div class="section-header">
    <h3><i class="fas fa-history"></i> Your Claim History</h3>
  </div>
  <div class="history-list" id="historyList">
    <div class="empty-history">
      <i class="fas fa-gift"></i>
      <p>No gifts claimed yet. Enter a code above!</p>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <a href="home.html" class="nav-item">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </a>
  <a href="plans.html" class="nav-item">
    <i class="fas fa-chart-line"></i>
    <span>Plans</span>
  </a>
  <a href="gifts.html" class="nav-center">
    <i class="fas fa-gift"></i>
  </a>
  <a href="investments.html" class="nav-item">
    <i class="fas fa-wallet"></i>
    <span>Investments</span>
  </a>
  <a href="dashboard.html" class="nav-item">
    <i class="fas fa-user-circle"></i>
    <span>Profile</span>
  </a>
</div>

<script>
// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
  authDomain: "cashpoint-ac4f4.firebaseapp.com",
  projectId: "cashpoint-ac4f4",
  storageBucket: "cashpoint-ac4f4.firebasestorage.app",
  messagingSenderId: "16133206416",
  appId: "1:16133206416:web:a093f4e153ad2c9bcc8315"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const FieldValue = firebase.firestore.FieldValue;

// ========== GLOBAL VARIABLES ==========
let currentUser = null;
let userBalance = 0;

// ========== CLOCK ==========
function updateClock() {
  const now = new Date();
  document.getElementById('topClock').textContent = 
    now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
updateClock();
setInterval(updateClock, 1000);

// ========== FORMAT MONEY ==========
function formatMoney(amount) {
  return '‚Ç¶' + Number(amount || 0).toLocaleString('en-NG', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

// ========== AUTH CHECK ==========
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }
  currentUser = user;
  await loadUserData();
  loadAvailableGifts();
  loadClaimHistory();
});

// ========== LOAD USER DATA ==========
async function loadUserData() {
  try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if (userDoc.exists) {
      const data = userDoc.data();
      userBalance = data.balance || 0;
      
      const firstName = (data.fullName || data.username || 'U').split(' ')[0];
      document.getElementById('avatarBox').textContent = firstName.charAt(0).toUpperCase();
      document.getElementById('balanceDisplay').textContent = formatMoney(userBalance);
    }
  } catch (error) {
    console.error('Error loading user:', error);
  }
}

// ========== LOAD AVAILABLE GIFTS (robust, client‚Äëside sorting) ==========
async function loadAvailableGifts() {
  try {
    const giftsSnap = await db.collection('gifts')
      .where('isActive', '==', true)
      .get();

    const now = new Date();
    let gifts = [];

    giftsSnap.forEach(doc => {
      const gift = doc.data();
      const expiresAt = gift.expiresAt?.toDate();
      if (expiresAt && expiresAt > now) {
        const remaining = gift.totalUses - (gift.usedCount || 0);
        if (remaining > 0) {
          gifts.push({
            id: doc.id,
            ...gift,
            expiresAt,
            remaining
          });
        }
      }
    });

    // Sort newest first
    gifts.sort((a, b) => {
      const aTime = a.createdAt?.toMillis?.() || 0;
      const bTime = b.createdAt?.toMillis?.() || 0;
      return bTime - aTime;
    });

    const previewGifts = gifts.slice(0, 6);
    const grid = document.getElementById('giftsGrid');
    grid.innerHTML = '';

    if (previewGifts.length === 0) {
      grid.innerHTML = '<p style="text-align:center; color:var(--muted); grid-column:span 4;">No gifts available at the moment</p>';
      return;
    }

    previewGifts.forEach(gift => {
      const isLimited = gift.remaining < 10;
      const card = document.createElement('div');
      card.className = `gift-preview-card ${isLimited ? 'limited' : ''}`;
      card.onclick = () => document.getElementById('giftCodeInput').value = gift.code;

      card.innerHTML = `
        <div class="gift-preview-icon">üéÅ</div>
        <div class="gift-preview-amount">‚Ç¶${gift.amount}</div>
        <div class="gift-preview-code">${gift.code}</div>
        <div class="gift-preview-uses">
          <span>${gift.remaining}</span> / ${gift.totalUses} left
        </div>
        ${isLimited ? '<div class="gift-preview-badge">üî• Limited</div>' : ''}
      `;

      grid.appendChild(card);
    });
  } catch (error) {
    console.error('Error loading gifts:', error);
    document.getElementById('giftsGrid').innerHTML = '<p style="text-align:center; color:var(--muted);">Unable to load gifts. Please refresh.</p>';
  }
}

// ========== LOAD CLAIM HISTORY (client‚Äëside sorting) ==========
async function loadClaimHistory() {
  try {
    const claimsSnap = await db.collection('gift_claims')
      .where('userId', '==', currentUser.uid)
      .get();

    let claims = [];
    claimsSnap.forEach(doc => claims.push({ id: doc.id, ...doc.data() }));

    claims.sort((a, b) => {
      const aTime = a.claimedAt?.toMillis?.() || 0;
      const bTime = b.claimedAt?.toMillis?.() || 0;
      return bTime - aTime;
    });

    claims = claims.slice(0, 10);
    const historyList = document.getElementById('historyList');

    if (claims.length === 0) {
      historyList.innerHTML = `
        <div class="empty-history">
          <i class="fas fa-gift"></i>
          <p>No gifts claimed yet. Enter a code above!</p>
        </div>
      `;
      return;
    }

    let html = '';
    claims.forEach(claim => {
      const date = claim.claimedAt?.toDate() || new Date();
      const dateStr = date.toLocaleDateString('en-NG', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });

      html += `
        <div class="history-item">
          <div class="history-left">
            <div class="history-icon"><i class="fas fa-gift"></i></div>
            <div class="history-info">
              <h4>${claim.giftCode}</h4>
              <p>Claimed on ${dateStr}</p>
            </div>
          </div>
          <div class="history-amount">+${formatMoney(claim.amount)}</div>
        </div>
      `;
    });

    historyList.innerHTML = html;
  } catch (error) {
    console.error('Error loading claim history:', error);
    document.getElementById('historyList').innerHTML = `
      <div class="empty-history">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Unable to load history. Please refresh.</p>
      </div>
    `;
  }
}

// ========== CHECK GIFT CODE ==========
async function checkGiftCode() {
  const codeInput = document.getElementById('giftCodeInput');
  const code = codeInput.value.trim().toUpperCase();
  
  if (!code) {
    Swal.fire({
      icon: 'warning',
      title: 'Enter a Code',
      text: 'Please enter a gift code to claim!',
      confirmButtonColor: '#FFB800'
    });
    return;
  }
  
  Swal.fire({
    title: 'Checking Code...',
    html: 'Please wait while we verify your gift code',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });
  
  try {
    const giftSnap = await db.collection('gifts')
      .where('code', '==', code)
      .where('isActive', '==', true)
      .get();
    
    if (giftSnap.empty) {
      Swal.fire({
        icon: 'error',
        title: 'Invalid Code',
        text: 'The gift code you entered is invalid or has expired.',
        confirmButtonColor: '#FF4D6D'
      });
      return;
    }
    
    const giftDoc = giftSnap.docs[0];
    const gift = giftDoc.data();
    const giftId = giftDoc.id;
    
    if (gift.expiresAt && gift.expiresAt.toDate() < new Date()) {
      Swal.fire({
        icon: 'error',
        title: 'Code Expired',
        text: 'This gift code has expired.',
        confirmButtonColor: '#FF4D6D'
      });
      return;
    }
    
    const remaining = gift.totalUses - (gift.usedCount || 0);
    if (remaining <= 0) {
      Swal.fire({
        icon: 'error',
        title: 'Fully Claimed',
        text: 'Sorry! This gift code has already been claimed by the maximum number of users.',
        confirmButtonColor: '#FF4D6D'
      });
      return;
    }
    
    const existingClaim = await db.collection('gift_claims')
      .where('userId', '==', currentUser.uid)
      .where('giftCode', '==', code)
      .get();
    
    if (!existingClaim.empty) {
      Swal.fire({
        icon: 'warning',
        title: 'Already Claimed',
        text: 'You have already claimed this gift code!',
        confirmButtonColor: '#FFB800'
      });
      return;
    }
    
    const result = await Swal.fire({
      icon: 'success',
      title: 'üéâ Gift Code Valid!',
      html: `
        <div style="text-align:center;">
          <div style="font-size:48px; margin-bottom:10px;">üéÅ</div>
          <div style="font-size:20px; font-weight:700; margin-bottom:5px;">You won:</div>
          <div style="font-size:42px; font-weight:800; color:var(--success); margin-bottom:15px;">
            ${formatMoney(gift.amount)}
          </div>
          <div style="font-size:14px; color:var(--muted); margin-bottom:10px;">
            Code: <strong style="color:var(--text);">${gift.code}</strong>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '‚úÖ Claim Now',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#00C48C',
      cancelButtonColor: '#6B7A99'
    });
    
    if (result.isConfirmed) {
      await claimGift(giftId, gift, code);
    }
    
  } catch (error) {
    console.error('Error checking gift:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Something went wrong. Please try again.',
      confirmButtonColor: '#FF4D6D'
    });
  } finally {
    // Keep input empty ‚Äì user can type again if needed
    document.getElementById('giftCodeInput').value = '';
  }
}

// ========== CLAIM GIFT (transaction + safe refresh) ==========
async function claimGift(giftId, gift, code) {
  Swal.fire({
    title: 'Processing...',
    text: 'Adding bonus to your wallet',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });
  
  try {
    await db.runTransaction(async (transaction) => {
      const giftRef = db.collection('gifts').doc(giftId);
      const giftDoc = await transaction.get(giftRef);
      if (!giftDoc.exists) throw new Error('Gift not found');
      
      const giftData = giftDoc.data();
      const currentUsed = giftData.usedCount || 0;
      
      if (currentUsed >= giftData.totalUses) {
        throw new Error('Gift code fully claimed');
      }
      
      transaction.update(giftRef, {
        usedCount: currentUsed + 1,
        updatedAt: FieldValue.serverTimestamp()
      });
      
      const userRef = db.collection('users').doc(currentUser.uid);
      transaction.update(userRef, {
        balance: FieldValue.increment(gift.amount),
        totalEarnings: FieldValue.increment(gift.amount)
      });
      
      const claimRef = db.collection('gift_claims').doc();
      transaction.set(claimRef, {
        userId: currentUser.uid,
        giftId: giftId,
        giftCode: code,
        amount: gift.amount,
        claimedAt: FieldValue.serverTimestamp()
      });
      
      const txRef = db.collection('transactions').doc();
      transaction.set(txRef, {
        userId: currentUser.uid,
        type: 'gift_bonus',
        amount: gift.amount,
        note: `Gift bonus: ${code}`,
        createdAt: FieldValue.serverTimestamp()
      });
    });
    
    userBalance += gift.amount;
    document.getElementById('balanceDisplay').textContent = formatMoney(userBalance);
    
    await Swal.fire({
      icon: 'success',
      title: 'üéâ Bonus Claimed!',
      html: `
        <div style="text-align:center;">
          <div style="font-size:48px; margin-bottom:10px;">üí∞</div>
          <div style="font-size:18px; font-weight:700; margin-bottom:5px;">
            ${formatMoney(gift.amount)} has been added to your wallet!
          </div>
          <div style="font-size:14px; color:var(--muted);">
            New balance: <strong>${formatMoney(userBalance)}</strong>
          </div>
        </div>
      `,
      confirmButtonColor: '#00C48C'
    });
    
    // Refresh lists ‚Äì both functions now handle errors gracefully
    await Promise.allSettled([
      loadAvailableGifts(),
      loadClaimHistory()
    ]);
    
  } catch (error) {
    console.error('Claim error:', error);
    Swal.fire({
      icon: 'error',
      title: 'Claim Failed',
      text: error.message || 'Something went wrong. Please try again.',
      confirmButtonColor: '#FF4D6D'
    });
  }
}

// ========== SHOW ALL GIFTS (modal) ==========
function showAllGifts() {
  Swal.fire({
    title: 'All Available Gifts',
    html: '<p style="color:var(--muted);">Loading all gifts...</p>',
    showConfirmButton: false,
    didOpen: () => {
      Swal.showLoading();
      loadAllGiftsModal();
    }
  });
}

async function loadAllGiftsModal() {
  try {
    const giftsSnap = await db.collection('gifts')
      .where('isActive', '==', true)
      .get();
    
    const now = new Date();
    let gifts = [];
    giftsSnap.forEach(doc => {
      const gift = doc.data();
      const expiresAt = gift.expiresAt?.toDate();
      if (expiresAt && expiresAt > now) {
        const remaining = gift.totalUses - (gift.usedCount || 0);
        if (remaining > 0) {
          gifts.push({ ...gift, remaining });
        }
      }
    });

    if (gifts.length === 0) {
      Swal.fire({
        icon: 'info',
        title: 'No Gifts',
        text: 'No gifts available at the moment. Check back later!',
        confirmButtonColor: '#0052FF'
      });
      return;
    }
    
    let html = '<div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; max-height:400px; overflow-y:auto;">';
    gifts.forEach(gift => {
      html += `
        <div style="background:var(--bg); border-radius:12px; padding:15px; text-align:center; border:1px solid var(--border);">
          <div style="font-size:20px; font-weight:800; color:var(--primary);">‚Ç¶${gift.amount}</div>
          <div style="font-size:11px; font-weight:700; color:var(--muted); margin:5px 0;">${gift.code}</div>
          <div style="font-size:10px; font-weight:600; color:${gift.remaining > 0 ? 'var(--success)' : 'var(--danger)'};">
            ${gift.remaining} / ${gift.totalUses} left
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    Swal.fire({
      title: 'üéÅ Available Gifts',
      html: html,
      confirmButtonText: 'Got it',
      confirmButtonColor: '#0052FF'
    });
    
  } catch (error) {
    console.error('Error loading all gifts:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Could not load gifts',
      confirmButtonColor: '#FF4D6D'
    });
  }
}
</script>
</body>
</html>

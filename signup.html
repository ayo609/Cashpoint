<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cashpoint | Create Account</title>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary:      #0052FF;
    --primary-dark: #0039b3;
    --accent:       #00D4A0;
    --success:      #00C48C;
    --danger:       #FF4D6D;
    --warning:      #FFB800;
    --bg:           #F0F4FF;
    --text:         #0D1B3E;
    --muted:        #6B7A99;
    --border:       #D8E0F0;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html { scroll-behavior:smooth; }
  body {
    font-family:'Plus Jakarta Sans',sans-serif;
    background:var(--bg); color:var(--text);
    min-height:100vh; overflow-x:hidden;
  }

  /* â”€â”€ HERO / HEADER â”€â”€ */
  .top-hero {
    background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 55%,#001c6b 100%);
    padding:48px 24px 110px; text-align:center; position:relative; overflow:hidden;
  }
  .top-hero::before {
    content:''; position:absolute; width:320px; height:320px; border-radius:50%;
    background:rgba(255,255,255,0.05); top:-80px; right:-60px;
  }
  .top-hero::after {
    content:''; position:absolute; width:180px; height:180px; border-radius:50%;
    background:rgba(0,212,160,0.1); bottom:-50px; left:-30px;
  }
  .logo-row {
    display:flex; align-items:center; justify-content:center; gap:10px;
    margin-bottom:24px; position:relative; z-index:1;
  }
  .logo-box { width:44px;height:44px;background:rgba(255,255,255,0.18);border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px; }
  .logo-name { font-family:'Sora',sans-serif;font-size:22px;font-weight:700;color:white; }
  .hero-h { font-family:'Sora',sans-serif;font-size:clamp(22px,6vw,32px);font-weight:700;color:white;margin-bottom:8px;position:relative;z-index:1; }
  .hero-sub { font-size:13.5px;color:rgba(255,255,255,0.7);font-weight:500;position:relative;z-index:1; }

  /* â”€â”€ FORM CARD â”€â”€ */
  .card-outer { padding:0 16px; margin-top:-72px; position:relative; z-index:10; padding-bottom:40px; }
  .form-card {
    background:white; border-radius:24px;
    box-shadow:0 16px 50px rgba(0,82,255,0.15);
    overflow:hidden;
    animation:riseUp .5s cubic-bezier(.16,1,.3,1) both;
  }
  @keyframes riseUp { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }

  /* Referral banner inside card */
  .ref-banner {
    background:linear-gradient(135deg,var(--accent),var(--accent-dark));
    padding:14px 22px; display:flex; align-items:center; gap:12px;
    display:none;
  }
  .ref-banner.show { display:flex; }
  .ref-banner-icon { font-size:24px; flex-shrink:0; }
  .ref-banner-title { font-size:13px;font-weight:700;color:white;margin-bottom:2px; }
  .ref-banner-sub   { font-size:11.5px;color:rgba(255,255,255,0.85);font-weight:500; }

  .form-body { padding:28px 22px; display:flex; flex-direction:column; gap:18px; }

  /* Field group */
  .fg { display:flex; flex-direction:column; gap:7px; }
  .fg-label {
    font-size:12px;font-weight:700;color:var(--muted);
    text-transform:uppercase;letter-spacing:.06em;
    display:flex;align-items:center;gap:6px;
  }
  .fg-label i { font-size:12px;color:var(--primary); }
  .fg-row {
    display:flex;align-items:center;
    border:2px solid var(--border);border-radius:13px;overflow:hidden;
    transition:border-color .2s;
  }
  .fg-row:focus-within { border-color:var(--primary); }
  .fg-row.error { border-color:var(--danger); }
  .fg-row.ok { border-color:var(--success); }
  .fg-prefix {
    padding:0 14px;background:var(--bg);font-size:15px;
    color:var(--muted);border-right:2px solid var(--border);
    height:100%;display:flex;align-items:center;flex-shrink:0;
  }
  .fg-input {
    flex:1;padding:13px 14px;font-size:15px;font-weight:600;
    font-family:inherit;border:none;outline:none;
    color:var(--text);min-width:0;
  }
  .fg-input::placeholder { color:var(--border);font-weight:400; }
  .fg-suffix {
    padding:0 14px;cursor:pointer;color:var(--muted);font-size:16px;
    background:none;border:none;flex-shrink:0;
  }

  /* Referral code field special styling */
  .ref-field-row { border-color:var(--accent) !important; }
  .ref-field-row .fg-prefix { border-color:var(--accent); }
  .ref-verified { color:var(--success); font-size:13px; font-weight:700; padding-right:12px; flex-shrink:0; }

  /* Password strength */
  .pw-strength { height:4px;border-radius:99px;background:var(--border);margin-top:4px;overflow:hidden; }
  .pw-fill { height:100%;border-radius:99px;width:0%;transition:width .3s,background .3s; }

  /* Field hint */
  .fg-hint { font-size:11px;color:var(--muted);font-weight:600; }
  .fg-hint.err { color:var(--danger); }
  .fg-hint.ok  { color:var(--success); }

  /* Terms */
  .terms-row {
    display:flex;align-items:flex-start;gap:10px;
    background:var(--bg);border-radius:12px;padding:12px;
  }
  .terms-check { width:18px;height:18px;accent-color:var(--primary);cursor:pointer;margin-top:2px;flex-shrink:0; }
  .terms-text { font-size:12.5px;color:var(--muted);line-height:1.5; }
  .terms-text a { color:var(--primary);font-weight:700;text-decoration:none; }

  /* Submit btn */
  .submit-btn {
    width:100%;padding:15px;border:none;border-radius:14px;
    font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;
    color:white;background:linear-gradient(135deg,var(--primary),var(--primary-dark));
    box-shadow:0 7px 24px rgba(0,82,255,0.3);
    display:flex;align-items:center;justify-content:center;gap:9px;
    transition:transform .15s,box-shadow .15s;
  }
  .submit-btn:hover { transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,82,255,0.38); }
  .submit-btn:disabled { opacity:.6;cursor:not-allowed;transform:none!important; }

  /* Login link */
  .login-link {
    text-align:center;font-size:14px;color:var(--muted);font-weight:600;
    padding:0 22px 28px;
  }
  .login-link a { color:var(--primary);font-weight:700;text-decoration:none; }

  /* Benefits strip */
  .benefits {
    background:white;border-radius:20px;margin:0 16px;padding:20px;
    box-shadow:0 4px 16px rgba(0,82,255,0.07);
    display:grid;grid-template-columns:1fr 1fr;gap:12px;
  }
  .benefit-item { display:flex;align-items:center;gap:10px; }
  .ben-icon { font-size:22px;flex-shrink:0; }
  .ben-title { font-size:13px;font-weight:700;color:var(--text);margin-bottom:1px; }
  .ben-sub   { font-size:11px;color:var(--muted); }

  .page-bottom { height:30px; }
</style>
</head>
<body>

<!-- HERO -->
<div class="top-hero">
  <div class="logo-row">
    <div class="logo-box">ğŸ’°</div>
    <div class="logo-name">Cashpoint</div>
  </div>
  <div class="hero-h">Create Your Account ğŸš€</div>
  <div class="hero-sub">Join thousands earning daily returns</div>
</div>

<!-- FORM CARD -->
<div class="card-outer">
  <div class="form-card">

    <!-- Referral welcome banner â€” shown if ref code in URL -->
    <div class="ref-banner" id="refBanner">
      <div class="ref-banner-icon">ğŸ</div>
      <div>
        <div class="ref-banner-title">You were invited by a friend!</div>
        <div class="ref-banner-sub" id="refBannerSub">Referral code applied automatically</div>
      </div>
    </div>

    <div class="form-body">

      <!-- Full Name -->
      <div class="fg">
        <div class="fg-label"><i class="fas fa-id-card"></i> Full Name</div>
        <div class="fg-row" id="rowFullName">
          <span class="fg-prefix"><i class="fas fa-user"></i></span>
          <input class="fg-input" id="fullName" type="text" placeholder="Enter your full name" oninput="validateName()"/>
        </div>
        <span class="fg-hint" id="hintName"></span>
      </div>

      <!-- Username -->
      <div class="fg">
        <div class="fg-label"><i class="fas fa-at"></i> Username</div>
        <div class="fg-row" id="rowUsername">
          <span class="fg-prefix">@</span>
          <input class="fg-input" id="username" type="text" placeholder="Choose a username" oninput="validateUsername()"/>
        </div>
        <span class="fg-hint" id="hintUsername">Letters, numbers and underscores only</span>
      </div>

      <!-- Email -->
      <div class="fg">
        <div class="fg-label"><i class="fas fa-envelope"></i> Email Address</div>
        <div class="fg-row" id="rowEmail">
          <span class="fg-prefix"><i class="fas fa-envelope"></i></span>
          <input class="fg-input" id="email" type="email" placeholder="your@email.com" oninput="validateEmail()"/>
        </div>
        <span class="fg-hint" id="hintEmail"></span>
      </div>

      <!-- Phone -->
      <div class="fg">
        <div class="fg-label"><i class="fas fa-phone"></i> Phone Number</div>
        <div class="fg-row" id="rowPhone">
          <span class="fg-prefix"><i class="fas fa-phone"></i></span>
          <input class="fg-input" id="phone" type="tel" placeholder="e.g. 08012345678" oninput="validatePhone()"/>
        </div>
        <span class="fg-hint" id="hintPhone"></span>
      </div>

      <!-- Password -->
      <div class="fg">
        <div class="fg-label"><i class="fas fa-lock"></i> Password</div>
        <div class="fg-row" id="rowPassword">
          <span class="fg-prefix"><i class="fas fa-lock"></i></span>
          <input class="fg-input" id="password" type="password" placeholder="Min 8 characters" oninput="validatePassword()"/>
          <button class="fg-suffix" onclick="togglePw('password',this)" tabindex="-1"><i class="fas fa-eye"></i></button>
        </div>
        <div class="pw-strength"><div class="pw-fill" id="pwFill"></div></div>
        <span class="fg-hint" id="hintPassword"></span>
      </div>

      <!-- Confirm Password -->
      <div class="fg">
        <div class="fg-label"><i class="fas fa-lock"></i> Confirm Password</div>
        <div class="fg-row" id="rowConfirm">
          <span class="fg-prefix"><i class="fas fa-lock"></i></span>
          <input class="fg-input" id="confirmPassword" type="password" placeholder="Repeat your password" oninput="validateConfirm()"/>
          <button class="fg-suffix" onclick="togglePw('confirmPassword',this)" tabindex="-1"><i class="fas fa-eye"></i></button>
        </div>
        <span class="fg-hint" id="hintConfirm"></span>
      </div>

      <!-- Referral Code -->
      <div class="fg">
        <div class="fg-label"><i class="fas fa-gift"></i> Referral Code <span style="color:var(--muted);text-transform:none;font-weight:500;font-size:11px;">(optional)</span></div>
        <div class="fg-row" id="rowRefCode">
          <span class="fg-prefix"><i class="fas fa-tag"></i></span>
          <input class="fg-input" id="refCode" type="text" placeholder="Enter referral code if you have one" oninput="onRefCodeInput()"/>
          <span class="ref-verified" id="refVerified" style="display:none;"><i class="fas fa-check-circle"></i></span>
        </div>
        <span class="fg-hint" id="hintRefCode"></span>
      </div>

      <!-- Terms -->
      <div class="terms-row">
        <input class="terms-check" type="checkbox" id="termsCheck"/>
        <div class="terms-text">
          I agree to Cashpoint's <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>.
          I understand this is an investment platform and returns are not guaranteed.
        </div>
      </div>

      <!-- Submit -->
      <button class="submit-btn" id="signupBtn" onclick="doSignup()">
        <i class="fas fa-rocket"></i> Create My Account
      </button>

    </div>

    <!-- Login link -->
    <div class="login-link">
      Already have an account? <a href="login.html">Sign In</a>
    </div>

  </div>

  <!-- Benefits -->
  <div style="height:20px;"></div>
  <div class="benefits">
    <div class="benefit-item">
      <div class="ben-icon">ğŸ“ˆ</div>
      <div><div class="ben-title">Daily ROI</div><div class="ben-sub">Earn every 24 hours</div></div>
    </div>
    <div class="benefit-item">
      <div class="ben-icon">ğŸ‘¥</div>
      <div><div class="ben-title">3-Level Referrals</div><div class="ben-sub">Earn from your network</div></div>
    </div>
    <div class="benefit-item">
      <div class="ben-icon">ğŸ”’</div>
      <div><div class="ben-title">Secure</div><div class="ben-sub">Firebase protected</div></div>
    </div>
    <div class="benefit-item">
      <div class="ben-icon">ğŸ’¸</div>
      <div><div class="ben-title">Fast Withdrawal</div><div class="ben-sub">Within 24 hours</div></div>
    </div>
  </div>
</div>

<div class="page-bottom"></div>

<script>
/* â”€â”€ Firebase â”€â”€ */
const firebaseConfig = {
  apiKey:            "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
  authDomain:        "cashpoint-ac4f4.firebaseapp.com",
  projectId:         "cashpoint-ac4f4",
  storageBucket:     "cashpoint-ac4f4.firebasestorage.app",
  messagingSenderId: "16133206416",
  appId:             "1:16133206416:web:a093f4e153ad2c9bcc8315"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   READ REFERRAL CODE FROM URL
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   URL pattern:  signup.html?ref=ABCD1234
   OR the user can manually type a code.
   On page load we auto-fill and verify.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let verifiedReferrerUid = null;   // set when referral code is verified
let refCodeFromUrl      = '';

window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const urlRef = params.get('ref') || params.get('code') || '';
  if (urlRef) {
    refCodeFromUrl = urlRef.trim().toUpperCase();
    document.getElementById('refCode').value = refCodeFromUrl;
    document.getElementById('rowRefCode').classList.add('ref-field-row');
    verifyRefCode(refCodeFromUrl);
  }
});

/* â”€â”€ Verify referral code against Firestore â”€â”€ */
let refVerifyTimer = null;
function onRefCodeInput() {
  clearTimeout(refVerifyTimer);
  const code = document.getElementById('refCode').value.trim().toUpperCase();
  document.getElementById('refVerified').style.display  = 'none';
  document.getElementById('hintRefCode').textContent    = '';
  document.getElementById('hintRefCode').className      = 'fg-hint';
  document.getElementById('rowRefCode').classList.remove('ok', 'error', 'ref-field-row');
  verifiedReferrerUid = null;

  if (!code) return;
  setHint('hintRefCode', 'â³ Verifying...', '');
  refVerifyTimer = setTimeout(() => verifyRefCode(code), 700);
}

async function verifyRefCode(code) {
  if (!code) return;
  try {
    const snap = await db.collection('users')
      .where('referralCode', '==', code)
      .limit(1)
      .get();

    if (snap.empty) {
      setHint('hintRefCode', 'âŒ Invalid referral code', 'err');
      document.getElementById('rowRefCode').classList.add('error');
      verifiedReferrerUid = null;
    } else {
      const referrer = snap.docs[0].data();
      const referrerName = referrer.fullName || referrer.username || 'a friend';
      verifiedReferrerUid = snap.docs[0].id;

      setHint('hintRefCode', `âœ… Valid! Referred by ${referrerName}`, 'ok');
      document.getElementById('rowRefCode').classList.add('ok', 'ref-field-row');
      document.getElementById('refVerified').style.display = 'flex';

      /* Show top banner */
      document.getElementById('refBanner').classList.add('show');
      document.getElementById('refBannerSub').textContent =
        `Referred by ${referrerName} â€” your upline will earn bonuses when you invest`;
    }
  } catch(e) {
    console.error('Ref code verify error:', e);
    setHint('hintRefCode', 'âš ï¸ Could not verify code. Check your connection.', 'err');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VALIDATORS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function validateName() {
  const v = document.getElementById('fullName').value.trim();
  if (v.length < 3) { fieldError('rowFullName','hintName','Name must be at least 3 characters'); return false; }
  fieldOk('rowFullName','hintName',''); return true;
}
function validateUsername() {
  const v = document.getElementById('username').value.trim();
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(v)) {
    fieldError('rowUsername','hintUsername','3â€“20 chars: letters, numbers, underscores only'); return false;
  }
  fieldOk('rowUsername','hintUsername','âœ“ Looks good'); return true;
}
function validateEmail() {
  const v = document.getElementById('email').value.trim();
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) {
    fieldError('rowEmail','hintEmail','Enter a valid email address'); return false;
  }
  fieldOk('rowEmail','hintEmail',''); return true;
}
function validatePhone() {
  const v = document.getElementById('phone').value.trim();
  if (!/^[0-9+\s\-]{8,15}$/.test(v)) {
    fieldError('rowPhone','hintPhone','Enter a valid phone number'); return false;
  }
  fieldOk('rowPhone','hintPhone',''); return true;
}
function validatePassword() {
  const v   = document.getElementById('password').value;
  const fill = document.getElementById('pwFill');
  let score = 0;
  if (v.length >= 8)        score++;
  if (v.length >= 12)       score++;
  if (/[A-Z]/.test(v))      score++;
  if (/[0-9]/.test(v))      score++;
  if (/[^A-Za-z0-9]/.test(v)) score++;
  const levels = [
    {w:'20%',bg:'#FF4D6D',t:'Very Weak'},
    {w:'40%',bg:'#FFB800',t:'Weak'},
    {w:'60%',bg:'#FFB800',t:'Fair'},
    {w:'80%',bg:'#00C48C',t:'Strong'},
    {w:'100%',bg:'#0052FF',t:'Very Strong'}
  ];
  const lvl = levels[Math.max(0,score-1)];
  fill.style.width      = v.length ? lvl.w  : '0%';
  fill.style.background = lvl.bg;
  if (v.length < 8) { fieldError('rowPassword','hintPassword','Minimum 8 characters'); return false; }
  fieldOk('rowPassword','hintPassword', lvl.t); return true;
}
function validateConfirm() {
  const pw  = document.getElementById('password').value;
  const cpw = document.getElementById('confirmPassword').value;
  if (pw !== cpw) { fieldError('rowConfirm','hintConfirm','Passwords do not match'); return false; }
  fieldOk('rowConfirm','hintConfirm','âœ“ Passwords match'); return true;
}

function fieldError(rowId, hintId, msg) {
  document.getElementById(rowId).className = 'fg-row error';
  setHint(hintId, msg, 'err');
}
function fieldOk(rowId, hintId, msg) {
  document.getElementById(rowId).className = 'fg-row ok';
  setHint(hintId, msg, 'ok');
}
function setHint(id, msg, type) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.className   = 'fg-hint' + (type ? ' '+type : '');
}
function togglePw(id, btn) {
  const input = document.getElementById(id);
  const isText = input.type === 'text';
  input.type = isText ? 'password' : 'text';
  btn.innerHTML = `<i class="fas fa-eye${isText ? '' : '-slash'}"></i>`;
}

/* â”€â”€ Generate unique referral code â”€â”€ */
function generateRefCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = 'CP';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGNUP
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. Validate all fields
   2. Create Firebase Auth account
   3. Generate referral code (unique)
   4. Create /users/{uid} document:
      - Sets referrerUid to the verified
        upline's UID (from ref code)
      - Sets balance = 0
      - Sets isAdmin = false
   5. Redirect to home/plans
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doSignup() {
  /* Validate all fields first */
  const ok = validateName() & validateUsername() & validateEmail()
           & validatePhone() & validatePassword() & validateConfirm();
  if (!ok) {
    Swal.fire({ icon:'warning', title:'Fix the errors above', text:'Please correct all highlighted fields.', confirmButtonColor:'#0052FF' });
    return;
  }
  if (!document.getElementById('termsCheck').checked) {
    Swal.fire({ icon:'warning', title:'Accept Terms', text:'Please agree to the Terms of Service to continue.', confirmButtonColor:'#0052FF' });
    return;
  }

  const fullName = document.getElementById('fullName').value.trim();
  const username = document.getElementById('username').value.trim().toLowerCase();
  const email    = document.getElementById('email').value.trim().toLowerCase();
  const phone    = document.getElementById('phone').value.trim();
  const password = document.getElementById('password').value;
  const enteredRefCode = document.getElementById('refCode').value.trim().toUpperCase();
  const btn      = document.getElementById('signupBtn');

  btn.disabled = true;
  Swal.fire({ title:'Creating account...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

  let uid = null;

  try {
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 1: Create Firebase Auth
       This must happen FIRST because
       all Firestore reads below need
       the user to be authenticated.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    uid = cred.user.uid;

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 2: Check username unique
       Now user is logged in so the
       Firestore read is allowed.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const unameSnap = await db.collection('users')
      .where('username', '==', username)
      .limit(1).get();

    if (!unameSnap.empty) {
      /* Username taken â€” delete the auth account we just created and stop */
      await cred.user.delete();
      Swal.fire({ icon:'error', title:'Username Taken', text:'That username is already in use. Please choose another.', confirmButtonColor:'#0052FF' });
      btn.disabled = false;
      return;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 3: Generate referral code
       Also runs after auth so reads
       are permitted by Firestore.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let myRefCode = generateRefCode();
    let attempts  = 0;
    while (attempts < 5) {
      const snap = await db.collection('users')
        .where('referralCode', '==', myRefCode).limit(1).get();
      if (snap.empty) break;
      myRefCode = generateRefCode();
      attempts++;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 4: Re-verify referral code
       if one was entered (in case the
       page was loaded without URL param
       and user typed one manually).
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let finalReferrerUid = verifiedReferrerUid;

    if (!finalReferrerUid && enteredRefCode) {
      try {
        const refSnap = await db.collection('users')
          .where('referralCode', '==', enteredRefCode)
          .limit(1).get();
        if (!refSnap.empty) {
          finalReferrerUid = refSnap.docs[0].id;
        }
      } catch(e) {
        /* Referral code verification failed â€” continue without it */
        console.warn('Could not verify ref code at signup:', e.message);
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 5: Write user document
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const userDoc = {
      uid,
      fullName,
      username,
      email,
      phone,
      referralCode:     myRefCode,
      referrerUid:      finalReferrerUid || 'direct',
      referredBy:       enteredRefCode || '',
      balance:          0,
      totalInvested:    0,
      totalEarnings:    0,
      totalRefEarnings: 0,
      referralCount:    0,
      level1Count:      0,
      level2Count:      0,
      level3Count:      0,
      isAdmin:          false,
      createdAt:        firebase.firestore.FieldValue.serverTimestamp(),
      lastLogin:        firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection('users').doc(uid).set(userDoc);

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 6: Write referral subcollections
       Walk up to 3 levels and write:
         users/{uplineUid}/referrals/{newUid}
       This is what powers the referral page
       display AND the bonus distribution.
       Also increments count fields on upliners.
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    if (finalReferrerUid && finalReferrerUid !== 'direct') {
      try {
        const COMMISSION_RATES = { 1: 25, 2: 2, 3: 1 };
        let   walkUid          = finalReferrerUid;
        const now              = firebase.firestore.FieldValue.serverTimestamp();

        for (let lvl = 1; lvl <= 3; lvl++) {
          if (!walkUid || walkUid === 'direct' || walkUid === '') break;

          /* â”€â”€ Write subcollection entry on this upline â”€â”€ */
          await db.collection('users').doc(walkUid)
            .collection('referrals').doc(uid).set({
              uid,
              level:      lvl,
              commission: COMMISSION_RATES[lvl],
              referredAt: now,
              fullName:   fullName  || '',
              username:   username  || '',
              email:      email     || ''
            });

          /* â”€â”€ Increment count fields â”€â”€ */
          const countField = `level${lvl}Count`;
          await db.collection('users').doc(walkUid).update({
            referralCount:             firebase.firestore.FieldValue.increment(lvl === 1 ? 1 : 0),
            [countField]:              firebase.firestore.FieldValue.increment(1),
          });

          /* â”€â”€ Walk one level higher â”€â”€ */
          try {
            const upSnap = await db.collection('users').doc(walkUid).get();
            if (!upSnap.exists) break;
            const nextUid = upSnap.data().referrerUid;
            if (!nextUid || nextUid === 'direct' || nextUid === '') break;
            walkUid = nextUid;
          } catch(walkErr) {
            console.warn(`Referral chain walk L${lvl} failed:`, walkErr.message);
            break;
          }
        }

        console.log('[Signup] Referral subcollections written successfully');
      } catch(e) {
        /* Non-fatal â€” don't block signup */
        console.warn('Could not write referral subcollections:', e.message);
      }
    }

    Swal.close();

    await Swal.fire({
      icon: 'success',
      title: 'ğŸ‰ Account Created!',
      html: `
        <div style="font-family:'Plus Jakarta Sans',sans-serif;text-align:center;">
          <div style="font-size:15px;font-weight:700;color:#0D1B3E;margin-bottom:6px;">Welcome, ${fullName.split(' ')[0]}!</div>
          <div style="font-size:13px;color:#6B7A99;margin-bottom:14px;">Your account is ready. Deposit funds and choose an investment plan to start earning!</div>
          <div style="background:#F0F4FF;border-radius:10px;padding:10px 14px;display:inline-block;">
            <div style="font-size:11px;color:#6B7A99;font-weight:700;">Your Referral Code</div>
            <div style="font-size:18px;font-weight:800;color:#0052FF;letter-spacing:2px;">${myRefCode}</div>
          </div>
          ${finalReferrerUid && finalReferrerUid !== 'direct' ? '<div style="margin-top:10px;font-size:12px;color:#00C48C;font-weight:700;">âœ… Referral applied successfully!</div>' : ''}
        </div>
      `,
      confirmButtonText: 'Go to Dashboard',
      confirmButtonColor: '#0052FF',
      allowOutsideClick: false
    });

    window.location.href = 'home.html';

  } catch(err) {
    console.error('Signup error:', err.code, err.message);

    /* If auth was created but Firestore write failed, delete the auth account
       so the user can try again without "email already in use" next time */
    if (uid) {
      try {
        const u = auth.currentUser;
        if (u) await u.delete();
      } catch(delErr) {
        console.warn('Could not clean up auth account:', delErr.message);
      }
    }

    let msg = 'Registration failed. Please try again.';
    if (err.code === 'auth/email-already-in-use')  msg = 'That email is already registered. Try logging in instead.';
    if (err.code === 'auth/invalid-email')          msg = 'Please enter a valid email address.';
    if (err.code === 'auth/weak-password')          msg = 'Password is too weak. Use at least 8 characters.';
    if (err.code === 'auth/network-request-failed') msg = 'Network error. Please check your internet connection.';
    if (err.code === 'permission-denied')           msg = 'Permission error. Please refresh and try again.';

    Swal.fire({
      icon: 'error',
      title: 'Signup Failed',
      text: msg,
      confirmButtonColor: '#0052FF'
    });
    btn.disabled = false;
  }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"/>
<title>Cashpoint Admin | Gift Management System üéÅ</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #0052FF;
  --primary-dark: #0039b3;
  --accent: #00D4A0;
  --accent-dark: #00a87e;
  --warning: #FFB800;
  --danger: #FF4D6D;
  --success: #00C48C;
  --bg: #F0F4FF;
  --card: #ffffff;
  --text: #0D1B3E;
  --muted: #6B7A99;
  --border: #D8E0F0;
  --nav-h: 70px;
  --gift-gradient: linear-gradient(135deg, #FF6B6B, #FF8E53);
  --gold-gradient: linear-gradient(135deg, #FFD700, #FFA500);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  padding-bottom: 20px;
  overflow-x: hidden;
  min-height: 100vh;
}

/* ========== ADMIN HEADER ========== */
.admin-header {
  background: white;
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 10px rgba(0,82,255,0.08);
}

.admin-header-left {
  display: flex;
  align-items: center;
  gap: 20px;
}

.admin-logo {
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: 'Sora', sans-serif;
  font-weight: 800;
  font-size: 20px;
  color: var(--text);
}

.admin-logo-icon {
  width: 42px;
  height: 42px;
  background: var(--gift-gradient);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: white;
}

.admin-badge {
  background: var(--primary);
  color: white;
  font-size: 11px;
  font-weight: 800;
  padding: 4px 10px;
  border-radius: 99px;
  letter-spacing: 0.5px;
}

.admin-header-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.admin-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--bg);
  padding: 6px 12px 6px 6px;
  border-radius: 99px;
  border: 1px solid var(--border);
}

.admin-avatar {
  width: 36px;
  height: 36px;
  background: var(--gift-gradient);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 800;
  font-size: 14px;
}

.admin-name {
  font-weight: 600;
  font-size: 14px;
}

.back-to-dashboard {
  padding: 8px 16px;
  border-radius: 10px;
  background: var(--bg);
  border: 1.5px solid var(--border);
  color: var(--muted);
  text-decoration: none;
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.back-to-dashboard:hover {
  border-color: var(--primary);
  color: var(--primary);
}

/* ========== PAGE CONTAINER ========== */
.page-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 30px 24px;
}

/* ========== PAGE HEADER ========== */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 20px;
}

.page-header-left h1 {
  font-family: 'Sora', sans-serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.page-header-left p {
  color: var(--muted);
  font-size: 15px;
}

.page-header-right {
  display: flex;
  gap: 12px;
}

.header-btn {
  padding: 12px 24px;
  border-radius: 12px;
  border: none;
  font-size: 14px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
}

.btn-primary {
  background: var(--gift-gradient);
  color: white;
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
}

.btn-secondary {
  background: var(--bg);
  color: var(--text);
  border: 2px solid var(--border);
}

.btn-secondary:hover {
  border-color: var(--primary);
  color: var(--primary);
}

/* ========== STATS GRID ========== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  border-radius: 20px;
  padding: 24px 20px;
  box-shadow: 0 4px 20px rgba(0,82,255,0.06);
  border: 1px solid var(--border);
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(0,82,255,0.1);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: var(--gift-gradient);
}

.stat-icon {
  width: 48px;
  height: 48px;
  background: var(--bg);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: var(--primary);
  margin-bottom: 15px;
}

.stat-value {
  font-family: 'Sora', sans-serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 13px;
  color: var(--muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-trend {
  font-size: 12px;
  font-weight: 600;
  color: var(--success);
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 4px;
}

/* ========== CHARTS SECTION ========== */
.charts-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 30px;
}

.chart-card {
  background: white;
  border-radius: 20px;
  padding: 20px;
  border: 1px solid var(--border);
  box-shadow: 0 4px 20px rgba(0,82,255,0.06);
}

.chart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.chart-header h3 {
  font-family: 'Sora', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

.chart-badge {
  background: var(--bg);
  color: var(--muted);
  padding: 4px 12px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
}

.chart-container {
  position: relative;
  height: 250px;
  width: 100%;
}

/* ========== FILTERS BAR ========== */
.filters-bar {
  background: white;
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 30px;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 20px;
}

.filters-left {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg);
  padding: 4px 4px 4px 15px;
  border-radius: 99px;
  border: 1px solid var(--border);
}

.filter-group i {
  color: var(--muted);
  font-size: 14px;
}

.filter-select {
  border: none;
  background: transparent;
  padding: 10px 15px 10px 5px;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  outline: none;
}

.filter-search {
  display: flex;
  align-items: center;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 99px;
  padding: 0 15px;
}

.filter-search input {
  border: none;
  background: transparent;
  padding: 12px 10px;
  width: 200px;
  font-family: inherit;
  font-size: 13px;
  outline: none;
}

.filter-search i {
  color: var(--muted);
}

.filters-right {
  display: flex;
  gap: 10px;
}

.filter-btn {
  padding: 8px 16px;
  border-radius: 99px;
  border: 1px solid var(--border);
  background: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

/* ========== GIFTS TABLE ========== */
.gifts-table-container {
  background: white;
  border-radius: 20px;
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: 30px;
  box-shadow: 0 4px 20px rgba(0,82,255,0.06);
}

.gifts-table {
  width: 100%;
  border-collapse: collapse;
}

.gifts-table th {
  background: var(--bg);
  padding: 18px 16px;
  text-align: left;
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border);
}

.gifts-table td {
  padding: 18px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  font-weight: 500;
}

.gifts-table tr:hover td {
  background: #f8f9ff;
}

.gifts-table tr:last-child td {
  border-bottom: none;
}

.gift-code {
  font-family: 'Sora', sans-serif;
  font-weight: 700;
  color: var(--primary);
  background: var(--bg);
  padding: 4px 12px;
  border-radius: 99px;
  display: inline-block;
  font-size: 12px;
  letter-spacing: 0.5px;
}

.gift-amount {
  font-family: 'Sora', sans-serif;
  font-weight: 800;
  color: var(--success);
  font-size: 16px;
}

.progress-bar {
  width: 120px;
  height: 8px;
  background: var(--border);
  border-radius: 99px;
  overflow: hidden;
  margin-bottom: 5px;
}

.progress-fill {
  height: 100%;
  background: var(--gift-gradient);
  border-radius: 99px;
  transition: width 0.3s;
}

.uses-text {
  font-size: 11px;
  color: var(--muted);
  font-weight: 600;
}

.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 700;
  text-transform: capitalize;
}

.status-active {
  background: #E8FFF6;
  color: var(--success);
}

.status-expired {
  background: #FFF0F3;
  color: var(--danger);
}

.status-full {
  background: var(--bg);
  color: var(--muted);
}

.expiry-date {
  font-size: 12px;
  font-weight: 600;
}

.expiry-date.expired {
  color: var(--danger);
}

.expiry-date.soon {
  color: var(--warning);
}

.action-btns {
  display: flex;
  gap: 8px;
}

.action-btn {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  border: none;
  background: var(--bg);
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.action-btn:hover {
  background: var(--primary);
  color: white;
  transform: translateY(-2px);
}

.action-btn.delete:hover {
  background: var(--danger);
}

.action-btn.edit:hover {
  background: var(--success);
}

/* ========== PAGINATION ========== */
.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 20px;
}

.page-btn {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: white;
  color: var(--text);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.page-btn:hover:not(:disabled) {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.page-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

.page-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ========== TOAST NOTIFICATIONS ========== */
.toast-container {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 9999;
}

.toast {
  background: white;
  border-radius: 12px;
  padding: 15px 20px;
  margin-bottom: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideIn 0.3s ease;
  border-left: 4px solid var(--success);
  min-width: 300px;
}

.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--danger); }
.toast.warning { border-left-color: var(--warning); }

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* ========== MODAL ========== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal-overlay.active {
  display: flex;
}

.modal-container {
  background: white;
  border-radius: 28px;
  max-width: 550px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: modalSlideUp 0.4s cubic-bezier(0.16,1,0.3,1);
}

@keyframes modalSlideUp {
  from { opacity: 0; transform: translateY(50px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  padding: 28px 30px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-header h2 {
  font-family: 'Sora', sans-serif;
  font-size: 22px;
  font-weight: 800;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: var(--bg);
  border: none;
  cursor: pointer;
  font-size: 18px;
  color: var(--muted);
  transition: all 0.2s;
}

.modal-close:hover {
  background: var(--danger);
  color: white;
}

.modal-body {
  padding: 30px;
}

/* ========== FORM STYLES ========== */
.form-group {
  margin-bottom: 24px;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.form-label i {
  color: var(--primary);
  font-size: 14px;
}

.form-input {
  width: 100%;
  padding: 16px 18px;
  border: 2px solid var(--border);
  border-radius: 16px;
  font-size: 16px;
  font-weight: 500;
  font-family: inherit;
  transition: all 0.3s;
}

.form-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(0,82,255,0.1);
}

.form-input.code-input {
  text-transform: uppercase;
  letter-spacing: 2px;
  font-weight: 700;
  font-size: 18px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.amount-input-group {
  position: relative;
}

.amount-prefix {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  font-weight: 700;
  color: var(--muted);
}

.amount-input-group input {
  padding-left: 45px;
}

.form-checkbox {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.form-checkbox input {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.form-checkbox span {
  font-size: 15px;
  font-weight: 600;
}

/* ========== PREVIEW CARD ========== */
.preview-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20px;
  padding: 25px;
  margin-top: 30px;
  color: white;
  position: relative;
  overflow: hidden;
}

.preview-card::before {
  content: 'üéÅ';
  position: absolute;
  font-size: 100px;
  right: -20px;
  bottom: -20px;
  opacity: 0.2;
  transform: rotate(15deg);
}

.preview-title {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 2px;
  opacity: 0.8;
  margin-bottom: 15px;
}

.preview-amount {
  font-family: 'Sora', sans-serif;
  font-size: 42px;
  font-weight: 800;
  margin-bottom: 10px;
}

.preview-code {
  font-family: 'Sora', sans-serif;
  font-size: 24px;
  font-weight: 700;
  letter-spacing: 4px;
  background: rgba(255,255,255,0.2);
  display: inline-block;
  padding: 10px 20px;
  border-radius: 99px;
  margin-bottom: 15px;
}

.preview-details {
  display: flex;
  gap: 20px;
  font-size: 14px;
  opacity: 0.9;
}

.modal-footer {
  padding: 20px 30px 30px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 15px;
}

.modal-btn {
  flex: 1;
  padding: 16px;
  border-radius: 14px;
  border: none;
  font-size: 15px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-btn-primary {
  background: var(--gift-gradient);
  color: white;
  box-shadow: 0 6px 20px rgba(255,107,107,0.3);
}

.modal-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(255,107,107,0.4);
}

.modal-btn-secondary {
  background: var(--bg);
  color: var(--text);
  border: 2px solid var(--border);
}

.modal-btn-secondary:hover {
  border-color: var(--primary);
  color: var(--primary);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 1024px) {
  .charts-section {
    grid-template-columns: 1fr;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .page-header-right {
    width: 100%;
    flex-direction: column;
  }
  
  .header-btn {
    width: 100%;
    justify-content: center;
  }
  
  .filters-bar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .filters-left {
    flex-direction: column;
    width: 100%;
  }
  
  .filter-group {
    width: 100%;
  }
  
  .filter-search {
    width: 100%;
  }
  
  .filter-search input {
    width: 100%;
  }
  
  .filters-right {
    width: 100%;
    justify-content: stretch;
  }
  
  .filter-btn {
    flex: 1;
    text-align: center;
  }
  
  .gifts-table th:nth-child(5),
  .gifts-table td:nth-child(5) {
    display: none;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .gifts-table th:nth-child(4),
  .gifts-table td:nth-child(4) {
    display: none;
  }
  
  .modal-container {
    max-width: 100%;
  }
  
  .modal-header {
    padding: 20px;
  }
  
  .modal-body {
    padding: 20px;
  }
  
  .modal-footer {
    flex-direction: column;
  }
}
</style>
</head>
<body>

<!-- TOAST NOTIFICATIONS -->
<div class="toast-container" id="toastContainer"></div>

<!-- CREATE/EDIT GIFT MODAL -->
<div class="modal-overlay" id="giftModal">
  <div class="modal-container">
    <div class="modal-header">
      <h2>
        <i class="fas fa-gift" style="color:var(--primary);"></i>
        <span id="modalTitle">Create New Gift</span>
      </h2>
      <button class="modal-close" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form id="giftForm">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-tag"></i>
            Gift Code
          </label>
          <input type="text" class="form-input code-input" id="giftCode" 
                 placeholder="e.g., HAPPY100" maxlength="20" required>
          <small style="color:var(--muted); font-size:11px; margin-top:5px; display:block;">
            Code will be automatically uppercase
          </small>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-naira-sign"></i>
              Amount (‚Ç¶)
            </label>
            <div class="amount-input-group">
              <span class="amount-prefix">‚Ç¶</span>
              <input type="number" class="form-input" id="giftAmount" 
                     placeholder="1000" min="10" step="10" required>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-users"></i>
              Total Uses
            </label>
            <input type="number" class="form-input" id="giftUses" 
                   placeholder="50" min="1" max="10000" value="50" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-calendar-alt"></i>
              Expiry Date
            </label>
            <input type="datetime-local" class="form-input" id="giftExpiry" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-clock"></i>
              Status
            </label>
            <select class="form-input" id="giftStatus">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="giftUnlimited" checked>
            <span>Enable unlimited usage? (No expiry on uses)</span>
          </label>
        </div>
        
        <!-- PREVIEW SECTION -->
        <div class="preview-card" id="giftPreview">
          <div class="preview-title">GIFT PREVIEW</div>
          <div class="preview-amount" id="previewAmount">‚Ç¶0</div>
          <div class="preview-code" id="previewCode">CODE</div>
          <div class="preview-details">
            <span id="previewUses">50 uses</span>
            <span id="previewExpiry">Expires: Never</span>
          </div>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">
        Cancel
      </button>
      <button class="modal-btn modal-btn-primary" id="modalSaveBtn" onclick="saveGift()">
        <i class="fas fa-gift"></i>
        <span id="saveBtnText">Create Gift</span>
      </button>
    </div>
  </div>
</div>

<!-- VIEW GIFT DETAILS MODAL -->
<div class="modal-overlay" id="viewGiftModal">
  <div class="modal-container">
    <div class="modal-header">
      <h2>
        <i class="fas fa-gift" style="color:var(--primary);"></i>
        Gift Details
      </h2>
      <button class="modal-close" onclick="closeViewModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body" id="viewGiftDetails">
      <!-- Will be populated dynamically -->
    </div>
    
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="closeViewModal()">
        Close
      </button>
    </div>
  </div>
</div>

<!-- ADMIN HEADER -->
<div class="admin-header">
  <div class="admin-header-left">
    <div class="admin-logo">
      <div class="admin-logo-icon">üéÅ</div>
      Gift Management System
      <span class="admin-badge">ADMIN</span>
    </div>
  </div>
  <div class="admin-header-right">
    <div class="admin-profile">
      <div class="admin-avatar" id="adminAvatar">A</div>
      <span class="admin-name" id="adminName">Admin</span>
    </div>
    <a href="admin-dashboard.html" class="back-to-dashboard">
      <i class="fas fa-arrow-left"></i>
      Dashboard
    </a>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="page-container">
  
  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="page-header-left">
      <h1>
        <i class="fas fa-gift" style="color:var(--primary);"></i>
        Gift Code Manager
      </h1>
      <p>Create, manage, and track all gift codes and bonuses</p>
    </div>
    <div class="page-header-right">
      <button class="header-btn btn-primary" onclick="openCreateModal()">
        <i class="fas fa-plus"></i>
        Create New Gift
      </button>
      <button class="header-btn btn-secondary" onclick="exportGifts()">
        <i class="fas fa-download"></i>
        Export Data
      </button>
    </div>
  </div>
  
  <!-- STATS CARDS -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üéÅ</div>
      <div class="stat-value" id="statTotalGifts">0</div>
      <div class="stat-label">Total Gifts</div>
      <div class="stat-trend" id="statGiftsTrend">+0 this month</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üí∞</div>
      <div class="stat-value" id="statTotalAmount">‚Ç¶0</div>
      <div class="stat-label">Total Bonus Value</div>
      <div class="stat-trend" id="statAmountTrend">Across all gifts</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-value" id="statClaimed">0</div>
      <div class="stat-label">Total Claims</div>
      <div class="stat-trend" id="statClaimedTrend">Successful claims</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üë•</div>
      <div class="stat-value" id="statUsers">0</div>
      <div class="stat-label">Beneficiaries</div>
      <div class="stat-trend" id="statUsersTrend">Unique users</div>
    </div>
  </div>
  
  <!-- CHARTS SECTION -->
  <div class="charts-section">
    <div class="chart-card">
      <div class="chart-header">
        <h3>Claims Overview (Last 7 Days)</h3>
        <span class="chart-badge">Daily</span>
      </div>
      <div class="chart-container">
        <canvas id="claimsChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-header">
        <h3>Gift Amount Distribution</h3>
        <span class="chart-badge">By Value</span>
      </div>
      <div class="chart-container">
        <canvas id="amountsChart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- FILTERS BAR -->
  <div class="filters-bar">
    <div class="filters-left">
      <div class="filter-group">
        <i class="fas fa-filter"></i>
        <select class="filter-select" id="statusFilter" onchange="loadGifts()">
          <option value="all">All Status</option>
          <option value="active">Active Only</option>
          <option value="expired">Expired Only</option>
          <option value="full">Fully Claimed</option>
        </select>
      </div>
      
      <div class="filter-group">
        <i class="fas fa-sort"></i>
        <select class="filter-select" id="sortFilter" onchange="loadGifts()">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="amount_high">Highest Amount</option>
          <option value="amount_low">Lowest Amount</option>
          <option value="claims_high">Most Claims</option>
        </select>
      </div>
      
      <div class="filter-search">
        <input type="text" id="searchInput" placeholder="Search by code..." onkeyup="searchGifts()">
        <i class="fas fa-search"></i>
      </div>
    </div>
    
    <div class="filters-right">
      <button class="filter-btn" onclick="filterByPeriod('today')">Today</button>
      <button class="filter-btn" onclick="filterByPeriod('week')">This Week</button>
      <button class="filter-btn" onclick="filterByPeriod('month')">This Month</button>
      <button class="filter-btn active" onclick="filterByPeriod('all')">All Time</button>
    </div>
  </div>
  
  <!-- GIFTS TABLE -->
  <div class="gifts-table-container">
    <table class="gifts-table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Amount</th>
          <th>Uses</th>
          <th>Status</th>
          <th>Expiry</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="giftsTableBody">
        <!-- Will be populated by JavaScript -->
      </tbody>
    </table>
  </div>
  
  <!-- PAGINATION -->
  <div class="pagination" id="pagination">
    <button class="page-btn" onclick="changePage('prev')" id="prevPage">‚Üê</button>
    <button class="page-btn active" onclick="changePage(1)">1</button>
    <button class="page-btn" onclick="changePage(2)">2</button>
    <button class="page-btn" onclick="changePage(3)">3</button>
    <button class="page-btn" onclick="changePage('next')" id="nextPage">‚Üí</button>
  </div>
  
</div>

<script>
// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
  authDomain: "cashpoint-ac4f4.firebaseapp.com",
  projectId: "cashpoint-ac4f4",
  storageBucket: "cashpoint-ac4f4.firebasestorage.app",
  messagingSenderId: "16133206416",
  appId: "1:16133206416:web:a093f4e153ad2c9bcc8315"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const FieldValue = firebase.firestore.FieldValue;

// ========== GLOBAL VARIABLES ==========
let currentUser = null;
let allGifts = [];
let allClaims = [];
let allUsers = [];
let currentPage = 1;
let itemsPerPage = 10;
let currentFilter = 'all';
let currentPeriod = 'all';
let currentSort = 'newest';
let searchQuery = '';
let claimsChart = null;
let amountsChart = null;

// ========== AUTH CHECK ==========
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    window.location.href = 'admin-login.html';
    return;
  }
  
  try {
    // Check if user is admin
    const userDoc = await db.collection('users').doc(user.uid).get();
    if (!userDoc.exists || !userDoc.data().isAdmin) {
      await auth.signOut();
      window.location.href = 'login.html';
      return;
    }
    
    currentUser = user;
    
    // Set admin info
    const adminData = userDoc.data();
    document.getElementById('adminName').textContent = adminData.fullName || 'Admin';
    document.getElementById('adminAvatar').textContent = 
      (adminData.fullName || 'A').charAt(0).toUpperCase();
    
    await loadAllData();
    initializeCharts();
    
  } catch (error) {
    console.error('Auth error:', error);
  }
});

// ========== LOAD ALL DATA ==========
async function loadAllData() {
  try {
    // Load gifts
    const giftsSnap = await db.collection('gifts').get();
    allGifts = giftsSnap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    // Load claims
    const claimsSnap = await db.collection('gift_claims').get();
    allClaims = claimsSnap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    // Load users who claimed gifts
    const uniqueUserIds = [...new Set(allClaims.map(c => c.userId))];
    allUsers = uniqueUserIds;
    
    updateStats();
    renderGifts();
    
  } catch (error) {
    console.error('Error loading data:', error);
    showToast('error', 'Error', 'Failed to load gift data');
  }
}

// ========== UPDATE STATS ==========
function updateStats() {
  // Total gifts
  document.getElementById('statTotalGifts').textContent = allGifts.length;
  
  // Total bonus value
  const totalValue = allGifts.reduce((sum, gift) => sum + (gift.amount || 0), 0);
  document.getElementById('statTotalAmount').textContent = '‚Ç¶' + totalValue.toLocaleString();
  
  // Total claims
  document.getElementById('statClaimed').textContent = allClaims.length;
  
  // Unique users
  document.getElementById('statUsers').textContent = allUsers.length;
  
  // Calculate monthly trend
  const thisMonth = new Date().getMonth();
  const thisYear = new Date().getFullYear();
  const giftsThisMonth = allGifts.filter(gift => {
    const date = gift.createdAt?.toDate?.() || new Date();
    return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
  }).length;
  document.getElementById('statGiftsTrend').textContent = `+${giftsThisMonth} this month`;
  
  // Update charts
  updateCharts();
}

// ========== RENDER GIFTS ==========
function renderGifts() {
  let filtered = filterGifts();
  
  const tbody = document.getElementById('giftsTableBody');
  tbody.innerHTML = '';
  
  if (filtered.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align:center; padding:40px; color:var(--muted);">
          <i class="fas fa-gift" style="font-size:48px; margin-bottom:10px; display:block; opacity:0.5;"></i>
          No gifts found
        </td>
      </tr>
    `;
    return;
  }
  
  // Pagination
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const paginatedGifts = filtered.slice(start, end);
  
  paginatedGifts.forEach(gift => {
    const used = gift.usedCount || 0;
    const total = gift.totalUses || 0;
    const percent = total > 0 ? (used / total) * 100 : 0;
    
    // Check expiry
    const expiryDate = gift.expiresAt?.toDate?.() || null;
    const now = new Date();
    const isExpired = expiryDate && expiryDate < now;
    const isSoon = expiryDate && ((expiryDate - now) / (1000 * 60 * 60 * 24)) < 3;
    
    let statusClass = 'status-active';
    let statusText = 'Active';
    
    if (isExpired) {
      statusClass = 'status-expired';
      statusText = 'Expired';
    } else if (used >= total && total > 0) {
      statusClass = 'status-full';
      statusText = 'Full';
    } else if (!gift.isActive) {
      statusClass = 'status-expired';
      statusText = 'Inactive';
    }
    
    const expiryClass = isExpired ? 'expired' : (isSoon ? 'soon' : '');
    const expiryText = expiryDate ? expiryDate.toLocaleDateString() : 'Never';
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><span class="gift-code">${gift.code || 'N/A'}</span></td>
      <td><span class="gift-amount">‚Ç¶${(gift.amount || 0).toLocaleString()}</span></td>
      <td>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${percent}%;"></div>
        </div>
        <div class="uses-text">${used} / ${total === 0 ? '‚àû' : total} used</div>
      </td>
      <td><span class="status-badge ${statusClass}">${statusText}</span></td>
      <td><span class="expiry-date ${expiryClass}">${expiryText}</span></td>
      <td>${gift.createdAt?.toDate?.()?.toLocaleDateString() || 'N/A'}</td>
      <td>
        <div class="action-btns">
          <button class="action-btn" onclick="viewGift('${gift.id}')" title="View Details">
            <i class="fas fa-eye"></i>
          </button>
          <button class="action-btn edit" onclick="editGift('${gift.id}')" title="Edit">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn delete" onclick="deleteGift('${gift.id}', '${gift.code}')" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  renderPagination(filtered.length);
}

// ========== FILTER GIFTS ==========
function filterGifts() {
  let filtered = [...allGifts];
  
  // Search filter
  if (searchQuery) {
    filtered = filtered.filter(gift => 
      gift.code?.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }
  
  // Status filter
  if (currentFilter !== 'all') {
    const now = new Date();
    filtered = filtered.filter(gift => {
      const expiryDate = gift.expiresAt?.toDate?.() || null;
      const isExpired = expiryDate && expiryDate < now;
      const used = gift.usedCount || 0;
      const total = gift.totalUses || 0;
      
      switch (currentFilter) {
        case 'active':
          return !isExpired && gift.isActive && used < total;
        case 'expired':
          return isExpired || !gift.isActive;
        case 'full':
          return used >= total && total > 0;
        default:
          return true;
      }
    });
  }
  
  // Period filter
  if (currentPeriod !== 'all') {
    const now = new Date();
    filtered = filtered.filter(gift => {
      const date = gift.createdAt?.toDate?.() || new Date();
      const diff = now - date;
      const days = diff / (1000 * 60 * 60 * 24);
      
      switch (currentPeriod) {
        case 'today':
          return days <= 1;
        case 'week':
          return days <= 7;
        case 'month':
          return days <= 30;
        default:
          return true;
      }
    });
  }
  
  // Sort
  filtered.sort((a, b) => {
    switch (currentSort) {
      case 'oldest':
        return (a.createdAt?.toMillis?.() || 0) - (b.createdAt?.toMillis?.() || 0);
      case 'amount_high':
        return (b.amount || 0) - (a.amount || 0);
      case 'amount_low':
        return (a.amount || 0) - (b.amount || 0);
      case 'claims_high':
        return (b.usedCount || 0) - (a.usedCount || 0);
      default: // newest
        return (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0);
    }
  });
  
  return filtered;
}

// ========== RENDER PAGINATION ==========
function renderPagination(totalItems) {
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const pagination = document.getElementById('pagination');
  
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let html = `
    <button class="page-btn" onclick="changePage('prev')" ${currentPage === 1 ? 'disabled' : ''}>‚Üê</button>
  `;
  
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
      html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
    } else if (i === currentPage - 2 || i === currentPage + 2) {
      html += `<button class="page-btn" disabled>...</button>`;
    }
  }
  
  html += `
    <button class="page-btn" onclick="changePage('next')" ${currentPage === totalPages ? 'disabled' : ''}>‚Üí</button>
  `;
  
  pagination.innerHTML = html;
}

// ========== CHANGE PAGE ==========
function changePage(direction) {
  const totalItems = filterGifts().length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  
  if (direction === 'prev') {
    currentPage = Math.max(1, currentPage - 1);
  } else if (direction === 'next') {
    currentPage = Math.min(totalPages, currentPage + 1);
  } else {
    currentPage = direction;
  }
  
  renderGifts();
}

// ========== FILTER FUNCTIONS ==========
function filterByPeriod(period) {
  currentPeriod = period;
  currentPage = 1;
  
  // Update active button
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  renderGifts();
}

function searchGifts() {
  searchQuery = document.getElementById('searchInput').value;
  currentPage = 1;
  renderGifts();
}

// ========== INITIALIZE CHARTS ==========
function initializeCharts() {
  // Claims Chart
  const claimsCtx = document.getElementById('claimsChart').getContext('2d');
  claimsChart = new Chart(claimsCtx, {
    type: 'line',
    data: {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [{
        label: 'Claims',
        data: [0, 0, 0, 0, 0, 0, 0],
        borderColor: '#FF6B6B',
        backgroundColor: 'rgba(255, 107, 107, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#FF6B6B',
        pointBorderColor: 'white',
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  
  // Amounts Chart
  const amountsCtx = document.getElementById('amountsChart').getContext('2d');
  amountsChart = new Chart(amountsCtx, {
    type: 'doughnut',
    data: {
      labels: ['‚Ç¶100', '‚Ç¶200', '‚Ç¶500', '‚Ç¶1000', 'Other'],
      datasets: [{
        data: [0, 0, 0, 0, 0],
        backgroundColor: [
          '#FF6B6B',
          '#FF8E53',
          '#FFD700',
          '#00C48C',
          '#0052FF'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
  
  updateCharts();
}

// ========== UPDATE CHARTS ==========
function updateCharts() {
  if (!claimsChart || !amountsChart) return;
  
  // Update claims chart with real data
  const last7Days = [];
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    date.setHours(0, 0, 0, 0);
    
    const nextDay = new Date(date);
    nextDay.setDate(nextDay.getDate() + 1);
    
    const claimsCount = allClaims.filter(claim => {
      const claimDate = claim.claimedAt?.toDate?.();
      return claimDate && claimDate >= date && claimDate < nextDay;
    }).length;
    
    last7Days.push(claimsCount);
  }
  
  claimsChart.data.datasets[0].data = last7Days;
  claimsChart.update();
  
  // Update amounts chart
  const amounts = {
    '100': 0,
    '200': 0,
    '500': 0,
    '1000': 0,
    'other': 0
  };
  
  allClaims.forEach(claim => {
    const amount = claim.amount || 0;
    if (amount === 100) amounts['100']++;
    else if (amount === 200) amounts['200']++;
    else if (amount === 500) amounts['500']++;
    else if (amount === 1000) amounts['1000']++;
    else amounts['other']++;
  });
  
  amountsChart.data.datasets[0].data = [
    amounts['100'],
    amounts['200'],
    amounts['500'],
    amounts['1000'],
    amounts['other']
  ];
  amountsChart.update();
}

// ========== MODAL FUNCTIONS ==========
function openCreateModal() {
  document.getElementById('modalTitle').textContent = 'Create New Gift';
  document.getElementById('saveBtnText').textContent = 'Create Gift';
  document.getElementById('giftCode').value = '';
  document.getElementById('giftAmount').value = '';
  document.getElementById('giftUses').value = '50';
  document.getElementById('giftUnlimited').checked = true;
  document.getElementById('giftStatus').value = 'true';
  
  // Set default expiry to 30 days from now
  const defaultExpiry = new Date();
  defaultExpiry.setDate(defaultExpiry.getDate() + 30);
  document.getElementById('giftExpiry').value = defaultExpiry.toISOString().slice(0, 16);
  
  document.getElementById('giftModal').classList.add('active');
  
  // Add input listeners for preview
  setupPreviewListeners();
  updatePreview();
}

function openEditModal(gift) {
  document.getElementById('modalTitle').textContent = 'Edit Gift';
  document.getElementById('saveBtnText').textContent = 'Save Changes';
  document.getElementById('giftCode').value = gift.code || '';
  document.getElementById('giftAmount').value = gift.amount || '';
  document.getElementById('giftUses').value = gift.totalUses || '50';
  document.getElementById('giftUnlimited').checked = gift.totalUses === 0;
  document.getElementById('giftStatus').value = gift.isActive ? 'true' : 'false';
  
  if (gift.expiresAt) {
    const date = gift.expiresAt.toDate();
    document.getElementById('giftExpiry').value = date.toISOString().slice(0, 16);
  } else {
    const defaultExpiry = new Date();
    defaultExpiry.setDate(defaultExpiry.getDate() + 30);
    document.getElementById('giftExpiry').value = defaultExpiry.toISOString().slice(0, 16);
  }
  
  document.getElementById('giftModal').classList.add('active');
  
  // Add input listeners for preview
  setupPreviewListeners();
  updatePreview();
}

function setupPreviewListeners() {
  document.getElementById('giftCode').addEventListener('input', updatePreview);
  document.getElementById('giftAmount').addEventListener('input', updatePreview);
  document.getElementById('giftUses').addEventListener('input', updatePreview);
  document.getElementById('giftExpiry').addEventListener('change', updatePreview);
  document.getElementById('giftUnlimited').addEventListener('change', updatePreview);
}

function updatePreview() {
  const code = document.getElementById('giftCode').value || 'CODE';
  const amount = document.getElementById('giftAmount').value || 0;
  const uses = document.getElementById('giftUses').value || 0;
  const unlimited = document.getElementById('giftUnlimited').checked;
  const expiry = document.getElementById('giftExpiry').value;
  
  document.getElementById('previewCode').textContent = code.toUpperCase();
  document.getElementById('previewAmount').textContent = `‚Ç¶${Number(amount).toLocaleString()}`;
  
  const usesText = unlimited ? '‚àû unlimited' : `${uses} uses`;
  document.getElementById('previewUses').textContent = usesText;
  
  if (expiry) {
    const expiryDate = new Date(expiry);
    document.getElementById('previewExpiry').textContent = `Expires: ${expiryDate.toLocaleDateString()}`;
  } else {
    document.getElementById('previewExpiry').textContent = 'Expires: Never';
  }
}

function closeModal() {
  document.getElementById('giftModal').classList.remove('active');
}

function closeViewModal() {
  document.getElementById('viewGiftModal').classList.remove('active');
}

// ========== SAVE GIFT ==========
async function saveGift() {
  const code = document.getElementById('giftCode').value.trim().toUpperCase();
  const amount = parseFloat(document.getElementById('giftAmount').value);
  const uses = parseInt(document.getElementById('giftUses').value);
  const unlimited = document.getElementById('giftUnlimited').checked;
  const isActive = document.getElementById('giftStatus').value === 'true';
  const expiryStr = document.getElementById('giftExpiry').value;
  
  // Validation
  if (!code) {
    showToast('error', 'Validation Error', 'Please enter a gift code');
    return;
  }
  
  if (!amount || amount < 10) {
    showToast('error', 'Validation Error', 'Amount must be at least ‚Ç¶10');
    return;
  }
  
  if (!unlimited && (!uses || uses < 1)) {
    showToast('error', 'Validation Error', 'Please enter valid number of uses');
    return;
  }
  
  if (!expiryStr) {
    showToast('error', 'Validation Error', 'Please select an expiry date');
    return;
  }
  
  const expiryDate = new Date(expiryStr);
  if (expiryDate < new Date()) {
    showToast('error', 'Validation Error', 'Expiry date must be in the future');
    return;
  }
  
  // Check if code already exists (for new gifts)
  const isEditing = document.getElementById('modalTitle').textContent.includes('Edit');
  if (!isEditing) {
    const existing = allGifts.find(g => g.code === code);
    if (existing) {
      showToast('error', 'Validation Error', 'Gift code already exists');
      return;
    }
  }
  
  // Show loading
  Swal.fire({
    title: 'Saving...',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });
  
  try {
    const giftData = {
      code: code,
      amount: amount,
      totalUses: unlimited ? 0 : uses,
      usedCount: 0,
      isActive: isActive,
      expiresAt: expiryDate,
      updatedAt: FieldValue.serverTimestamp()
    };
    
    if (isEditing) {
      // Get current gift ID
      const giftId = editingGiftId; // We need to store this when editing
      await db.collection('gifts').doc(giftId).update(giftData);
      showToast('success', 'Success', 'Gift updated successfully');
    } else {
      giftData.createdAt = FieldValue.serverTimestamp();
      await db.collection('gifts').add(giftData);
      showToast('success', 'Success', 'Gift created successfully');
    }
    
    closeModal();
    await loadAllData();
    
  } catch (error) {
    console.error('Save error:', error);
    showToast('error', 'Error', 'Failed to save gift');
  }
  
  Swal.close();
}

// ========== VIEW GIFT DETAILS ==========
async function viewGift(giftId) {
  const gift = allGifts.find(g => g.id === giftId);
  if (!gift) return;
  
  // Get claims for this gift
  const claims = allClaims.filter(c => c.giftId === giftId);
  
  // Get users who claimed
  const userPromises = claims.map(c => 
    db.collection('users').doc(c.userId).get()
  );
  const userSnaps = await Promise.all(userPromises);
  
  let claimsHtml = '';
  claims.forEach((claim, index) => {
    const user = userSnaps[index]?.data();
    const date = claim.claimedAt?.toDate?.() || new Date();
    
    claimsHtml += `
      <div style="padding:10px; border-bottom:1px solid var(--border);">
        <div style="display:flex; justify-content:space-between;">
          <div>
            <strong>${user?.fullName || user?.username || 'Unknown'}</strong>
            <div style="font-size:11px; color:var(--muted);">${user?.email || ''}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:700; color:var(--success);">‚Ç¶${claim.amount}</div>
            <div style="font-size:10px; color:var(--muted);">${date.toLocaleString()}</div>
          </div>
        </div>
      </div>
    `;
  });
  
  if (claims.length === 0) {
    claimsHtml = '<p style="text-align:center; color:var(--muted);">No claims yet</p>';
  }
  
  const html = `
    <div style="margin-bottom:20px;">
      <div style="background:var(--bg); border-radius:16px; padding:20px;">
        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:15px;">
          <div>
            <div style="font-size:11px; color:var(--muted);">Gift Code</div>
            <div style="font-size:20px; font-weight:800; color:var(--primary);">${gift.code}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted);">Amount</div>
            <div style="font-size:20px; font-weight:800; color:var(--success);">‚Ç¶${gift.amount}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted);">Uses</div>
            <div style="font-size:16px; font-weight:700;">${gift.usedCount || 0} / ${gift.totalUses || '‚àû'}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted);">Status</div>
            <span class="status-badge ${gift.isActive ? 'status-active' : 'status-expired'}">
              ${gift.isActive ? 'Active' : 'Inactive'}
            </span>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted);">Created</div>
            <div>${gift.createdAt?.toDate?.()?.toLocaleString() || 'N/A'}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted);">Expires</div>
            <div>${gift.expiresAt?.toDate?.()?.toLocaleString() || 'Never'}</div>
          </div>
        </div>
      </div>
      
      <h3 style="margin:20px 0 10px;">Claim History (${claims.length})</h3>
      <div style="background:white; border-radius:16px; border:1px solid var(--border); max-height:300px; overflow-y:auto;">
        ${claimsHtml}
      </div>
    </div>
  `;
  
  document.getElementById('viewGiftDetails').innerHTML = html;
  document.getElementById('viewGiftModal').classList.add('active');
}

// ========== EDIT GIFT ==========
let editingGiftId = null;

function editGift(giftId) {
  const gift = allGifts.find(g => g.id === giftId);
  if (!gift) return;
  
  editingGiftId = giftId;
  openEditModal(gift);
}

// ========== DELETE GIFT ==========
async function deleteGift(giftId, giftCode) {
  const result = await Swal.fire({
    title: 'Delete Gift?',
    html: `
      <div style="text-align:center;">
        <p>Are you sure you want to delete gift code:</p>
        <p style="font-size:24px; font-weight:800; color:var(--danger);">${giftCode}</p>
        <p style="color:var(--muted); font-size:13px;">This action cannot be undone.</p>
      </div>
    `,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, Delete',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#FF4D6D',
    cancelButtonColor: '#6B7A99'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    await db.collection('gifts').doc(giftId).delete();
    showToast('success', 'Deleted', 'Gift code deleted successfully');
    await loadAllData();
  } catch (error) {
    console.error('Delete error:', error);
    showToast('error', 'Error', 'Failed to delete gift');
  }
}

// ========== EXPORT GIFTS ==========
function exportGifts() {
  const data = {
    exportDate: new Date().toISOString(),
    totalGifts: allGifts.length,
    totalClaims: allClaims.length,
    totalValue: allGifts.reduce((sum, g) => sum + (g.amount || 0), 0),
    gifts: allGifts,
    claims: allClaims
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `gifts_export_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  
  showToast('success', 'Exported', 'Gift data exported successfully');
}

// ========== TOAST NOTIFICATION ==========
function showToast(type, title, message) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <div style="flex:1;">
      <div style="font-weight:700; margin-bottom:2px;">${title}</div>
      <div style="font-size:12px; opacity:0.8;">${message}</div>
    </div>
    <button onclick="this.parentElement.remove()" style="background:none; border:none; cursor:pointer; color:var(--muted);">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 5000);
}

// ========== SETUP FILTER LISTENERS ==========
document.getElementById('statusFilter').addEventListener('change', function() {
  currentFilter = this.value;
  currentPage = 1;
  renderGifts();
});

document.getElementById('sortFilter').addEventListener('change', function() {
  currentSort = this.value;
  renderGifts();
});
</script>
</body>
</html>

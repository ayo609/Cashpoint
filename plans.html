<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cashpoint | Investment Plans</title>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script src="cashpoint-modal.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #0052FF;
  --primary-dark: #0039b3;
  --accent: #00D4A0;
  --success: #00C48C;
  --warning: #FFB800;
  --danger: #FF4D6D;
  --bg: #F0F4FF;
  --text: #0D1B3E;
  --muted: #6B7A99;
  --border: #D8E0F0;
  --nav-h: 70px;
  --bottom-h: 72px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  padding-bottom: calc(var(--bottom-h) + 20px);
  overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â• */
.topbar {
  position: sticky;
  top: 0;
  z-index: 900;
  height: var(--nav-h);
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(18px);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}
.topbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.back-btn {
  width: 38px;
  height: 38px;
  border-radius: 11px;
  background: var(--bg);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: var(--muted);
  text-decoration: none;
  transition: all 0.2s;
}
.back-btn:hover {
  background: var(--border);
}
.topbar-title {
  font-family: 'Sora', sans-serif;
  font-size: 20px;
  font-weight: 800;
}

/* â•â•â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â•â•â• */
.hero {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 55%, #001c6b 100%);
  padding: 28px 22px 80px;
  position: relative;
  overflow: hidden;
}
.hero::before {
  content: '';
  position: absolute;
  width: 360px;
  height: 360px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.05);
  top: -100px;
  right: -80px;
}
.hero-content {
  position: relative;
  z-index: 1;
  max-width: 1200px;
  margin: 0 auto;
}
.hero-tag {
  font-size: 12px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.7);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}
.hero-title {
  font-family: 'Sora', sans-serif;
  font-size: clamp(26px, 6vw, 36px);
  font-weight: 800;
  color: white;
  line-height: 1.2;
  margin-bottom: 12px;
}
.hero-desc {
  font-size: 15px;
  color: rgba(255, 255, 255, 0.85);
  line-height: 1.6;
  max-width: 500px;
}

/* â•â•â•â•â•â•â•â•â•â• BALANCE CARD â•â•â•â•â•â•â•â•â•â• */
.balance-card {
  background: white;
  border-radius: 20px;
  padding: 20px;
  margin: -50px 20px 20px;
  box-shadow: 0 10px 40px rgba(0, 82, 255, 0.12);
  border: 1px solid var(--border);
  position: relative;
  z-index: 10;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}
.balance-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 700;
  text-transform: uppercase;
  margin-bottom: 8px;
}
.balance-amount {
  font-family: 'Sora', sans-serif;
  font-size: 32px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 4px;
}
.balance-note {
  font-size: 12px;
  color: var(--muted);
}

/* â•â•â•â•â•â•â•â•â•â• PLANS GRID â•â•â•â•â•â•â•â•â•â• */
.plans-section {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}
.section-title {
  font-family: 'Sora', sans-serif;
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 20px;
  color: var(--text);
}
.plans-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
}

/* â•â•â•â•â•â•â•â•â•â• PLAN CARD â•â•â•â•â•â•â•â•â•â• */
.plan-card {
  background: white;
  border-radius: 18px;
  overflow: hidden;
  border: 2px solid var(--border);
  transition: all 0.3s;
  cursor: pointer;
  position: relative;
}
.plan-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 35px rgba(0, 82, 255, 0.15);
  border-color: var(--primary);
}
.plan-image {
  width: 100%;
  height: 160px;
  object-fit: cover;
  background: linear-gradient(135deg, var(--bg), #e0e8ff);
}
.plan-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 6px 12px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 800;
  color: var(--primary);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.plan-content {
  padding: 20px;
}
.plan-name {
  font-family: 'Sora', sans-serif;
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 12px;
  color: var(--text);
}
.plan-price {
  font-family: 'Sora', sans-serif;
  font-size: 28px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 16px;
}
.plan-stats {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 16px;
}
.plan-stat {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  background: var(--bg);
  border-radius: 10px;
}
.stat-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 700;
}
.stat-value {
  font-size: 14px;
  font-weight: 800;
  color: var(--text);
}
.stat-value.green {
  color: var(--success);
}
.invest-btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  font-size: 15px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}
.invest-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 82, 255, 0.3);
}

/* â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--bottom-h);
  background: white;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0 20px;
  z-index: 800;
  box-shadow: 0 -4px 20px rgba(0, 82, 255, 0.06);
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  color: var(--muted);
  text-decoration: none;
  font-size: 11px;
  font-weight: 700;
  transition: all 0.2s;
  padding: 8px 12px;
  border-radius: 12px;
  min-width: 60px;
}
.nav-item i {
  font-size: 20px;
}
.nav-item.active {
  color: var(--primary);
}
.nav-center {
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
  text-decoration: none;
  box-shadow: 0 6px 20px rgba(0, 82, 255, 0.3);
  margin-bottom: 10px;
}

/* â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .plans-grid {
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
  }
  .balance-card {
    margin: -40px 16px 16px;
    padding: 18px;
  }
  .balance-amount {
    font-size: 28px;
  }
}

@media (max-width: 480px) {
  .plans-grid {
    grid-template-columns: 1fr;
  }
  .plans-section {
    padding: 16px;
  }
  .plan-image {
    height: 140px;
  }
  .balance-card {
    margin: -35px 12px 12px;
  }
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-left">
    <a href="home.html" class="back-btn">
      <i class="fas fa-arrow-left"></i>
    </a>
    <div class="topbar-title">ğŸ“ˆ Investment Plans</div>
  </div>
</div>

<!-- HERO -->
<div class="hero">
  <div class="hero-content">
    <div class="hero-tag">ğŸ’ Premium Returns</div>
    <div class="hero-title">Choose Your Investment Plan</div>
    <div class="hero-desc">
      18 plans designed for every investor. Start with â‚¦3,000 and earn daily returns for 30 days.
    </div>
  </div>
</div>

<!-- BALANCE CARD -->
<div class="balance-card">
  <div class="balance-label">ğŸ’° Available Balance</div>
  <div class="balance-amount" id="userBalance">â‚¦0.00</div>
  <div class="balance-note">Select a plan below to start investing</div>
</div>

<!-- PLANS SECTION -->
<div class="plans-section">
  <div class="section-title">All Investment Plans</div>
  <div class="plans-grid" id="plansGrid">
    <!-- Plans will be loaded here by JavaScript -->
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <a href="home.html" class="nav-item">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </a>
  <a href="plans.html" class="nav-item active">
    <i class="fas fa-chart-line"></i>
    <span>Plans</span>
  </a>
  <a href="investments.html" class="nav-center">
    <i class="fas fa-wallet"></i>
  </a>
  <a href="referrals.html" class="nav-item">
    <i class="fas fa-users"></i>
    <span>Referrals</span>
  </a>
  <a href="dashboard.html" class="nav-item">
    <i class="fas fa-user-circle"></i>
    <span>Profile</span>
  </a>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const firebaseConfig = {
  apiKey: "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
  authDomain: "cashpoint-ac4f4.firebaseapp.com",
  projectId: "cashpoint-ac4f4",
  storageBucket: "cashpoint-ac4f4.firebasestorage.app",
  messagingSenderId: "16133206416",
  appId: "1:16133206416:web:a093f4e153ad2c9bcc8315"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let userBalance = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REFERRAL COMMISSION RATES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const REFERRAL_RATES = {
  1: 0.25,  // Level 1: 25% to direct referrer
  2: 0.02,  // Level 2: 2% to referrer's referrer
  3: 0.01   // Level 3: 1% to level 2's referrer
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVESTMENT PLANS DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const plans = [
  {
    name: 'Basic',
    capital: 3000,
    dailyROI: 500,
    totalReturn: 15000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=400&h=300&fit=crop'
  },
  {
    name: 'Starter',
    capital: 5000,
    dailyROI: 1000,
    totalReturn: 30000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1642790106117-e829e14a795f?w=400&h=300&fit=crop'
  },
  {
    name: 'Standard',
    capital: 7000,
    dailyROI: 1500,
    totalReturn: 45000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=400&h=300&fit=crop'
  },
  {
    name: 'Bronze',
    capital: 10000,
    dailyROI: 2000,
    totalReturn: 60000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1639762681485-074b7f938ba0?w=400&h=300&fit=crop',
    badge: 'ğŸ¥‰ Bronze'
  },
  {
    name: 'Silver',
    capital: 15000,
    dailyROI: 3000,
    totalReturn: 90000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1621981386829-9b458a2cddde?w=400&h=300&fit=crop',
    badge: 'ğŸ¥ˆ Silver'
  },
  {
    name: 'Gold',
    capital: 20000,
    dailyROI: 4000,
    totalReturn: 120000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1610375461246-83df859d849d?w=400&h=300&fit=crop',
    badge: 'ğŸ¥‡ Gold'
  },
  {
    name: 'Platinum',
    capital: 25000,
    dailyROI: 5000,
    totalReturn: 150000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1621981386829-9b458a2cddde?w=400&h=300&fit=crop',
    badge: 'ğŸ’ Platinum'
  },
  {
    name: 'Diamond',
    capital: 30000,
    dailyROI: 6000,
    totalReturn: 180000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1603561596112-0a132b757442?w=400&h=300&fit=crop',
    badge: 'ğŸ’ Diamond'
  },
  {
    name: 'Elite',
    capital: 50000,
    dailyROI: 10000,
    totalReturn: 300000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1634704784915-aacf363b021f?w=400&h=300&fit=crop',
    badge: 'â­ Elite'
  },
  {
    name: 'Premium',
    capital: 70000,
    dailyROI: 15000,
    totalReturn: 450000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1559526324-4b87b5e36e44?w=400&h=300&fit=crop',
    badge: 'â­ Premium'
  },
  {
    name: 'Executive',
    capital: 100000,
    dailyROI: 20000,
    totalReturn: 600000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1642790106117-e829e14a795f?w=400&h=300&fit=crop',
    badge: 'ğŸ‘‘ Executive'
  },
  {
    name: 'Professional',
    capital: 150000,
    dailyROI: 30000,
    totalReturn: 900000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=400&h=300&fit=crop',
    badge: 'ğŸ‘‘ Professional'
  },
  {
    name: 'Master',
    capital: 200000,
    dailyROI: 40000,
    totalReturn: 1200000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1639762681485-074b7f938ba0?w=400&h=300&fit=crop',
    badge: 'ğŸ‘‘ Master'
  },
  {
    name: 'Prestige',
    capital: 300000,
    dailyROI: 60000,
    totalReturn: 1800000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1621981386829-9b458a2cddde?w=400&h=300&fit=crop',
    badge: 'ğŸŒŸ Prestige'
  },
  {
    name: 'Signature',
    capital: 400000,
    dailyROI: 80000,
    totalReturn: 2400000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1610375461246-83df859d849d?w=400&h=300&fit=crop',
    badge: 'ğŸŒŸ Signature'
  },
  {
    name: 'Imperial',
    capital: 500000,
    dailyROI: 100000,
    totalReturn: 3000000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1603561596112-0a132b757442?w=400&h=300&fit=crop',
    badge: 'ğŸ‘‘ Imperial'
  },
  {
    name: 'Royal',
    capital: 700000,
    dailyROI: 150000,
    totalReturn: 4500000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1634704784915-aacf363b021f?w=400&h=300&fit=crop',
    badge: 'ğŸ‘‘ Royal'
  },
  {
    name: 'Ultimate',
    capital: 1000000,
    dailyROI: 200000,
    totalReturn: 6000000,
    duration: 30,
    image: 'https://images.unsplash.com/photo-1559526324-4b87b5e36e44?w=400&h=300&fit=crop',
    badge: 'ğŸ”¥ Ultimate'
  }
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPER FUNCTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const fmtN = (n) => {
  return Number(n || 0).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH CHECK & LOAD USER DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }
  currentUser = user;
  await loadUserData();
  renderPlans();
});

async function loadUserData() {
  try {
    // First, claim any pending referral credits
    await claimPendingReferralCredits(currentUser.uid);
    
    // Then load current balance
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if (userDoc.exists) {
      const data = userDoc.data();
      userBalance = data.balance || 0;
      document.getElementById('userBalance').textContent = 'â‚¦' + fmtN(userBalance);
    }
  } catch (err) {
    console.error('Error loading user data:', err);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER PLANS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPlans() {
  const grid = document.getElementById('plansGrid');
  grid.innerHTML = '';

  plans.forEach(plan => {
    const card = document.createElement('div');
    card.className = 'plan-card';
    card.onclick = () => selectPlan(plan);

    card.innerHTML = `
      <img src="${plan.image}" alt="${plan.name}" class="plan-image" />
      ${plan.badge ? `<div class="plan-badge">${plan.badge}</div>` : ''}
      <div class="plan-content">
        <div class="plan-name">${plan.name}</div>
        <div class="plan-price">â‚¦${fmtN(plan.capital)}</div>
        <div class="plan-stats">
          <div class="plan-stat">
            <span class="stat-label">Daily ROI</span>
            <span class="stat-value green">â‚¦${fmtN(plan.dailyROI)}</span>
          </div>
          <div class="plan-stat">
            <span class="stat-label">Total Return</span>
            <span class="stat-value">â‚¦${fmtN(plan.totalReturn)}</span>
          </div>
          <div class="plan-stat">
            <span class="stat-label">Duration</span>
            <span class="stat-value">${plan.duration} Days</span>
          </div>
        </div>
        <button class="invest-btn">
          <i class="fas fa-bolt"></i>
          Invest Now
        </button>
      </div>
    `;

    grid.appendChild(card);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SELECT PLAN & INVEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function selectPlan(plan) {
  const result = await Swal.fire({
    title: `Invest in ${plan.name} Plan?`,
    html: `
      <div style="text-align:left;padding:10px;">
        <div style="background:#F0F4FF;border-radius:12px;padding:16px;margin-bottom:16px;">
          <div style="font-size:14px;font-weight:700;color:#0D1B3E;margin-bottom:12px;">Investment Details:</div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="color:#6B7A99;font-size:13px;">Capital:</span>
            <span style="font-weight:800;color:#0D1B3E;">â‚¦${fmtN(plan.capital)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="color:#6B7A99;font-size:13px;">Daily ROI:</span>
            <span style="font-weight:800;color:#00C48C;">â‚¦${fmtN(plan.dailyROI)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="color:#6B7A99;font-size:13px;">Total Return:</span>
            <span style="font-weight:800;color:#0052FF;">â‚¦${fmtN(plan.totalReturn)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;">
            <span style="color:#6B7A99;font-size:13px;">Duration:</span>
            <span style="font-weight:800;color:#0D1B3E;">${plan.duration} Days</span>
          </div>
        </div>
        <div style="background:#E8FFF6;border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid #00C48C;">
          <div style="font-size:12px;color:#00C48C;font-weight:700;margin-bottom:4px;">YOUR BALANCE</div>
          <div style="font-size:20px;font-weight:800;color:#00875A;">â‚¦${fmtN(userBalance)}</div>
        </div>
        ${userBalance < plan.capital ? `
          <div style="background:#FFF0F3;border:1px solid #FF4D6D;border-radius:12px;padding:12px;margin-top:12px;">
            <div style="color:#FF4D6D;font-size:13px;font-weight:700;">
              âš ï¸ Insufficient Balance
            </div>
            <div style="color:#6B7A99;font-size:12px;margin-top:4px;">
              You need â‚¦${fmtN(plan.capital - userBalance)} more to invest in this plan.
            </div>
          </div>
        ` : ''}
      </div>
    `,
    icon: userBalance >= plan.capital ? 'question' : 'warning',
    showCancelButton: true,
    confirmButtonText: userBalance >= plan.capital ? 'Confirm Investment' : 'Deposit Funds',
    cancelButtonText: 'Cancel',
    confirmButtonColor: userBalance >= plan.capital ? '#0052FF' : '#00C48C',
    cancelButtonColor: '#6B7A99'
  });

  if (!result.isConfirmed) return;

  if (userBalance < plan.capital) {
    window.location.href = 'deposit.html';
    return;
  }

  await processInvestment(plan);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAY REFERRAL BONUSES - 3 LEVELS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Walks up the referral chain and pays:
   - Level 1 (direct referrer): 25%
   - Level 2 (referrer's referrer): 2%
   - Level 3 (level 2's referrer): 1%
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function payReferralBonuses(buyerUid, amount, planName, investmentId) {
  console.log('[Referral] Starting bonus distribution for:', buyerUid, 'Amount:', amount);
  
  const FV = firebase.firestore.FieldValue;
  const now = FV.serverTimestamp();
  let currentUid = buyerUid;

  for (let level = 1; level <= 3; level++) {
    try {
      // Get current user's referrer
      const userDoc = await db.collection('users').doc(currentUid).get();
      if (!userDoc.exists) {
        console.log(`[Referral L${level}] User ${currentUid} not found - stopping`);
        break;
      }

      const uplineUid = userDoc.data().referrerUid;
      if (!uplineUid || uplineUid === 'direct' || uplineUid === '') {
        console.log(`[Referral L${level}] No upline found - chain ends`);
        break;
      }

      // Calculate bonus amount
      const rate = REFERRAL_RATES[level];
      const bonus = Math.floor(amount * rate);
      
      if (bonus <= 0) {
        currentUid = uplineUid;
        continue;
      }

      console.log(`[Referral L${level}] Paying â‚¦${bonus} (${rate * 100}%) to ${uplineUid}`);

      // Try direct credit first
      let directCreditSuccess = false;
      try {
        await db.collection('users').doc(uplineUid).update({
          balance: FV.increment(bonus),
          totalEarnings: FV.increment(bonus),
          totalRefEarnings: FV.increment(bonus)
        });
        directCreditSuccess = true;
        console.log(`[Referral L${level}] âœ… Direct credit successful`);
      } catch (directErr) {
        console.warn(`[Referral L${level}] Direct credit blocked - using queue`);
      }

      // Write to referral_credits (escrow queue)
      await db.collection('referral_credits').add({
        uplineUid: uplineUid,
        buyerUid: buyerUid,
        investmentId: investmentId || '',
        planName: planName,
        investAmount: amount,
        bonusAmount: bonus,
        level: level,
        ratePercent: rate * 100,
        claimed: directCreditSuccess,
        createdAt: now
      });

      // Write audit log
      try {
        await db.collection('referral_bonuses').add({
          uplineUid: uplineUid,
          buyerUid: buyerUid,
          investmentId: investmentId || '',
          planName: planName,
          investAmount: amount,
          bonusAmount: bonus,
          level: level,
          ratePercent: rate * 100,
          createdAt: now
        });
      } catch (auditErr) {
        console.warn(`[Referral L${level}] Audit log failed:`, auditErr.message);
      }

      // Create transaction record for upline
      try {
        await db.collection('transactions').add({
          userId: uplineUid,
          type: 'referral_bonus',
          amount: bonus,
          note: `Level ${level} referral bonus from ${planName} investment`,
          createdAt: now
        });
      } catch (txErr) {
        console.warn(`[Referral L${level}] Transaction log failed:`, txErr.message);
      }

      // Move to next level
      currentUid = uplineUid;

    } catch (levelErr) {
      console.error(`[Referral L${level}] Error:`, levelErr);
      // Try to continue chain even if this level failed
      try {
        const nextDoc = await db.collection('users').doc(currentUid).get();
        const nextUid = nextDoc.exists ? nextDoc.data().referrerUid : null;
        if (nextUid && nextUid !== 'direct') {
          currentUid = nextUid;
        } else {
          break;
        }
      } catch (e) {
        break;
      }
    }
  }

  console.log('[Referral] âœ… Bonus distribution complete');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLAIM PENDING REFERRAL CREDITS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Called on page load to claim any pending credits from
   the referral_credits queue
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function claimPendingReferralCredits(userUid) {
  try {
    const snapshot = await db.collection('referral_credits')
      .where('uplineUid', '==', userUid)
      .where('claimed', '==', false)
      .get();

    if (snapshot.empty) return 0;

    console.log(`[Credits] Found ${snapshot.size} unclaimed credits`);

    let totalClaimed = 0;
    const batch = db.batch();

    snapshot.docs.forEach(doc => {
      const data = doc.data();
      totalClaimed += data.bonusAmount || 0;
      batch.update(doc.ref, { claimed: true });
    });

    // Update user balance
    const userRef = db.collection('users').doc(userUid);
    batch.update(userRef, {
      balance: firebase.firestore.FieldValue.increment(totalClaimed),
      totalEarnings: firebase.firestore.FieldValue.increment(totalClaimed),
      totalRefEarnings: firebase.firestore.FieldValue.increment(totalClaimed)
    });

    await batch.commit();
    console.log(`[Credits] âœ… Claimed â‚¦${totalClaimed}`);
    
    return totalClaimed;
  } catch (err) {
    console.error('[Credits] Claim error:', err);
    return 0;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROCESS INVESTMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function processInvestment(plan) {
  Swal.fire({
    title: 'Processing...',
    text: 'Creating your investment...',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const userRef = db.collection('users').doc(currentUser.uid);
    const userDoc = await userRef.get();
    const userData = userDoc.data();

    // Double-check balance
    if (userData.balance < plan.capital) {
      Swal.fire({
        icon: 'error',
        title: 'Insufficient Balance',
        text: 'Your balance changed. Please refresh and try again.',
        toast: true,
        position: 'top-end',
        timer: 4000,
        showConfirmButton: false
      });
      return;
    }

    // Create investment
    const investmentData = {
      userId: currentUser.uid,
      userName: userData.fullName || userData.username || currentUser.email,
      userEmail: currentUser.email,
      planName: plan.name,
      capital: plan.capital,
      dailyROI: plan.dailyROI,
      totalReturn: plan.totalReturn,
      duration: plan.duration,
      daysRemaining: plan.duration,
      totalEarned: 0,
      status: 'active',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastROIDate: null,
      endDate: new Date(Date.now() + plan.duration * 24 * 60 * 60 * 1000)
    };

    const investmentRef = await db.collection('investments').add(investmentData);
    const investmentId = investmentRef.id;

    // Deduct balance
    await userRef.update({
      balance: firebase.firestore.FieldValue.increment(-plan.capital),
      totalInvested: firebase.firestore.FieldValue.increment(plan.capital)
    });

    // Create transaction record
    await db.collection('transactions').add({
      userId: currentUser.uid,
      userName: userData.fullName || userData.username,
      type: 'investment_purchase',
      amount: plan.capital,
      note: `Purchased ${plan.name} plan`,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Pay referral bonuses (25% + 2% + 1%)
    console.log('[Investment] Starting referral bonus payment...');
    await payReferralBonuses(
      currentUser.uid,
      plan.capital,
      plan.name,
      investmentId
    );
    console.log('[Investment] Referral bonuses paid successfully');

    Swal.fire({
      icon: 'success',
      title: 'Investment Successful!',
      html: `
        <div style="font-size:14px;">
          Your <strong>${plan.name}</strong> plan is now active!<br>
          You'll earn <strong>â‚¦${fmtN(plan.dailyROI)}</strong> daily for ${plan.duration} days.
        </div>
      `,
      toast: true,
      position: 'top-end',
      timer: 4000,
      showConfirmButton: false,
      timerProgressBar: true
    });

    setTimeout(() => {
      window.location.href = 'investments.html';
    }, 1500);

  } catch (err) {
    console.error('Investment error:', err);
    Swal.fire({
      icon: 'error',
      title: 'Investment Failed',
      text: err.message || 'Please try again',
      toast: true,
      position: 'top-end',
      timer: 4000,
      showConfirmButton: false
    });
  }
}
</script>

</body>
</html>

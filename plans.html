<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cashpoint | Investment Plans</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary:       #0052FF;
    --primary-light: #3b7dff;
    --primary-dark:  #0039b3;
    --accent:        #00D4A0;
    --accent-dark:   #00a87e;
    --warning:       #FFB800;
    --danger:        #FF4D6D;
    --success:       #00C48C;
    --bg:            #F0F4FF;
    --card:          #ffffff;
    --text:          #0D1B3E;
    --muted:         #6B7A99;
    --border:        #D8E0F0;
    --nav-h:         70px;
    --bottom-h:      72px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: calc(var(--bottom-h) + 20px);
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â• */
  .topbar {
    position: sticky; top: 0; z-index: 900;
    height: var(--nav-h);
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 0 20px; gap: 12px;
  }
  .topbar-left { display: flex; align-items: center; gap: 10px; }
  .topbar-logo {
    width: 38px; height: 38px; background: var(--primary);
    border-radius: 11px; display: flex; align-items: center;
    justify-content: center; font-size: 20px; flex-shrink: 0;
  }
  .topbar-brand {
    font-family: 'Sora', sans-serif; font-size: 20px;
    font-weight: 700; color: var(--text); letter-spacing: -0.3px;
  }
  .topbar-right { display: flex; align-items: center; gap: 10px; }
  .topbar-clock { font-size: 12.5px; color: var(--muted); font-weight: 600; display: none; }
  @media(min-width:520px){ .topbar-clock { display: block; } }
  .user-avatar {
    width: 38px; height: 38px; border-radius: 11px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 800; font-size: 15px; cursor: pointer;
  }

  /* â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â• */
  .hero {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 55%, #001c6b 100%);
    padding: 28px 22px 96px;
    position: relative; overflow: hidden;
  }
  .hero::before {
    content: ''; position: absolute;
    width: 360px; height: 360px; border-radius: 50%;
    background: rgba(255,255,255,0.05); top: -100px; right: -80px;
  }
  .hero::after {
    content: ''; position: absolute;
    width: 200px; height: 200px; border-radius: 50%;
    background: rgba(0,212,160,0.1); bottom: -60px; left: -40px;
  }
  .hero-tag {
    font-size: 11.5px; font-weight: 700; color: rgba(255,255,255,0.6);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin-bottom: 5px; position: relative; z-index: 1;
  }
  .hero-title {
    font-family: 'Sora', sans-serif; font-size: clamp(22px,5.5vw,30px);
    font-weight: 700; color: #fff; margin-bottom: 6px;
    position: relative; z-index: 1;
  }
  .hero-sub {
    font-size: 13px; color: rgba(255,255,255,0.65);
    font-weight: 500; position: relative; z-index: 1;
  }

  /* â•â•â•â•â•â•â•â• BALANCE CARD â•â•â•â•â•â•â•â• */
  .balance-outer {
    padding: 0 16px; margin-top: -56px; position: relative; z-index: 10;
  }
  .balance-card {
    background: white; border-radius: 22px;
    box-shadow: 0 14px 44px rgba(0,82,255,0.14);
    padding: 18px 22px;
    display: flex; align-items: center;
    justify-content: space-between; gap: 12px; flex-wrap: wrap;
    animation: riseUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
  }
  @keyframes riseUp {
    from { opacity: 0; transform: translateY(22px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .bal-lbl {
    font-size: 11px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px;
  }
  .bal-amount {
    font-family: 'Sora', sans-serif; font-size: clamp(24px,6vw,32px);
    font-weight: 700; color: var(--text); letter-spacing: -1px; line-height: 1;
  }
  .bal-amount .sym { font-size: 15px; color: var(--muted); font-weight: 600; }
  .bal-pill {
    display: inline-flex; align-items: center; gap: 5px;
    background: #E8FFF6; color: var(--success); border-radius: 99px;
    padding: 3px 10px; font-size: 11px; font-weight: 700; margin-top: 7px;
  }
  .dep-btn {
    display: flex; align-items: center; gap: 8px;
    background: var(--primary); color: white; border: none;
    border-radius: 12px; padding: 12px 20px; font-size: 14px;
    font-weight: 700; font-family: inherit; cursor: pointer;
    box-shadow: 0 6px 20px rgba(0,82,255,0.3);
    transition: transform 0.15s, box-shadow 0.15s;
    text-decoration: none; flex-shrink: 0;
  }
  .dep-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,82,255,0.38); }

  /* â•â•â•â•â•â•â•â• REF STRIP â•â•â•â•â•â•â•â• */
  .ref-strip {
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    border-radius: 16px; padding: 14px 18px;
    display: flex; align-items: flex-start; gap: 12px;
    box-shadow: 0 6px 20px rgba(0,212,160,0.22);
    animation: riseUp 0.55s cubic-bezier(0.16,1,0.3,1) both;
  }
  .rs-icon { font-size: 26px; flex-shrink: 0; padding-top: 2px; }
  .rs-title { font-size: 13px; font-weight: 700; color: #fff; margin-bottom: 3px; }
  .rs-sub   { font-size: 11.5px; color: rgba(255,255,255,0.85); font-weight: 500; line-height: 1.4; margin-bottom: 8px; }
  .rs-pills { display: flex; gap: 6px; flex-wrap: wrap; }
  .rs-pill {
    display: inline-block; padding: 3px 11px; border-radius: 99px;
    font-size: 11px; font-weight: 700;
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.35); color: #fff;
  }

  /* â•â•â•â•â•â•â•â• SECTION â•â•â•â•â•â•â•â• */
  .section { padding: 24px 16px 0; }
  .section-head {
    display: flex; align-items: center;
    justify-content: space-between; margin-bottom: 16px;
  }
  .section-title {
    font-family: 'Sora', sans-serif; font-size: 17px;
    font-weight: 700; color: var(--text);
  }
  .section-badge {
    background: white; border: 1.5px solid var(--border);
    border-radius: 99px; padding: 3px 12px;
    font-size: 12px; font-weight: 700; color: var(--muted);
  }

  /* â•â•â•â•â•â•â•â• PLANS GRID â•â•â•â•â•â•â•â• */
  .plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(290px,1fr));
    gap: 16px;
  }
  @media(max-width:480px) { .plans-grid { grid-template-columns: 1fr; } }

  /* â•â•â•â•â•â•â•â• PLAN CARD â•â•â•â•â•â•â•â• */
  .plan-wrapper { position: relative; }
  .popular-ribbon {
    position: absolute; top: -1px; right: 18px; z-index: 5;
    background: var(--danger); color: white;
    padding: 4px 14px 7px; border-radius: 0 0 10px 10px;
    font-size: 10.5px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.07em;
    box-shadow: 0 4px 14px rgba(255,77,109,0.38);
  }
  .plan-card {
    background: white; border-radius: 22px; overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,82,255,0.08);
    transition: transform 0.22s, box-shadow 0.22s;
    animation: riseUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
    display: flex; flex-direction: column;
  }
  .plan-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 16px 40px rgba(0,82,255,0.16);
  }
  .plan-top-bar { height: 5px; width: 100%; }
  .plan-body { padding: 20px; flex: 1; }

  .plan-head-row {
    display: flex; align-items: flex-start;
    justify-content: space-between; gap: 10px; margin-bottom: 14px;
  }
  .plan-name {
    font-family: 'Sora', sans-serif; font-size: 18px;
    font-weight: 700; color: var(--text);
  }
  .plan-badge {
    display: inline-block; padding: 4px 11px; border-radius: 99px;
    font-size: 10.5px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.06em; flex-shrink: 0;
  }

  .plan-invest-lbl {
    font-size: 10.5px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 3px;
  }
  .plan-price {
    font-family: 'Sora', sans-serif; font-size: 30px;
    font-weight: 700; color: var(--text); letter-spacing: -1px; line-height: 1;
    margin-bottom: 14px;
  }
  .plan-price .psym { font-size: 15px; color: var(--muted); font-weight: 600; }

  .plan-rows { display: flex; flex-direction: column; gap: 7px; margin-bottom: 14px; }
  .plan-row {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg); border-radius: 10px; padding: 9px 12px;
  }
  .pr-lbl {
    font-size: 12px; font-weight: 600; color: var(--muted);
    display: flex; align-items: center; gap: 7px;
  }
  .pr-val { font-size: 13.5px; font-weight: 700; color: var(--text); }
  .pr-val.green { color: var(--success); }
  .pr-val.gold  { color: var(--warning); }
  .pr-val.blue  { color: var(--primary); }

  .ref-bonus-section { margin-bottom: 16px; }
  .ref-bonus-lbl {
    font-size: 10.5px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.06em;
    display: flex; align-items: center; gap: 5px; margin-bottom: 6px;
  }
  .ref-pills { display: flex; gap: 6px; flex-wrap: wrap; }
  .ref-pill {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 99px; font-size: 10.5px; font-weight: 700;
  }
  .ref-pill.l1 { background: #E8F0FF; color: var(--primary); }
  .ref-pill.l2 { background: #E8FFF6; color: var(--success); }
  .ref-pill.l3 { background: #FFF8E8; color: var(--warning); }

  .plan-footer { padding: 0 20px 20px; }
  .invest-btn {
    width: 100%; padding: 14px; border: none; border-radius: 14px;
    font-size: 15px; font-weight: 700; font-family: inherit; cursor: pointer;
    color: white; display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: transform 0.15s, filter 0.15s;
  }
  .invest-btn:hover { transform: translateY(-2px); filter: brightness(1.06); }
  .invest-btn:active { transform: translateY(0); }
  .invest-btn.no-funds {
    background: linear-gradient(135deg, #adb5c7, #8a94a8) !important;
    box-shadow: none !important;
  }
  .invest-btn.no-funds:hover { filter: none; transform: none; }

  /* â•â•â•â•â•â•â•â• SKELETON â•â•â•â•â•â•â•â• */
  .skeleton {
    background: linear-gradient(90deg,#e8edf5 25%,#f4f7fc 50%,#e8edf5 75%);
    background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 9px;
  }
  @keyframes shimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
  .skel-card {
    background: white; border-radius: 22px; overflow: hidden;
    box-shadow: 0 4px 16px rgba(0,82,255,0.07); padding: 0;
  }
  .skel-bar { height: 5px; }
  .skel-body { padding: 20px; }

  /* â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â• */
  .bottom-nav {
    position: fixed; bottom: 0; left: 0;
    width: 100%; height: var(--bottom-h);
    background: white; border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-around;
    padding: 0 8px; z-index: 999;
    box-shadow: 0 -4px 24px rgba(0,82,255,0.09);
  }
  .nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    text-decoration: none; padding: 8px 12px; border-radius: 14px;
    flex: 1; max-width: 74px; transition: background 0.2s; cursor: pointer;
  }
  .nav-item:hover { background: var(--bg); }
  .nav-item i { font-size: 20px; color: var(--muted); transition: color 0.2s, transform 0.2s; }
  .nav-item span { font-size: 10.5px; font-weight: 700; color: var(--muted); transition: color 0.2s; }
  .nav-item.active i, .nav-item.active span { color: var(--primary); }
  .nav-item.active i { transform: translateY(-2px); }
  .nav-center {
    width: 52px; height: 52px; border-radius: 16px; background: var(--primary);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 6px 22px rgba(0,82,255,0.38);
    text-decoration: none; transition: transform 0.2s; margin-bottom: 10px; flex-shrink: 0;
  }
  .nav-center:hover { transform: translateY(-3px); }
  .nav-center i { color: white; font-size: 21px; }

  .page-bottom { height: 16px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â• -->
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo">ğŸ’°</div>
    <span class="topbar-brand">Investment Plans</span>
  </div>
  <div class="topbar-right">
    <span class="topbar-clock" id="topClock">--:--</span>
    <div class="user-avatar" id="avatarBox">?</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â•â•â• -->
<div class="hero">
  <div class="hero-tag">Cashpoint Plans</div>
  <div class="hero-title">Choose Your Investment Plan ğŸ“Š</div>
  <div class="hero-sub">Earn daily returns â€” simple, secure, and rewarding</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• BALANCE CARD â•â•â•â•â•â•â•â•â•â• -->
<div class="balance-outer">
  <div class="balance-card">
    <div>
      <div class="bal-lbl">Available Balance</div>
      <div class="bal-amount">
        <span class="sym">â‚¦</span><span id="balanceDisplay">0.00</span>
      </div>
      <div class="bal-pill">
        <i class="fas fa-circle" style="font-size:7px;"></i> Ready to Invest
      </div>
    </div>
    <a href="deposit.html" class="dep-btn">
      <i class="fas fa-plus"></i> Deposit
    </a>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• REFERRAL BONUS STRIP â•â•â•â•â•â•â•â•â•â• -->
<div class="section">
  <div class="ref-strip">
    <div class="rs-icon">ğŸ</div>
    <div>
      <div class="rs-title">Referral Bonuses Paid Instantly on Every Investment</div>
      <div class="rs-sub">When you invest, your upliners are credited automatically</div>
      <div class="rs-pills">
        <span class="rs-pill">Level 1 â†’ 25%</span>
        <span class="rs-pill">Level 2 â†’ 2%</span>
        <span class="rs-pill">Level 3 â†’ 1%</span>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• PLANS â•â•â•â•â•â•â•â•â•â• -->
<div class="section">
  <div class="section-head">
    <div class="section-title">All Plans</div>
    <div class="section-badge">9 Plans</div>
  </div>
  <div class="plans-grid" id="plansGrid">
    <!-- Skeleton cards while loading -->
    <div class="skel-card">
      <div class="skeleton skel-bar"></div>
      <div class="skel-body">
        <div class="skeleton" style="height:16px;width:50%;margin-bottom:10px;"></div>
        <div class="skeleton" style="height:28px;width:55%;margin-bottom:14px;"></div>
        <div class="skeleton" style="height:11px;width:100%;margin-bottom:7px;"></div>
        <div class="skeleton" style="height:11px;width:100%;margin-bottom:7px;"></div>
        <div class="skeleton" style="height:11px;width:80%;margin-bottom:14px;"></div>
        <div class="skeleton" style="height:44px;width:100%;border-radius:14px;"></div>
      </div>
    </div>
    <div class="skel-card">
      <div class="skeleton skel-bar"></div>
      <div class="skel-body">
        <div class="skeleton" style="height:16px;width:44%;margin-bottom:10px;"></div>
        <div class="skeleton" style="height:28px;width:60%;margin-bottom:14px;"></div>
        <div class="skeleton" style="height:11px;width:100%;margin-bottom:7px;"></div>
        <div class="skeleton" style="height:11px;width:88%;margin-bottom:7px;"></div>
        <div class="skeleton" style="height:11px;width:70%;margin-bottom:14px;"></div>
        <div class="skeleton" style="height:44px;width:100%;border-radius:14px;"></div>
      </div>
    </div>
    <div class="skel-card">
      <div class="skeleton skel-bar"></div>
      <div class="skel-body">
        <div class="skeleton" style="height:16px;width:55%;margin-bottom:10px;"></div>
        <div class="skeleton" style="height:28px;width:62%;margin-bottom:14px;"></div>
        <div class="skeleton" style="height:11px;width:100%;margin-bottom:7px;"></div>
        <div class="skeleton" style="height:11px;width:92%;margin-bottom:7px;"></div>
        <div class="skeleton" style="height:11px;width:75%;margin-bottom:14px;"></div>
        <div class="skeleton" style="height:44px;width:100%;border-radius:14px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="page-bottom"></div>

<!-- â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â• -->
<div class="bottom-nav">
  <a href="home.html" class="nav-item">
    <i class="fas fa-home"></i><span>Home</span>
  </a>
  <a href="plans.html" class="nav-item active">
    <i class="fas fa-chart-line"></i><span>Plans</span>
  </a>
  <a href="investments.html" class="nav-center" title="My Investments">
    <i class="fas fa-wallet"></i>
  </a>
  <a href="referrals.html" class="nav-item">
    <i class="fas fa-users"></i><span>Referrals</span>
  </a>
  <a href="dashboard.html" class="nav-item">
    <i class="fas fa-user-circle"></i><span>Profile</span>
  </a>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â•â•â•â•â•â•â• -->
<script>

/* â”€â”€ Firebase â”€â”€ */
const firebaseConfig = {
  apiKey:            "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
  authDomain:        "cashpoint-ac4f4.firebaseapp.com",
  projectId:         "cashpoint-ac4f4",
  storageBucket:     "cashpoint-ac4f4.firebasestorage.app",
  messagingSenderId: "16133206416",
  appId:             "1:16133206416:web:a093f4e153ad2c9bcc8315"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* â”€â”€ Referral rates â”€â”€
   Level 1 = 25%  (direct referrer of the buyer)
   Level 2 = 2%   (referrer of the L1 person)
   Level 3 = 1%   (referrer of the L2 person)
*/
const RATES = { 1: 0.25, 2: 0.02, 3: 0.01 };

/* â”€â”€ Plan table â”€â”€
   Formula derived from owner's pattern:
     â‚¦3,000 invest â†’ â‚¦500 / day
     â‚¦6,000 invest â†’ â‚¦1,000 / day
   Therefore: dailyROI  = price Ã· 6
              totalReturn = dailyROI Ã— 30 = price Ã— 5
   Each plan doubles the price of the previous one.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Plan        Price      Daily    Total (30d)
   Basic       3,000        500     15,000
   Starter     6,000      1,000     30,000
   Silver     12,000      2,000     60,000
   Gold       24,000      4,000    120,000
   Platinum   48,000      8,000    240,000
   Diamond    96,000     16,000    480,000
   Elite     192,000     32,000    960,000
   VIP       384,000     64,000  1,920,000
   Ultimate  768,000    128,000  3,840,000
*/
const PLANS = [
  { name:'Basic',    price:3000,   dailyROI:500,    totalReturn:15000,   duration:30, popular:false, color:'#6B7A99', btn:'linear-gradient(135deg,#6B7A99,#4a5568)',    shadow:'rgba(107,122,153,0.35)', bbg:'#F0F4FF', bc:'#6B7A99' },
  { name:'Starter',  price:6000,   dailyROI:1000,   totalReturn:30000,   duration:30, popular:false, color:'#4CAF50', btn:'linear-gradient(135deg,#4CAF50,#388E3C)',    shadow:'rgba(76,175,80,0.35)',   bbg:'#E8FFF6', bc:'#388E3C' },
  { name:'Silver',   price:12000,  dailyROI:2000,   totalReturn:60000,   duration:30, popular:false, color:'#78909C', btn:'linear-gradient(135deg,#78909C,#546E7A)',    shadow:'rgba(120,144,156,0.35)', bbg:'#ECEFF1', bc:'#546E7A' },
  { name:'Gold',     price:24000,  dailyROI:4000,   totalReturn:120000,  duration:30, popular:true,  color:'#FFB800', btn:'linear-gradient(135deg,#FFB800,#F57F17)',    shadow:'rgba(255,184,0,0.40)',   bbg:'#FFF8E8', bc:'#F57F17' },
  { name:'Platinum', price:48000,  dailyROI:8000,   totalReturn:240000,  duration:30, popular:false, color:'#0052FF', btn:'linear-gradient(135deg,#0052FF,#0039b3)',    shadow:'rgba(0,82,255,0.38)',    bbg:'#E8F0FF', bc:'#0052FF' },
  { name:'Diamond',  price:96000,  dailyROI:16000,  totalReturn:480000,  duration:30, popular:false, color:'#00C48C', btn:'linear-gradient(135deg,#00C48C,#00a87e)',    shadow:'rgba(0,196,140,0.38)',   bbg:'#E8FFF6', bc:'#00a87e' },
  { name:'Elite',    price:192000, dailyROI:32000,  totalReturn:960000,  duration:30, popular:false, color:'#9B59B6', btn:'linear-gradient(135deg,#9B59B6,#7d3c98)',    shadow:'rgba(155,89,182,0.38)',  bbg:'#F3E8FF', bc:'#7d3c98' },
  { name:'VIP',      price:384000, dailyROI:64000,  totalReturn:1920000, duration:30, popular:false, color:'#FF4D6D', btn:'linear-gradient(135deg,#FF4D6D,#c0392b)',    shadow:'rgba(255,77,109,0.38)',  bbg:'#FFF0F3', bc:'#c0392b' },
  { name:'Ultimate', price:768000, dailyROI:128000, totalReturn:3840000, duration:30, popular:false, color:'#001c6b', btn:'linear-gradient(135deg,#0052FF,#001c6b)',    shadow:'rgba(0,52,255,0.42)',    bbg:'#E8F0FF', bc:'#001c6b' }
];

/* â”€â”€ State â”€â”€ */
let currentUserId  = null;
let currentBalance = 0;

/* â”€â”€ Clock â”€â”€ */
function tickClock() {
  document.getElementById('topClock').textContent =
    new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
}
tickClock();
setInterval(tickClock, 1000);

/* â”€â”€ Formatters â”€â”€ */
function fmtFull(n) {
  return Number(n||0).toLocaleString('en-NG', { minimumFractionDigits:2, maximumFractionDigits:2 });
}
function fmtN(n) {
  return Number(n||0).toLocaleString('en-NG');
}

/* â”€â”€ Auth â”€â”€ */
auth.onAuthStateChanged(async (user) => {
  if (!user) { window.location.href = 'login.html'; return; }
  currentUserId = user.uid;
  try {
    /* Claim any pending referral credits FIRST so balance is up to date */
    await claimPendingReferralCredits(currentUserId);

    const snap = await db.collection('users').doc(currentUserId).get();
    if (snap.exists) {
      const d = snap.data();
      currentBalance = Number(d.balance || 0);
      document.getElementById('balanceDisplay').textContent = fmtFull(currentBalance);
      const fn = (d.fullName || d.username || 'U').split(' ')[0];
      document.getElementById('avatarBox').textContent = fn.charAt(0).toUpperCase();
    }
  } catch(e) { console.error('Balance load error:', e); }
  renderPlans();
});

/* â”€â”€ Render all plan cards â”€â”€ */
function renderPlans() {
  const grid = document.getElementById('plansGrid');
  grid.innerHTML = '';

  PLANS.forEach((p, idx) => {
    const l1 = p.price * RATES[1];   // 25%
    const l2 = p.price * RATES[2];   // 2%
    const l3 = p.price * RATES[3];   // 1%
    const profit    = p.totalReturn - p.price;
    const roiPct    = ((p.dailyROI / p.price) * 100).toFixed(1);
    const canAfford = currentBalance >= p.price;
    const shortage  = p.price - currentBalance;

    const wrap = document.createElement('div');
    wrap.className = 'plan-wrapper';

    if (p.popular) {
      const rib = document.createElement('div');
      rib.className = 'popular-ribbon';
      rib.textContent = 'ğŸ”¥ Most Popular';
      wrap.appendChild(rib);
    }

    const card = document.createElement('div');
    card.className = 'plan-card';
    card.style.animationDelay = (idx * 0.055) + 's';

    card.innerHTML = `
      <div class="plan-top-bar" style="background:${p.color};"></div>

      <div class="plan-body">
        <div class="plan-head-row">
          <div class="plan-name">${p.name} Plan</div>
          <span class="plan-badge" style="background:${p.bbg};color:${p.bc};">${p.name}</span>
        </div>

        <div class="plan-invest-lbl">Investment Amount</div>
        <div class="plan-price"><span class="psym">â‚¦</span>${fmtN(p.price)}</div>

        <div class="plan-rows">
          <div class="plan-row">
            <span class="pr-lbl"><i class="fas fa-calendar-day" style="color:${p.color};"></i>Daily Earnings</span>
            <span class="pr-val green">â‚¦${fmtN(p.dailyROI)}</span>
          </div>
          <div class="plan-row">
            <span class="pr-lbl"><i class="fas fa-coins" style="color:${p.color};"></i>Total Return</span>
            <span class="pr-val gold">â‚¦${fmtN(p.totalReturn)}</span>
          </div>
          <div class="plan-row">
            <span class="pr-lbl"><i class="fas fa-chart-bar" style="color:${p.color};"></i>Net Profit</span>
            <span class="pr-val green">â‚¦${fmtN(profit)}</span>
          </div>
          <div class="plan-row">
            <span class="pr-lbl"><i class="fas fa-clock" style="color:${p.color};"></i>Duration</span>
            <span class="pr-val">${p.duration} Days</span>
          </div>
          <div class="plan-row">
            <span class="pr-lbl"><i class="fas fa-percentage" style="color:${p.color};"></i>Daily ROI</span>
            <span class="pr-val blue">${roiPct}% / day</span>
          </div>
        </div>

        <div class="ref-bonus-section">
          <div class="ref-bonus-lbl">
            <i class="fas fa-gift" style="color:var(--accent);"></i>
            Upline referral bonuses on this plan
          </div>
          <div class="ref-pills">
            <span class="ref-pill l1">L1 earns â‚¦${fmtN(l1)}</span>
            <span class="ref-pill l2">L2 earns â‚¦${fmtN(l2)}</span>
            <span class="ref-pill l3">L3 earns â‚¦${fmtN(l3)}</span>
          </div>
        </div>
      </div>

      <div class="plan-footer">
        <button
          class="invest-btn ${canAfford ? '' : 'no-funds'}"
          style="${canAfford ? `background:${p.btn};box-shadow:0 6px 20px ${p.shadow};` : ''}"
          onclick="onInvestClick(${idx})"
        >
          ${canAfford
            ? `<i class="fas fa-rocket"></i> Invest â‚¦${fmtN(p.price)}`
            : `<i class="fas fa-wallet"></i> Need â‚¦${fmtN(shortage)} More`
          }
        </button>
      </div>
    `;

    wrap.appendChild(card);
    grid.appendChild(wrap);
  });
}

/* â”€â”€ Button click handler â”€â”€ */
function onInvestClick(idx) {
  const p = PLANS[idx];

  if (currentBalance < p.price) {
    const gap = p.price - currentBalance;
    Swal.fire({
      icon: 'warning',
      title: 'Insufficient Balance',
      html: `
        <div style="font-family:'Plus Jakarta Sans',sans-serif;text-align:left;">
          <p style="font-size:14px;color:#0D1B3E;margin-bottom:12px;">
            You need <b style="color:#FF4D6D;">â‚¦${fmtN(gap)}</b> more to activate the <b>${p.name} Plan</b>.
          </p>
          <div style="display:flex;justify-content:space-between;background:#F0F4FF;border-radius:10px;padding:10px 14px;font-size:13px;margin-bottom:4px;">
            <span style="color:#6B7A99;font-weight:600;">Your Balance</span>
            <span style="font-weight:700;color:#0D1B3E;">â‚¦${fmtFull(currentBalance)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;background:#F0F4FF;border-radius:10px;padding:10px 14px;font-size:13px;">
            <span style="color:#6B7A99;font-weight:600;">Plan Cost</span>
            <span style="font-weight:700;color:#0D1B3E;">â‚¦${fmtN(p.price)}</span>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '<i class="fas fa-plus"></i> Deposit Now',
      cancelButtonText: 'Cancel',
      confirmButtonColor: '#00C48C',
      cancelButtonColor: '#6B7A99'
    }).then(r => { if (r.isConfirmed) window.location.href = 'deposit.html'; });
    return;
  }

  showConfirm(idx);
}

/* â”€â”€ Confirmation dialog â”€â”€ */
function showConfirm(idx) {
  const p = PLANS[idx];
  const l1 = p.price * RATES[1];
  const l2 = p.price * RATES[2];
  const l3 = p.price * RATES[3];
  const profit = p.totalReturn - p.price;

  Swal.fire({
    title: `Activate ${p.name} Plan?`,
    html: `
      <div style="font-family:'Plus Jakarta Sans',sans-serif;text-align:left;">
        <div style="background:#F0F4FF;border-radius:14px;padding:14px 16px;margin-bottom:12px;">
          <div style="font-size:11px;color:#6B7A99;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px;">${p.name} Plan</div>
          <div style="font-size:26px;font-weight:700;color:#0D1B3E;font-family:'Sora',sans-serif;letter-spacing:-1px;">â‚¦${fmtN(p.price)}</div>
          <div style="font-size:12px;color:#6B7A99;margin-top:2px;">${p.duration} day plan â€¢ starts immediately</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
          <div style="background:#E8FFF6;border-radius:12px;padding:12px;">
            <div style="font-size:10px;color:#6B7A99;font-weight:700;text-transform:uppercase;margin-bottom:3px;">Daily Earnings</div>
            <div style="font-size:17px;font-weight:800;color:#00C48C;">â‚¦${fmtN(p.dailyROI)}</div>
          </div>
          <div style="background:#FFF8E8;border-radius:12px;padding:12px;">
            <div style="font-size:10px;color:#6B7A99;font-weight:700;text-transform:uppercase;margin-bottom:3px;">Total Return</div>
            <div style="font-size:17px;font-weight:800;color:#FFB800;">â‚¦${fmtN(p.totalReturn)}</div>
          </div>
          <div style="background:#E8F0FF;border-radius:12px;padding:12px;">
            <div style="font-size:10px;color:#6B7A99;font-weight:700;text-transform:uppercase;margin-bottom:3px;">Net Profit</div>
            <div style="font-size:17px;font-weight:800;color:#0052FF;">â‚¦${fmtN(profit)}</div>
          </div>
          <div style="background:#F0F4FF;border-radius:12px;padding:12px;">
            <div style="font-size:10px;color:#6B7A99;font-weight:700;text-transform:uppercase;margin-bottom:3px;">Balance After</div>
            <div style="font-size:17px;font-weight:800;color:#0D1B3E;">â‚¦${fmtN(currentBalance - p.price)}</div>
          </div>
        </div>
        <div style="background:#FFF8E8;border-radius:12px;padding:12px 14px;font-size:12px;">
          <div style="font-weight:700;color:#0D1B3E;margin-bottom:6px;">ğŸ Referral bonuses paid to upliners instantly:</div>
          <div style="display:flex;gap:7px;flex-wrap:wrap;">
            <span style="background:#E8F0FF;color:#0052FF;border-radius:99px;padding:3px 10px;font-size:11px;font-weight:700;">L1 â†’ â‚¦${fmtN(l1)}</span>
            <span style="background:#E8FFF6;color:#00C48C;border-radius:99px;padding:3px 10px;font-size:11px;font-weight:700;">L2 â†’ â‚¦${fmtN(l2)}</span>
            <span style="background:#FFF8E8;color:#FFB800;border-radius:99px;padding:3px 10px;font-size:11px;font-weight:700;">L3 â†’ â‚¦${fmtN(l3)}</span>
          </div>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'âœ… Confirm & Invest',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#0052FF',
    cancelButtonColor: '#6B7A99'
  }).then(r => { if (r.isConfirmed) processInvestment(p); });
}

/* â”€â”€ Process investment â”€â”€ */
async function processInvestment(p) {
  Swal.fire({
    title: 'Activating Plan...',
    html: '<div style="font-family:\'Plus Jakarta Sans\',sans-serif;color:#6B7A99;font-size:13px;">Deducting balance and paying referral bonuses...</div>',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const userRef = db.collection('users').doc(currentUserId);

    /* â”€â”€ Atomic transaction: deduct balance + create investment â”€â”€ */
    let newInvId = null;
    await db.runTransaction(async (tx) => {
      const uSnap = await tx.get(userRef);
      if (!uSnap.exists) throw new Error('Account not found. Please log in again.');

      const bal = Number(uSnap.data().balance || 0);
      if (bal < p.price) throw new Error(`Insufficient balance (â‚¦${fmtFull(bal)}). Please deposit first.`);

      /* Deduct and record investment */
      tx.update(userRef, {
        balance:       firebase.firestore.FieldValue.increment(-p.price),
        totalInvested: firebase.firestore.FieldValue.increment(p.price)
      });

      const invRef = db.collection('investments').doc();
      newInvId = invRef.id;
      tx.set(invRef, {
        userId:         currentUserId,
        planName:       p.name + ' Plan',
        amount:         p.price,
        dailyROI:       p.dailyROI,
        totalReturn:    p.totalReturn,
        durationDays:   p.duration,
        activationTime: firebase.firestore.FieldValue.serverTimestamp(),
        endTime:        new Date(Date.now() + p.duration * 86400000),
        lastROI:        firebase.firestore.FieldValue.serverTimestamp(),
        active:         true,
        createdAt:      firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    /* â”€â”€ Pay referral bonuses up 3 levels â”€â”€ */
    await payReferralBonuses(currentUserId, p.price, p.name, newInvId);

    /* â”€â”€ Refresh balance display â”€â”€ */
    const fresh = await db.collection('users').doc(currentUserId).get();
    currentBalance = Number(fresh.data().balance || 0);
    document.getElementById('balanceDisplay').textContent = fmtFull(currentBalance);
    renderPlans();

    /* â”€â”€ Success â”€â”€ */
    await Swal.fire({
      icon: 'success',
      title: 'ğŸ‰ Plan Activated!',
      html: `
        <div style="font-family:'Plus Jakarta Sans',sans-serif;text-align:center;">
          <div style="font-size:16px;font-weight:700;color:#0D1B3E;margin-bottom:5px;">${p.name} Plan is now live</div>
          <div style="font-size:13px;color:#6B7A99;margin-bottom:14px;">Your earnings start in ~24 hours</div>
          <div style="background:#E8FFF6;border-radius:12px;padding:11px 16px;display:inline-block;">
            <div style="font-size:14px;color:#00C48C;font-weight:700;">ğŸ“ˆ Daily: â‚¦${fmtN(p.dailyROI)} for ${p.duration} days</div>
          </div>
        </div>
      `,
      timer: 3500,
      timerProgressBar: true,
      showConfirmButton: false
    });

    window.location.href = 'investments.html';

  } catch(err) {
    console.error('Investment error:', err);
    Swal.fire({ icon:'error', title:'Investment Failed', text: err.message || 'Please try again.', confirmButtonColor:'#0052FF' });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAY REFERRAL BONUSES â€” 3 LEVELS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   We start at the buyer and walk UP the
   referrerUid chain:

   buyer.referrerUid  â†’  Level 1 upline (25%)
   L1.referrerUid     â†’  Level 2 upline (2%)
   L2.referrerUid     â†’  Level 3 upline (1%)

   Each upline gets:
     â€¢ balance incremented
     â€¢ totalEarnings incremented
     â€¢ totalRefEarnings incremented
   A record is saved in referral_bonuses for audit.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function payReferralBonuses(buyerUid, amount, planName, invId) {
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REFERRAL BONUS DISTRIBUTION â€” 3 LEVELS

     APPROACH: Write bonus entries to `referral_credits` collection.
     Each entry is owned by the upline (uplineUid field).
     The upline's OWN session (on home/profile load) reads unclaimed
     credits and applies them to their own balance â€” which the rules allow.

     WHY: Firestore rules block user A from updating user B's balance doc
     (and rightly so for security). The referral_credits collection acts
     as a secure escrow â€” buyer queues the payment, upline claims it.

     ALSO: We attempt direct update first (works if rules are open enough).
     If that fails, we fall back to the credits queue.
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  console.log('[Referral] Starting bonus for buyer:', buyerUid, 'plan:', planName, 'amount:', amount);

  const FV  = firebase.firestore.FieldValue;
  const now = FV.serverTimestamp();
  let currentUid = buyerUid;

  for (let lvl = 1; lvl <= 3; lvl++) {
    try {
      /* â”€â”€ Step 1: Get upline uid from current node â”€â”€ */
      const nodeSnap = await db.collection('users').doc(currentUid).get();
      if (!nodeSnap.exists) { console.log(`[Ref L${lvl}] node ${currentUid} missing â€” stop`); break; }

      const uplineUid = nodeSnap.data().referrerUid;
      if (!uplineUid || uplineUid === 'direct' || uplineUid === '') {
        console.log(`[Ref L${lvl}] no upline â€” chain ends`); break;
      }

      /* â”€â”€ Step 2: Get commission rate â”€â”€ */
      const commissionPct = RATES[lvl] * 100;
      const bonus = Math.floor(amount * RATES[lvl]);
      if (bonus <= 0) { currentUid = uplineUid; continue; }

      console.log(`[Ref L${lvl}] upline=${uplineUid} bonus=â‚¦${bonus} (${commissionPct}%)`);

      /* â”€â”€ Step 3: Try direct balance update first â”€â”€ */
      let directCreditDone = false;
      try {
        await db.collection('users').doc(uplineUid).update({
          balance:          FV.increment(bonus),
          totalEarnings:    FV.increment(bonus),
          totalRefEarnings: FV.increment(bonus)
        });
        directCreditDone = true;
        console.log(`[Ref L${lvl}] âœ… Direct credit success: â‚¦${bonus} â†’ ${uplineUid}`);
      } catch(directErr) {
        /* Rules blocked it â€” fall back to credit queue */
        console.warn(`[Ref L${lvl}] Direct update blocked (${directErr.code}) â€” using credit queue`);
      }

      /* â”€â”€ Step 4: Write to referral_credits queue (always, as audit + fallback) â”€â”€ */
      await db.collection('referral_credits').add({
        uplineUid,
        buyerUid,
        investmentId: invId || '',
        planName:     planName + ' Plan',
        investAmount: amount,
        bonusAmount:  bonus,
        level:        lvl,
        ratePercent:  commissionPct,
        claimed:      directCreditDone,   /* true = already credited directly */
        createdAt:    now
      });

      /* â”€â”€ Step 5: Write audit log to referral_bonuses â”€â”€ */
      try {
        await db.collection('referral_bonuses').add({
          uplineUid,
          buyerUid,
          investmentId: invId || '',
          planName:     planName + ' Plan',
          investAmount: amount,
          bonusAmount:  bonus,
          level:        lvl,
          ratePercent:  commissionPct,
          createdAt:    now
        });
      } catch(auditErr) {
        console.warn(`[Ref L${lvl}] Audit log failed:`, auditErr.message);
      }

      currentUid = uplineUid;

    } catch(lvlErr) {
      console.error(`[Ref L${lvl}] Error:`, lvlErr.code, lvlErr.message);
      /* Try to keep walking chain even if this level failed */
      try {
        const n = await db.collection('users').doc(currentUid).get();
        const next = n.exists ? n.data().referrerUid : null;
        if (next && next !== 'direct') currentUid = next; else break;
      } catch(e) { break; }
    }
  }

  console.log('[Referral] âœ… Distribution complete');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLAIM PENDING REFERRAL CREDITS
   Called on page load â€” reads any unclaimed referral_credits for this
   user and applies them to their own balance (rules allow self-update).
   This is the fallback for when direct credit was blocked by rules.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function claimPendingReferralCredits(userUid) {
  try {
    const snap = await db.collection('referral_credits')
      .where('uplineUid', '==', userUid)
      .where('claimed', '==', false)
      .get();

    if (snap.empty) return;

    console.log(`[Credits] Found ${snap.size} unclaimed referral credit(s) for ${userUid}`);

    let totalClaimed = 0;
    const batch = db.batch();

    snap.docs.forEach(doc => {
      const bonus = Number(doc.data().bonusAmount || 0);
      if (bonus <= 0) return;

      /* Credit own balance â€” this is always allowed by rules */
      batch.update(db.collection('users').doc(userUid), {
        balance:          firebase.firestore.FieldValue.increment(bonus),
        totalEarnings:    firebase.firestore.FieldValue.increment(bonus),
        totalRefEarnings: firebase.firestore.FieldValue.increment(bonus)
      });

      /* Mark as claimed */
      batch.update(doc.ref, { claimed: true, claimedAt: firebase.firestore.FieldValue.serverTimestamp() });

      totalClaimed += bonus;
    });

    await batch.commit();
    console.log(`[Credits] âœ… Claimed â‚¦${totalClaimed} in referral credits`);

    /* Refresh balance display if on this page */
    try {
      const fresh = await db.collection('users').doc(userUid).get();
      currentBalance = Number(fresh.data().balance || 0);
      const el = document.getElementById('balanceDisplay');
      if (el) el.textContent = fmtFull(currentBalance);
    } catch(e) {}

  } catch(err) {
    /* Never block main flow */
    console.warn('[Credits] Claim failed:', err.code, err.message);
  }
}

</script>
</body>
</html>

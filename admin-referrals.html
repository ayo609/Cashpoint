<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cashpoint | Referrals</title>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet"/>

<style>
:root{--primary:#0052FF;--danger:#FF4D6D;--warning:#FFB800;--success:#00C48C;--text:#0D1B3E;--muted:#6B7A99;--border:#D8E0F0;--bg:#F0F4FF;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* TOPBAR */
.topbar{background:white;border-bottom:1px solid var(--border);padding:0 20px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,82,255,0.06);}
.topbar-left{display:flex;align-items:center;gap:12px;}
.back-btn{width:36px;height:36px;border-radius:10px;background:var(--bg);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--muted);text-decoration:none;transition:background .2s;}
.back-btn:hover{background:var(--border);}
.page-title{font-family:'Sora',sans-serif;font-size:17px;font-weight:700;}

/* SUMMARY */
.summary{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;padding:20px 20px 0;}
.scard{background:white;border-radius:14px;padding:16px;box-shadow:0 3px 12px rgba(0,82,255,0.06);}
.scard-val{font-family:'Sora',sans-serif;font-size:20px;font-weight:700;margin-bottom:3px;}
.scard-lbl{font-size:11.5px;color:var(--muted);font-weight:700;}

/* RATES BANNER */
.rates-banner{margin:16px 20px 0;background:linear-gradient(135deg,#001c6b,#0039b3);border-radius:14px;padding:14px 20px;display:flex;align-items:center;gap:20px;flex-wrap:wrap;}
.rates-banner-title{font-size:12px;font-weight:800;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:.05em;margin-bottom:2px;}
.rate-pill{padding:6px 16px;border-radius:99px;font-size:13px;font-weight:800;white-space:nowrap;}
.rate-l1{background:#E8F0FF;color:var(--primary);}
.rate-l2{background:#E8FFF6;color:var(--success);}
.rate-l3{background:#FFF8E8;color:var(--warning);}

/* TABS */
.tab-bar{display:flex;gap:0;padding:16px 20px 0;border-bottom:1px solid var(--border);background:white;margin-top:16px;}
.tab-btn{padding:12px 22px;font-size:13.5px;font-weight:700;font-family:inherit;border:none;background:none;cursor:pointer;color:var(--muted);border-bottom:2.5px solid transparent;transition:all .2s;}
.tab-btn.active{color:var(--primary);border-color:var(--primary);}

/* FILTER BAR */
.filter-bar{padding:14px 20px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:white;border-bottom:1px solid var(--border);}
.search-wrap{display:flex;align-items:center;gap:8px;background:var(--bg);border:2px solid var(--border);border-radius:11px;padding:0 14px;flex:1;min-width:180px;max-width:320px;transition:border-color .2s;}
.search-wrap:focus-within{border-color:var(--primary);}
.search-wrap i{color:var(--muted);font-size:14px;}
.search-input{flex:1;border:none;background:none;outline:none;font-size:14px;font-family:inherit;color:var(--text);padding:10px 0;}
.fbtn{padding:7px 14px;border-radius:9px;border:2px solid var(--border);background:white;font-size:12.5px;font-weight:700;font-family:inherit;cursor:pointer;color:var(--muted);transition:all .2s;}
.fbtn.active{background:var(--primary);color:white;border-color:var(--primary);}
.refresh-btn{width:38px;height:38px;border-radius:10px;border:2px solid var(--border);background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:15px;transition:all .2s;flex-shrink:0;margin-left:auto;}
.refresh-btn:hover{border-color:var(--primary);color:var(--primary);}
.spin{animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* CONTENT */
.content{padding:20px;}

/* ‚îÄ‚îÄ USER CARDS VIEW (Tab 1) ‚îÄ‚îÄ */
.users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;}
.user-ref-card{background:white;border-radius:18px;padding:18px;box-shadow:0 4px 16px rgba(0,82,255,0.07);cursor:pointer;transition:transform .18s,box-shadow .18s,border-color .18s;border:2px solid transparent;}
.user-ref-card:hover{transform:translateY(-3px);box-shadow:0 10px 28px rgba(0,82,255,0.13);border-color:var(--primary);}
.urc-head{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.urc-av{width:44px;height:44px;border-radius:13px;background:linear-gradient(135deg,var(--primary),#001c6b);color:white;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;flex-shrink:0;}
.urc-name{font-size:14px;font-weight:700;}
.urc-email{font-size:11.5px;color:var(--muted);}
.urc-code{margin-left:auto;font-size:11px;font-weight:700;background:var(--bg);padding:4px 10px;border-radius:8px;color:var(--primary);font-family:monospace;}
.urc-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
.urc-stat{background:var(--bg);border-radius:10px;padding:10px;text-align:center;}
.urc-stat-val{font-family:'Sora',sans-serif;font-size:15px;font-weight:700;line-height:1;}
.urc-stat-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-top:2px;}
.urc-levels{display:flex;gap:6px;flex-wrap:wrap;}
.lvl-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:99px;font-size:11.5px;font-weight:700;}
.lvl-pill.l1{background:#E8F0FF;color:var(--primary);}
.lvl-pill.l2{background:#E8FFF6;color:var(--success);}
.lvl-pill.l3{background:#FFF8E8;color:var(--warning);}
.urc-arrow{margin-left:auto;color:var(--border);font-size:16px;}

/* ‚îÄ‚îÄ BONUS LOGS TABLE (Tab 2) ‚îÄ‚îÄ */
.table{width:100%;border-collapse:collapse;background:white;border-radius:16px;overflow:hidden;box-shadow:0 4px 18px rgba(0,82,255,0.07);}
.table th{padding:13px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;background:#F8FAFF;border-bottom:1px solid var(--border);}
.table td{padding:13px 16px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;}
.table tr:last-child td{border-bottom:none;}
.table tr:hover td{background:#FAFBFF;}
.u-cell{display:flex;align-items:center;gap:9px;}
.u-av{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--primary),#001c6b);color:white;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;flex-shrink:0;}
.u-name{font-size:13px;font-weight:700;}
.u-sub{font-size:11.5px;color:var(--muted);}
.lbadge{padding:4px 11px;border-radius:99px;font-size:11px;font-weight:700;}
.lbadge.l1{background:#E8F0FF;color:var(--primary);}
.lbadge.l2{background:#E8FFF6;color:var(--success);}
.lbadge.l3{background:#FFF8E8;color:var(--warning);}
.amt{font-weight:800;}
.amt.green{color:var(--success);}
.plan-tag{font-size:11.5px;font-weight:700;background:var(--bg);padding:3px 9px;border-radius:7px;color:var(--text);}

/* Skeleton */
.skel{height:13px;background:linear-gradient(90deg,#f0f4ff 25%,#e0e8ff 50%,#f0f4ff 75%);background-size:200% 100%;border-radius:6px;animation:shimmer 1.4s infinite;}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.empty{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-icon{font-size:48px;margin-bottom:12px;}
.empty-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:6px;}
.empty-sub{font-size:13px;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL DRAWER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.overlay{position:fixed;inset:0;background:rgba(13,27,62,0.45);backdrop-filter:blur(3px);z-index:200;opacity:0;pointer-events:none;transition:opacity .3s;}
.overlay.open{opacity:1;pointer-events:all;}
.drawer{position:fixed;top:0;right:0;bottom:0;width:min(520px,100vw);background:white;z-index:201;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .35s cubic-bezier(.16,1,.3,1);box-shadow:-12px 0 50px rgba(0,82,255,0.12);}
.overlay.open .drawer{transform:translateX(0);}

.dhead{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;}
.dhead-av{width:50px;height:50px;border-radius:15px;background:linear-gradient(135deg,var(--primary),#001c6b);color:white;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;flex-shrink:0;}
.dhead-name{font-family:'Sora',sans-serif;font-size:16px;font-weight:700;}
.dhead-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.dclose{margin-left:auto;width:32px;height:32px;border-radius:9px;background:var(--bg);border:none;cursor:pointer;font-size:18px;color:var(--muted);display:flex;align-items:center;justify-content:center;flex-shrink:0;}

.dbody{flex:1;overflow-y:auto;padding:20px;}
.dbody::-webkit-scrollbar{width:4px;}
.dbody::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px;}

/* Stats in drawer */
.d-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px;}
.d-stat{background:var(--bg);border-radius:12px;padding:13px;text-align:center;}
.d-stat-val{font-family:'Sora',sans-serif;font-size:15px;font-weight:700;line-height:1;margin-bottom:3px;}
.d-stat-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;}

.slabel{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin:16px 0 10px;}

/* Referral tree rows */
.tree-row{background:white;border:1.5px solid var(--border);border-radius:13px;padding:13px 14px;margin-bottom:8px;}
.tree-row.l2{margin-left:20px;border-color:#b0f0d8;}
.tree-row.l3{margin-left:40px;border-color:#ffe0a0;}
.tree-head{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.tree-av{width:34px;height:34px;border-radius:10px;color:white;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;flex-shrink:0;}
.tree-av.l1{background:linear-gradient(135deg,var(--primary),#001c6b);}
.tree-av.l2{background:linear-gradient(135deg,var(--success),#00a07a);}
.tree-av.l3{background:linear-gradient(135deg,var(--warning),#e65c00);}
.tree-name{font-size:13px;font-weight:700;}
.tree-email{font-size:11.5px;color:var(--muted);}
.tree-badge{margin-left:auto;}
.tree-fields{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.tf{background:var(--bg);border-radius:8px;padding:7px 9px;}
.tf-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:2px;}
.tf-val{font-size:12.5px;font-weight:800;}

/* Bonus log items in drawer */
.bonus-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
.bonus-item:last-child{border-bottom:none;}
.bi-plan{font-size:13px;font-weight:700;}
.bi-sub{font-size:11px;color:var(--muted);margin-top:2px;}
.bi-right{text-align:right;}
.bi-amt{font-size:14px;font-weight:800;color:var(--success);}
.bi-date{font-size:11px;color:var(--muted);}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-left">
    <a class="back-btn" href="admin-dashboard.html"><i class="fas fa-arrow-left"></i></a>
    <div class="page-title">üéÅ Referral Management</div>
  </div>
</div>

<!-- SUMMARY -->
<div class="summary">
  <div class="scard"><div class="scard-val" id="sc-users">‚Äî</div><div class="scard-lbl">Referrers</div></div>
  <div class="scard"><div class="scard-val" style="color:var(--primary);" id="sc-l1">‚Äî</div><div class="scard-lbl">L1 Referrals</div></div>
  <div class="scard"><div class="scard-val" style="color:var(--success);" id="sc-l2">‚Äî</div><div class="scard-lbl">L2 Referrals</div></div>
  <div class="scard"><div class="scard-val" style="color:var(--warning);" id="sc-l3">‚Äî</div><div class="scard-lbl">L3 Referrals</div></div>
  <div class="scard"><div class="scard-val" style="color:var(--success);" id="sc-bonuses">‚Äî</div><div class="scard-lbl">Total Bonuses</div></div>
  <div class="scard"><div class="scard-val" style="color:var(--success);" id="sc-total-paid">‚Äî</div><div class="scard-lbl">Total Paid Out</div></div>
</div>

<!-- RATES BANNER -->
<div class="rates-banner">
  <div>
    <div class="rates-banner-title">Commission Rates</div>
  </div>
  <span class="rate-pill rate-l1">L1 ¬∑ 25%</span>
  <span class="rate-pill rate-l2">L2 ¬∑ 2%</span>
  <span class="rate-pill rate-l3">L3 ¬∑ 1%</span>
  <div style="margin-left:auto;font-size:12px;color:rgba(255,255,255,0.6);font-weight:600;">Paid on every plan purchase</div>
</div>

<!-- TABS -->
<div class="tab-bar">
  <button class="tab-btn active" id="tab-users-btn" onclick="switchTab('users',this)">üë• By User</button>
  <button class="tab-btn" id="tab-bonuses-btn" onclick="switchTab('bonuses',this)">üí∞ Bonus Logs</button>
</div>

<!-- FILTER BAR -->
<div class="filter-bar">
  <div class="search-wrap">
    <i class="fas fa-search"></i>
    <input class="search-input" id="searchInput" placeholder="Search name, email, referral code..." oninput="renderActive()"/>
  </div>
  <!-- Level filter ‚Äî only shown on bonuses tab -->
  <div id="levelFilters" style="display:none;gap:6px;display:none;">
    <button class="fbtn active" onclick="setLevelFilter('all',this)">All</button>
    <button class="fbtn" onclick="setLevelFilter('1',this)">L1</button>
    <button class="fbtn" onclick="setLevelFilter('2',this)">L2</button>
    <button class="fbtn" onclick="setLevelFilter('3',this)">L3</button>
  </div>
  <button class="refresh-btn" onclick="loadAll()"><i class="fas fa-sync-alt" id="refreshIcon"></i></button>
</div>

<!-- CONTENT AREA -->
<div class="content" id="mainContent">
  <!-- injected by renderActive() -->
</div>

<!-- SIDE DRAWER -->
<div class="overlay" id="overlay" onclick="closeDrawer(event)">
  <div class="drawer" id="drawer">
    <div class="dhead">
      <div class="dhead-av" id="dAv">U</div>
      <div style="flex:1;min-width:0;">
        <div class="dhead-name" id="dName">‚Äî</div>
        <div class="dhead-sub" id="dSub">‚Äî</div>
      </div>
      <button class="dclose" onclick="closeDrawerDirect()">‚úï</button>
    </div>
    <div class="dbody" id="dbody">
      <div class="empty"><div class="empty-icon">üéÅ</div></div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:            "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
  authDomain:        "cashpoint-ac4f4.firebaseapp.com",
  projectId:         "cashpoint-ac4f4",
  storageBucket:     "cashpoint-ac4f4.firebasestorage.app",
  messagingSenderId: "16133206416",
  appId:             "1:16133206416:web:a093f4e153ad2c9bcc8315"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

auth.onAuthStateChanged(u => { if (!u) window.location.href = 'admin-login.html'; else loadAll(); });

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let allUsers    = {};    /* uid ‚Üí user data */
let allBonuses  = [];    /* all referral_bonus docs */
let referrers   = [];    /* users who have at least 1 referral */
let activeTab   = 'users';
let levelFilter = 'all';

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
const fmtN  = n  => '‚Ç¶' + Number(n||0).toLocaleString('en-NG');
const fmtS  = n  => { const v=Number(n||0); if(v>=1e6)return '‚Ç¶'+(v/1e6).toFixed(1)+'M'; if(v>=1e3)return '‚Ç¶'+(v/1e3).toFixed(0)+'K'; return fmtN(v); };
const fmtDT = ts => { if(!ts)return '‚Äî'; try{ const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleDateString('en-NG',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }catch(e){return '‚Äî';} };
const ini   = n  => (n||'U').charAt(0).toUpperCase();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOAD ALL DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadAll() {
  document.getElementById('refreshIcon').classList.add('spin');
  document.getElementById('mainContent').innerHTML = `<div style="text-align:center;padding:60px;color:var(--muted);"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
  try {
    const [userSnap, bonusSnap] = await Promise.all([
      db.collection('users').get(),
      db.collection('referral_bonuses').orderBy('createdAt','desc').get()
    ]);

    /* Build user map */
    allUsers = {};
    userSnap.docs.forEach(d => { allUsers[d.id] = { id:d.id, ...d.data() }; });

    /* All bonus records */
    allBonuses = bonusSnap.docs.map(d => ({ id:d.id, ...d.data() }));

    /* Build referrers list ‚Äî all users who have ‚â•1 L1 referral */
    const l1Map = {}; /* uid ‚Üí l1 count */
    Object.values(allUsers).forEach(u => {
      if (u.referrerUid) {
        l1Map[u.referrerUid] = (l1Map[u.referrerUid] || 0) + 1;
      }
    });

    referrers = Object.keys(l1Map)
      .map(uid => {
        const u = allUsers[uid] || { id:uid };
        /* Count L1, L2, L3 from bonuses */
        const myBonuses = allBonuses.filter(b => b.uplineUid === uid);
        const l1Bonuses = myBonuses.filter(b => b.level === 1);
        const l2Bonuses = myBonuses.filter(b => b.level === 2);
        const l3Bonuses = myBonuses.filter(b => b.level === 3);
        const totalBonus= myBonuses.reduce((s,b) => s+Number(b.bonusAmount||0), 0);
        /* Count direct referrals (L1 users) */
        const l1Users   = Object.values(allUsers).filter(x => x.referrerUid === uid);
        /* Count L2 users */
        const l1Ids     = l1Users.map(x => x.id);
        const l2Users   = Object.values(allUsers).filter(x => l1Ids.includes(x.referrerUid));
        const l2Ids     = l2Users.map(x => x.id);
        const l3Users   = Object.values(allUsers).filter(x => l2Ids.includes(x.referrerUid));
        return {
          ...u,
          l1Count: l1Users.length,
          l2Count: l2Users.length,
          l3Count: l3Users.length,
          l1Users, l2Users, l3Users,
          bonusCount:  myBonuses.length,
          totalBonus,
          l1Bonuses, l2Bonuses, l3Bonuses
        };
      })
      .sort((a,b) => (b.totalBonus||0) - (a.totalBonus||0));

    updateSummary();
    renderActive();
  } catch(e) {
    document.getElementById('mainContent').innerHTML =
      `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Failed to load</div><div class="empty-sub">${e.message}</div></div>`;
  } finally {
    document.getElementById('refreshIcon').classList.remove('spin');
  }
}

function updateSummary() {
  const totalPaid = allBonuses.reduce((s,b) => s+Number(b.bonusAmount||0), 0);
  const l1Count   = allBonuses.filter(b => b.level===1).length;
  const l2Count   = allBonuses.filter(b => b.level===2).length;
  const l3Count   = allBonuses.filter(b => b.level===3).length;

  document.getElementById('sc-users').textContent     = referrers.length;
  document.getElementById('sc-l1').textContent        = l1Count;
  document.getElementById('sc-l2').textContent        = l2Count;
  document.getElementById('sc-l3').textContent        = l3Count;
  document.getElementById('sc-bonuses').textContent   = allBonuses.length;
  document.getElementById('sc-total-paid').textContent= fmtS(totalPaid);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB SWITCHER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchTab(tab, btn) {
  activeTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  /* Show/hide level filter */
  const lf = document.getElementById('levelFilters');
  lf.style.display = tab === 'bonuses' ? 'flex' : 'none';
  renderActive();
}

function renderActive() {
  if (activeTab === 'users')   renderUsersTab();
  else                          renderBonusesTab();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB 1 ‚Äî BY USER CARDS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderUsersTab() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  const list = referrers.filter(u => {
    if (!q) return true;
    return (u.fullName||'').toLowerCase().includes(q)
        || (u.username||'').toLowerCase().includes(q)
        || (u.email||'').toLowerCase().includes(q)
        || (u.referralCode||'').toLowerCase().includes(q);
  });

  const cont = document.getElementById('mainContent');
  if (!list.length) {
    cont.innerHTML = `<div class="empty"><div class="empty-icon">üéÅ</div><div class="empty-title">${referrers.length===0?'No referrals yet':'No results found'}</div></div>`;
    return;
  }

  let html = `<div class="users-grid">`;
  list.forEach(u => {
    html += `
      <div class="user-ref-card" onclick="openDrawer('${u.id}')">
        <div class="urc-head">
          <div class="urc-av">${ini(u.fullName||u.username)}</div>
          <div style="flex:1;min-width:0;">
            <div class="urc-name">${u.fullName||u.username||'‚Äî'}</div>
            <div class="urc-email">${u.email||'‚Äî'}</div>
          </div>
          <div class="urc-code">${u.referralCode||'‚Äî'}</div>
        </div>
        <div class="urc-stats">
          <div class="urc-stat">
            <div class="urc-stat-val" style="color:var(--success);">${fmtS(u.totalBonus)}</div>
            <div class="urc-stat-lbl">Bonus Earned</div>
          </div>
          <div class="urc-stat">
            <div class="urc-stat-val">${u.l1Count+u.l2Count+u.l3Count}</div>
            <div class="urc-stat-lbl">Total Network</div>
          </div>
          <div class="urc-stat">
            <div class="urc-stat-val">${u.bonusCount}</div>
            <div class="urc-stat-lbl">Bonus Pays</div>
          </div>
        </div>
        <div class="urc-levels">
          <span class="lvl-pill l1"><i class="fas fa-user"></i> L1: ${u.l1Count}</span>
          <span class="lvl-pill l2"><i class="fas fa-user"></i> L2: ${u.l2Count}</span>
          <span class="lvl-pill l3"><i class="fas fa-user"></i> L3: ${u.l3Count}</span>
          <i class="fas fa-chevron-right urc-arrow"></i>
        </div>
      </div>`;
  });
  html += `</div>`;
  cont.innerHTML = html;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB 2 ‚Äî BONUS LOGS TABLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setLevelFilter(level, btn) {
  levelFilter = level;
  document.querySelectorAll('#levelFilters .fbtn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderBonusesTab();
}

function renderBonusesTab() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  const list = allBonuses.filter(b => {
    if (levelFilter !== 'all' && String(b.level) !== levelFilter) return false;
    if (!q) return true;
    const upline = allUsers[b.uplineUid] || {};
    const buyer  = allUsers[b.buyerUid]  || {};
    return (upline.fullName||'').toLowerCase().includes(q)
        || (upline.email||'').toLowerCase().includes(q)
        || (buyer.fullName||'').toLowerCase().includes(q)
        || (b.planName||'').toLowerCase().includes(q);
  });

  if (!list.length) {
    document.getElementById('mainContent').innerHTML =
      `<div class="empty"><div class="empty-icon">üí∞</div><div class="empty-title">No bonus records found</div></div>`;
    return;
  }

  let html = `<div style="overflow-x:auto;"><table class="table">
    <thead><tr>
      <th>Earner (Upline)</th>
      <th>Buyer</th>
      <th>Plan Bought</th>
      <th>Invested</th>
      <th>Level</th>
      <th>Rate</th>
      <th>Bonus Earned</th>
      <th>Date</th>
    </tr></thead><tbody>`;

  list.forEach(b => {
    const upline = allUsers[b.uplineUid] || {};
    const buyer  = allUsers[b.buyerUid]  || {};
    html += `<tr>
      <td>
        <div class="u-cell">
          <div class="u-av">${ini(upline.fullName||upline.username)}</div>
          <div>
            <div class="u-name">${upline.fullName||upline.username||'‚Äî'}</div>
            <div class="u-sub">${upline.email||'‚Äî'}</div>
          </div>
        </div>
      </td>
      <td>
        <div class="u-cell">
          <div class="u-av" style="background:linear-gradient(135deg,#aaa,#666);">${ini(buyer.fullName||buyer.username)}</div>
          <div>
            <div class="u-name">${buyer.fullName||buyer.username||'‚Äî'}</div>
            <div class="u-sub">${buyer.email||'‚Äî'}</div>
          </div>
        </div>
      </td>
      <td><span class="plan-tag">${b.planName||'‚Äî'}</span></td>
      <td style="font-weight:700;">${fmtN(b.investAmount)}</td>
      <td><span class="lbadge l${b.level||1}">Level ${b.level||1}</span></td>
      <td style="font-weight:700;color:var(--muted);">${b.ratePercent||'‚Äî'}%</td>
      <td><span class="amt green">${fmtN(b.bonusAmount)}</span></td>
      <td style="font-size:12px;color:var(--muted);white-space:nowrap;">${fmtDT(b.createdAt)}</td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  document.getElementById('mainContent').innerHTML = html;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAWER ‚Äî Full user referral breakdown
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openDrawer(uid) {
  const u = referrers.find(r => r.id === uid);
  if (!u) return;

  document.getElementById('dAv').textContent   = ini(u.fullName||u.username);
  document.getElementById('dName').textContent = u.fullName || u.username || '‚Äî';
  document.getElementById('dSub').textContent  = `${u.email||'‚Äî'} ¬∑ Code: ${u.referralCode||'‚Äî'}`;

  const body = document.getElementById('dbody');
  body.innerHTML = buildDrawerHTML(u);

  document.getElementById('overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function buildDrawerHTML(u) {
  let html = '';

  /* Stats */
  html += `
    <div class="d-stats">
      <div class="d-stat"><div class="d-stat-val" style="color:var(--success);">${fmtS(u.totalBonus)}</div><div class="d-stat-lbl">Total Bonus</div></div>
      <div class="d-stat"><div class="d-stat-val">${u.l1Count+u.l2Count+u.l3Count}</div><div class="d-stat-lbl">Network Size</div></div>
      <div class="d-stat"><div class="d-stat-val">${u.bonusCount}</div><div class="d-stat-lbl">Bonus Pays</div></div>
    </div>
    <div class="d-stats">
      <div class="d-stat"><div class="d-stat-val" style="color:var(--primary);">${u.l1Count}</div><div class="d-stat-lbl">L1 (25%)</div></div>
      <div class="d-stat"><div class="d-stat-val" style="color:var(--success);">${u.l2Count}</div><div class="d-stat-lbl">L2 (2%)</div></div>
      <div class="d-stat"><div class="d-stat-val" style="color:var(--warning);">${u.l3Count}</div><div class="d-stat-lbl">L3 (1%)</div></div>
    </div>`;

  /* ‚îÄ‚îÄ L1 Tree ‚îÄ‚îÄ */
  if (u.l1Users.length > 0) {
    html += `<div class="slabel">üîµ Level 1 ‚Äî Direct Referrals (25%)</div>`;
    u.l1Users.forEach(l1 => {
      const l1Investments = Object.values(allUsers).length > 0
        ? u.l1Bonuses.filter(b => b.buyerUid === l1.id)
        : [];
      const l1TotalInvested = l1Investments.reduce((s,b) => s+Number(b.investAmount||0), 0);
      const l1BonusEarned   = l1Investments.reduce((s,b) => s+Number(b.bonusAmount||0), 0);

      html += `
        <div class="tree-row l1">
          <div class="tree-head">
            <div class="tree-av l1">${ini(l1.fullName||l1.username)}</div>
            <div style="flex:1;min-width:0;">
              <div class="tree-name">${l1.fullName||l1.username||'‚Äî'}</div>
              <div class="tree-email">${l1.email||'‚Äî'}</div>
            </div>
            <span class="lbadge l1">L1</span>
          </div>
          <div class="tree-fields">
            <div class="tf"><div class="tf-lbl">Invested</div><div class="tf-val" style="color:var(--primary);">${fmtS(l1.totalInvested)}</div></div>
            <div class="tf"><div class="tf-lbl">Balance</div><div class="tf-val" style="color:var(--success);">${fmtS(l1.balance)}</div></div>
            <div class="tf"><div class="tf-lbl">Bonus Paid</div><div class="tf-val" style="color:var(--success);">${fmtS(l1BonusEarned)}</div></div>
          </div>
        </div>`;

      /* L2 under this L1 */
      const l2UnderThis = u.l2Users.filter(l2 => l2.referrerUid === l1.id);
      l2UnderThis.forEach(l2 => {
        const l2Bonuses     = u.l2Bonuses.filter(b => b.buyerUid === l2.id);
        const l2BonusEarned = l2Bonuses.reduce((s,b) => s+Number(b.bonusAmount||0), 0);

        html += `
          <div class="tree-row l2">
            <div class="tree-head">
              <div class="tree-av l2">${ini(l2.fullName||l2.username)}</div>
              <div style="flex:1;min-width:0;">
                <div class="tree-name">${l2.fullName||l2.username||'‚Äî'}</div>
                <div class="tree-email">${l2.email||'‚Äî'}</div>
              </div>
              <span class="lbadge l2">L2</span>
            </div>
            <div class="tree-fields">
              <div class="tf"><div class="tf-lbl">Invested</div><div class="tf-val" style="color:var(--primary);">${fmtS(l2.totalInvested)}</div></div>
              <div class="tf"><div class="tf-lbl">Balance</div><div class="tf-val" style="color:var(--success);">${fmtS(l2.balance)}</div></div>
              <div class="tf"><div class="tf-lbl">Bonus Paid</div><div class="tf-val" style="color:var(--success);">${fmtS(l2BonusEarned)}</div></div>
            </div>
          </div>`;

        /* L3 under this L2 */
        const l3UnderThis = u.l3Users.filter(l3 => l3.referrerUid === l2.id);
        l3UnderThis.forEach(l3 => {
          const l3Bonuses     = u.l3Bonuses.filter(b => b.buyerUid === l3.id);
          const l3BonusEarned = l3Bonuses.reduce((s,b) => s+Number(b.bonusAmount||0), 0);

          html += `
            <div class="tree-row l3">
              <div class="tree-head">
                <div class="tree-av l3">${ini(l3.fullName||l3.username)}</div>
                <div style="flex:1;min-width:0;">
                  <div class="tree-name">${l3.fullName||l3.username||'‚Äî'}</div>
                  <div class="tree-email">${l3.email||'‚Äî'}</div>
                </div>
                <span class="lbadge l3">L3</span>
              </div>
              <div class="tree-fields">
                <div class="tf"><div class="tf-lbl">Invested</div><div class="tf-val" style="color:var(--primary);">${fmtS(l3.totalInvested)}</div></div>
                <div class="tf"><div class="tf-lbl">Balance</div><div class="tf-val" style="color:var(--success);">${fmtS(l3.balance)}</div></div>
                <div class="tf"><div class="tf-lbl">Bonus Paid</div><div class="tf-val" style="color:var(--success);">${fmtS(l3BonusEarned)}</div></div>
              </div>
            </div>`;
        });
      });
    });
  } else {
    html += `<div class="empty" style="padding:24px 0;"><div class="empty-icon" style="font-size:32px;">üë•</div><div class="empty-title" style="font-size:14px;">No referrals yet</div></div>`;
  }

  /* ‚îÄ‚îÄ Bonus log ‚îÄ‚îÄ */
  html += `<div class="slabel">üí∞ All Bonus Payments</div>`;
  const myBonuses = allBonuses.filter(b => b.uplineUid === u.id);
  if (myBonuses.length === 0) {
    html += `<div style="font-size:13px;color:var(--muted);padding:10px 0;">No bonus payments yet</div>`;
  } else {
    myBonuses.forEach(b => {
      const buyer = allUsers[b.buyerUid] || {};
      html += `
        <div class="bonus-item">
          <div>
            <div class="bi-plan">${b.planName||'‚Äî'} <span class="lbadge l${b.level}" style="margin-left:4px;">L${b.level}</span></div>
            <div class="bi-sub">Buyer: ${buyer.fullName||buyer.username||'‚Äî'} ¬∑ ${fmtN(b.investAmount)} invested ¬∑ ${b.ratePercent||'‚Äî'}%</div>
          </div>
          <div class="bi-right">
            <div class="bi-amt">+${fmtN(b.bonusAmount)}</div>
            <div class="bi-date">${fmtDT(b.createdAt)}</div>
          </div>
        </div>`;
    });
  }

  return html;
}

function closeDrawer(e) { if(e.target===document.getElementById('overlay')) closeDrawerDirect(); }
function closeDrawerDirect() {
  document.getElementById('overlay').classList.remove('open');
  document.body.style.overflow = '';
}
</script>
</body>
</html>

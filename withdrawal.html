<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cashpoint | Withdrawal</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary:       #0052FF;
    --primary-light: #3b7dff;
    --primary-dark:  #0039b3;
    --accent:        #00D4A0;
    --accent-dark:   #00a87e;
    --warning:       #FFB800;
    --danger:        #FF4D6D;
    --success:       #00C48C;
    --bg:            #F0F4FF;
    --card:          #ffffff;
    --text:          #0D1B3E;
    --muted:         #6B7A99;
    --border:        #D8E0F0;
    --nav-h:         70px;
    --bottom-h:      72px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: calc(var(--bottom-h) + 20px);
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â• */
  .topbar {
    position: sticky; top: 0; z-index: 900;
    height: var(--nav-h);
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
    justify-content: space-between;
    padding: 0 20px; gap: 12px;
  }
  .topbar-left { display: flex; align-items: center; gap: 10px; }
  .topbar-logo {
    width: 38px; height: 38px; background: var(--primary);
    border-radius: 11px; display: flex; align-items: center;
    justify-content: center; font-size: 20px; flex-shrink: 0;
  }
  .topbar-brand {
    font-family: 'Sora', sans-serif; font-size: 20px;
    font-weight: 700; color: var(--text); letter-spacing: -0.3px;
  }
  .topbar-right { display: flex; align-items: center; gap: 10px; }
  .topbar-clock { font-size: 12.5px; color: var(--muted); font-weight: 600; display: none; }
  @media(min-width:520px){ .topbar-clock { display: block; } }
  .user-avatar {
    width: 38px; height: 38px; border-radius: 11px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 800; font-size: 15px; cursor: pointer;
  }

  /* â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â• */
  .hero {
    background: linear-gradient(135deg, #FF4D6D 0%, #c0392b 55%, #7b1e2e 100%);
    padding: 28px 22px 90px;
    position: relative; overflow: hidden;
  }
  .hero::before {
    content: ''; position: absolute; width: 360px; height: 360px;
    border-radius: 50%; background: rgba(255,255,255,0.05); top: -100px; right: -80px;
  }
  .hero::after {
    content: ''; position: absolute; width: 200px; height: 200px;
    border-radius: 50%; background: rgba(255,255,255,0.04); bottom: -60px; left: -40px;
  }
  .hero-tag {
    font-size: 11.5px; font-weight: 700; color: rgba(255,255,255,0.65);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin-bottom: 5px; position: relative; z-index: 1;
  }
  .hero-title {
    font-family: 'Sora', sans-serif; font-size: clamp(22px,5.5vw,30px);
    font-weight: 700; color: #fff; margin-bottom: 6px; position: relative; z-index: 1;
  }
  .hero-sub { font-size: 13px; color: rgba(255,255,255,0.65); font-weight: 500; position: relative; z-index: 1; }

  /* â•â•â•â•â•â•â•â• BALANCE CARD â•â•â•â•â•â•â•â• */
  .balance-outer {
    padding: 0 16px; margin-top: -52px; position: relative; z-index: 10;
  }
  .balance-card {
    background: white; border-radius: 22px;
    box-shadow: 0 14px 44px rgba(255,77,109,0.18);
    padding: 18px 22px;
    display: flex; align-items: center;
    justify-content: space-between; gap: 12px; flex-wrap: wrap;
    animation: riseUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
  }
  @keyframes riseUp {
    from { opacity:0; transform:translateY(22px); }
    to   { opacity:1; transform:translateY(0); }
  }
  .bal-lbl { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
  .bal-amount {
    font-family: 'Sora', sans-serif; font-size: clamp(22px,5.5vw,30px);
    font-weight: 700; color: var(--text); letter-spacing: -1px; line-height: 1;
  }
  .bal-amount .sym { font-size: 14px; color: var(--muted); font-weight: 600; }
  .bal-right { text-align: right; }
  .min-badge {
    display: inline-flex; align-items: center; gap: 5px;
    background: #E8FFF6; color: var(--success); border-radius: 99px;
    padding: 5px 12px; font-size: 12px; font-weight: 700;
  }
  .pending-pill {
    display: inline-flex; align-items: center; gap: 5px;
    background: #FFF8E8; color: var(--warning); border-radius: 99px;
    padding: 4px 11px; font-size: 11.5px; font-weight: 700;
    border: 1.5px solid #ffe0a0; margin-top: 6px;
  }

  /* â•â•â•â•â•â•â•â• SECTION â•â•â•â•â•â•â•â• */
  .section { padding: 24px 16px 0; }
  .section-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .section-title { font-family: 'Sora', sans-serif; font-size: 17px; font-weight: 700; color: var(--text); }

  /* â•â•â•â•â•â•â•â• NO INVESTMENT STATE â•â•â•â•â•â•â•â• */
  .no-invest-box {
    background: white; border-radius: 20px; padding: 44px 24px; text-align: center;
    box-shadow: 0 4px 20px rgba(0,82,255,0.08);
  }
  .no-invest-emoji { font-size: 54px; margin-bottom: 14px; }
  .no-invest-title { font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
  .no-invest-sub { font-size: 14px; color: var(--muted); line-height: 1.6; margin-bottom: 20px; }
  .no-invest-cta {
    display: inline-block; padding: 13px 30px; background: var(--primary); color: white;
    border: none; border-radius: 99px; font-size: 14px; font-weight: 700; font-family: inherit;
    cursor: pointer; text-decoration: none;
    box-shadow: 0 6px 20px rgba(0,82,255,0.28); transition: transform 0.15s, box-shadow 0.15s;
  }
  .no-invest-cta:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,82,255,0.36); }

  /* â•â•â•â•â•â•â•â• INFO STRIP â•â•â•â•â•â•â•â• */
  .info-strip {
    background: #FFF8E8; border: 1.5px solid #ffe0a0; border-radius: 16px;
    padding: 14px 18px; display: flex; align-items: flex-start; gap: 12px;
    animation: riseUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
  }
  .info-strip-icon { font-size: 22px; flex-shrink: 0; }
  .info-strip-title { font-size: 13px; font-weight: 700; color: #856404; margin-bottom: 3px; }
  .info-strip-sub   { font-size: 12px; color: #856404; line-height: 1.5; }

  /* â•â•â•â•â•â•â•â• FORM CARD â•â•â•â•â•â•â•â• */
  .form-card {
    background: white; border-radius: 22px;
    box-shadow: 0 6px 24px rgba(0,82,255,0.09);
    overflow: hidden;
    animation: riseUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
  }
  .form-card-head {
    background: linear-gradient(135deg, #FF4D6D, #c0392b);
    padding: 16px 22px; display: flex; align-items: center; gap: 12px;
  }
  .form-card-icon { font-size: 22px; }
  .form-card-title { font-family: 'Sora', sans-serif; font-size: 16px; font-weight: 700; color: white; }
  .form-card-sub   { font-size: 12px; color: rgba(255,255,255,0.8); font-weight: 500; }

  .form-body { padding: 22px; display: flex; flex-direction: column; gap: 16px; }

  /* Amount selector */
  .amount-section {}
  .amount-lbl {
    font-size: 11.5px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px;
    display: flex; align-items: center; gap: 6px;
  }
  .quick-amounts {
    display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 12px;
  }
  @media(min-width:440px){ .quick-amounts { grid-template-columns: repeat(4,1fr); } }
  .qa-btn {
    background: var(--bg); border: 2px solid var(--border);
    border-radius: 11px; padding: 10px 6px; text-align: center;
    font-size: 12.5px; font-weight: 700; color: var(--text);
    font-family: inherit; cursor: pointer; transition: all 0.2s;
  }
  .qa-btn:hover { border-color: var(--danger); background: #fff0f3; }
  .qa-btn.active { background: #FF4D6D; color: white; border-color: #FF4D6D; }

  /* Input group */
  .input-group {}
  .ig-label {
    font-size: 12px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;
    display: flex; align-items: center; gap: 6px;
  }
  .ig-label i { font-size: 12px; color: var(--primary); }
  .ig-row {
    display: flex; align-items: center; gap: 0;
    border: 2px solid var(--border); border-radius: 13px; overflow: hidden;
    transition: border-color 0.2s;
  }
  .ig-row:focus-within { border-color: #FF4D6D; }
  .ig-prefix {
    padding: 13px 14px; background: var(--bg); font-size: 16px;
    font-weight: 700; color: var(--muted); border-right: 2px solid var(--border);
    flex-shrink: 0;
  }
  .ig-input {
    flex: 1; padding: 13px 14px; font-size: 16px; font-weight: 700;
    font-family: inherit; border: none; outline: none; color: var(--text); min-width: 0;
  }
  .ig-input::placeholder { color: var(--border); font-weight: 500; }
  .ig-plain {
    width: 100%; padding: 13px 16px; font-size: 15px; font-weight: 600;
    font-family: inherit; border: 2px solid var(--border); border-radius: 13px;
    outline: none; color: var(--text); background: white; transition: border-color 0.2s;
  }
  .ig-plain:focus { border-color: #FF4D6D; }
  .ig-plain::placeholder { color: var(--border); font-weight: 400; }

  /* Amount preview */
  .amt-preview {
    border-radius: 14px; overflow: hidden;
    display: none; flex-direction: column; gap: 0;
  }
  .amt-preview.show { display: flex; }

  /* Top row â€” requested vs fee */
  .ap-top {
    background: linear-gradient(135deg, #FF4D6D, #c0392b);
    padding: 14px 18px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .ap-lbl { font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.7); margin-bottom: 3px; }
  .ap-amt { font-family: 'Sora', sans-serif; font-size: 24px; font-weight: 700; color: white; }
  .ap-sub { font-size: 12px; color: rgba(255,255,255,0.75); font-weight: 600; }

  /* Bottom row â€” you receive (green) */
  .ap-receive {
    background: linear-gradient(135deg, #00C48C, #009e72);
    padding: 12px 18px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .ap-receive-lbl { font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.8); margin-bottom: 2px; }
  .ap-receive-amt { font-family: 'Sora', sans-serif; font-size: 22px; font-weight: 700; color: white; }
  .ap-bal { font-size: 12px; color: rgba(255,255,255,0.8); font-weight: 600; }

  /* Divider */
  .form-divider {
    display: flex; align-items: center; gap: 12px; margin: 4px 0;
  }
  .form-divider span { font-size: 12px; font-weight: 700; color: var(--muted); flex-shrink: 0; }
  .form-divider::before, .form-divider::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  /* Submit button */
  .submit-btn {
    width: 100%; padding: 15px; border: none; border-radius: 14px;
    font-size: 16px; font-weight: 700; font-family: inherit; cursor: pointer;
    color: white;
    background: linear-gradient(135deg, #FF4D6D, #c0392b);
    box-shadow: 0 7px 26px rgba(255,77,109,0.35);
    display: flex; align-items: center; justify-content: center; gap: 9px;
    transition: transform 0.15s, box-shadow 0.15s, opacity 0.2s;
  }
  .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 34px rgba(255,77,109,0.45); }
  .submit-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none !important; }

  /* â•â•â•â•â•â•â•â• WITHDRAWAL HISTORY â•â•â•â•â•â•â•â• */
  .wdl-list { display: flex; flex-direction: column; gap: 10px; }
  .wdl-item {
    background: white; border-radius: 16px; padding: 14px 18px;
    display: flex; align-items: center; gap: 14px;
    box-shadow: 0 3px 12px rgba(0,82,255,0.06);
    animation: riseUp 0.4s cubic-bezier(0.16,1,0.3,1) both;
  }
  .wdl-icon {
    width: 44px; height: 44px; border-radius: 13px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .wdl-icon.pending  { background: #FFF8E8; }
  .wdl-icon.approved { background: #E8FFF6; }
  .wdl-icon.rejected { background: #FFF0F3; }
  .wdl-info { flex: 1; min-width: 0; }
  .wdl-amount { font-size: 16px; font-weight: 700; color: var(--text); }
  .wdl-bank   { font-size: 11.5px; color: var(--muted); font-weight: 600; margin-top: 2px;
                white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .wdl-date   { font-size: 10.5px; color: var(--muted); font-weight: 500; margin-top: 2px; }
  .wdl-right  { text-align: right; flex-shrink: 0; }
  .wdl-badge  {
    display: inline-block; padding: 4px 12px; border-radius: 99px;
    font-size: 11px; font-weight: 700; text-transform: capitalize;
  }
  .wdl-badge.pending  { background: #FFF8E8; color: var(--warning); }
  .wdl-badge.approved { background: #E8FFF6; color: var(--success); }
  .wdl-badge.rejected { background: #FFF0F3; color: var(--danger); }
  .wdl-ref { font-size: 10px; color: var(--muted); font-weight: 600; margin-top: 3px; }

  .empty-history {
    background: white; border-radius: 16px; padding: 36px 24px; text-align: center;
    box-shadow: 0 3px 12px rgba(0,82,255,0.06);
  }
  .empty-history-emoji { font-size: 42px; margin-bottom: 10px; }
  .empty-history-title { font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 5px; }
  .empty-history-sub   { font-size: 13px; color: var(--muted); }

  /* â•â•â•â•â•â•â•â• SKELETON â•â•â•â•â•â•â•â• */
  .skeleton {
    background: linear-gradient(90deg,#e8edf5 25%,#f4f7fc 50%,#e8edf5 75%);
    background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 9px;
  }
  @keyframes shimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }

  /* â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â• */
  .bottom-nav {
    position: fixed; bottom: 0; left: 0;
    width: 100%; height: var(--bottom-h);
    background: white; border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-around;
    padding: 0 8px; z-index: 999;
    box-shadow: 0 -4px 24px rgba(0,82,255,0.09);
  }
  .nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    text-decoration: none; padding: 8px 12px; border-radius: 14px;
    flex: 1; max-width: 74px; transition: background 0.2s; cursor: pointer;
  }
  .nav-item:hover { background: var(--bg); }
  .nav-item i { font-size: 20px; color: var(--muted); transition: color 0.2s, transform 0.2s; }
  .nav-item span { font-size: 10.5px; font-weight: 700; color: var(--muted); transition: color 0.2s; }
  .nav-item.active i, .nav-item.active span { color: var(--danger); }
  .nav-item.active i { transform: translateY(-2px); }
  .nav-center {
    width: 52px; height: 52px; border-radius: 16px; background: var(--primary);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 6px 22px rgba(0,82,255,0.38);
    text-decoration: none; transition: transform 0.2s; margin-bottom: 10px; flex-shrink: 0;
  }
  .nav-center:hover { transform: translateY(-3px); }
  .nav-center i { color: white; font-size: 21px; }

  .page-bottom { height: 16px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â• -->
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo">ğŸ’°</div>
    <span class="topbar-brand">Withdraw</span>
  </div>
  <div class="topbar-right">
    <span class="topbar-clock" id="topClock">--:--</span>
    <div class="user-avatar" id="avatarBox">?</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â•â•â• -->
<div class="hero">
  <div class="hero-tag">Cash Out</div>
  <div class="hero-title">Request Withdrawal ğŸ’¸</div>
  <div class="hero-sub">Manual processing Â· Confirmed within 24 hours</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• BALANCE CARD â•â•â•â•â•â•â•â•â•â• -->
<div class="balance-outer">
  <div class="balance-card">
    <div>
      <div class="bal-lbl">Available Balance</div>
      <div class="bal-amount">
        <span class="sym">â‚¦</span><span id="balanceDisplay">0.00</span>
      </div>
    </div>
    <div class="bal-right">
      <div class="min-badge">
        <i class="fas fa-arrow-down" style="font-size:9px;"></i> Min â‚¦1,000
      </div>
      <div id="pendingPill" style="display:none;">
        <div class="pending-pill">
          <i class="fas fa-clock" style="font-size:10px;"></i>
          <span id="pendingCount">0</span> Pending
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• DYNAMIC CONTENT â•â•â•â•â•â•â•â•â•â• -->
<div id="mainContent">
  <!-- Skeleton while loading -->
  <div class="section">
    <div style="background:white;border-radius:22px;padding:22px;box-shadow:0 4px 16px rgba(0,82,255,0.07);">
      <div class="skeleton" style="height:17px;width:55%;margin-bottom:16px;"></div>
      <div class="skeleton" style="height:50px;margin-bottom:12px;"></div>
      <div class="skeleton" style="height:50px;margin-bottom:12px;"></div>
      <div class="skeleton" style="height:50px;margin-bottom:16px;"></div>
      <div class="skeleton" style="height:52px;border-radius:14px;"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• WITHDRAWAL HISTORY â•â•â•â•â•â•â•â•â•â• -->
<div class="section" id="historySection">
  <div class="section-head">
    <div class="section-title">Withdrawal History</div>
  </div>
  <div class="wdl-list" id="wdlList">
    <div style="background:white;border-radius:16px;padding:14px 18px;display:flex;gap:14px;align-items:center;">
      <div class="skeleton" style="width:44px;height:44px;border-radius:13px;flex-shrink:0;"></div>
      <div style="flex:1;">
        <div class="skeleton" style="height:14px;width:45%;margin-bottom:7px;"></div>
        <div class="skeleton" style="height:11px;width:60%;"></div>
      </div>
    </div>
    <div style="background:white;border-radius:16px;padding:14px 18px;display:flex;gap:14px;align-items:center;">
      <div class="skeleton" style="width:44px;height:44px;border-radius:13px;flex-shrink:0;"></div>
      <div style="flex:1;">
        <div class="skeleton" style="height:14px;width:38%;margin-bottom:7px;"></div>
        <div class="skeleton" style="height:11px;width:55%;"></div>
      </div>
    </div>
  </div>
</div>

<div class="page-bottom"></div>

<!-- â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â• -->
<div class="bottom-nav">
  <a href="home.html" class="nav-item">
    <i class="fas fa-home"></i><span>Home</span>
  </a>
  <a href="plans.html" class="nav-item">
    <i class="fas fa-chart-line"></i><span>Plans</span>
  </a>
  <a href="investments.html" class="nav-center" title="My Investments">
    <i class="fas fa-wallet"></i>
  </a>
  <a href="referrals.html" class="nav-item">
    <i class="fas fa-users"></i><span>Referrals</span>
  </a>
  <a href="dashboard.html" class="nav-item active">
    <i class="fas fa-money-check-alt"></i><span>Withdraw</span>
  </a>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â•â•â•â•â•â•â• -->
<script>

/* â”€â”€ Firebase â”€â”€ */
const firebaseConfig = {
  apiKey:            "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
  authDomain:        "cashpoint-ac4f4.firebaseapp.com",
  projectId:         "cashpoint-ac4f4",
  storageBucket:     "cashpoint-ac4f4.firebasestorage.app",
  messagingSenderId: "16133206416",
  appId:             "1:16133206416:web:a093f4e153ad2c9bcc8315"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* â”€â”€ State â”€â”€ */
let currentUserId = null;
let currentUserData = {};
let currentBalance  = 0;
let selectedAmount  = 0;
const MIN_WITHDRAW  = 1000;

/* â”€â”€ Quick withdrawal presets â”€â”€ */
const QUICK_AMOUNTS = [1000, 2000, 5000, 10000, 20000, 50000, 100000, 200000];

/* â”€â”€ Clock â”€â”€ */
function tickClock() {
  document.getElementById('topClock').textContent =
    new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
}
tickClock();
setInterval(tickClock, 1000);

/* â”€â”€ Formatters â”€â”€ */
function fmtFull(n) {
  return Number(n||0).toLocaleString('en-NG', { minimumFractionDigits:2, maximumFractionDigits:2 });
}
function fmtN(n) {
  return Number(n||0).toLocaleString('en-NG');
}

/* â”€â”€ Auth â”€â”€ */
auth.onAuthStateChanged(async (user) => {
  if (!user) { window.location.href = 'login.html'; return; }
  currentUserId = user.uid;
  await loadPage();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadPage() {
  try {
    /* â”€â”€ Check if admin has closed withdrawals â”€â”€ */
    try {
      const settingSnap = await db.collection('settings').doc('withdrawals').get();
      if (settingSnap.exists && settingSnap.data().isOpen === false) {
        renderWithdrawalsClosed();
        return;
      }
    } catch(e) { /* If read fails, continue â€” default is open */ }

    /* Fetch user document */
    const uSnap = await db.collection('users').doc(currentUserId).get();
    if (!uSnap.exists) { window.location.href = 'login.html'; return; }

    currentUserData = uSnap.data();
    currentBalance  = Number(currentUserData.balance || 0);

    /* Avatar */
    const fn = (currentUserData.fullName || currentUserData.username || 'U').split(' ')[0];
    document.getElementById('avatarBox').textContent = fn.charAt(0).toUpperCase();

    /* Balance display */
    document.getElementById('balanceDisplay').textContent = fmtFull(currentBalance);

    /* Check if user has an active investment */
    const invSnap = await db.collection('investments')
      .where('userId', '==', currentUserId)
      .where('active', '==', true)
      .limit(1)
      .get();

    if (invSnap.empty) {
      /* No active plan â€” show locked state */
      renderLockedState();
    } else {
      /* Has active plan â€” show withdrawal form */
      renderWithdrawForm();
    }

    /* Load history regardless */
    await loadHistory();

  } catch(err) {
    console.error('Page load error:', err);
    Swal.fire({ icon:'error', title:'Load Failed', text:'Please refresh the page.', confirmButtonColor:'#FF4D6D' });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCKED STATE â€” no active investment
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderWithdrawalsClosed() {
  const container = document.getElementById('mainContent') || document.querySelector('.page-content') || document.body;
  /* Find the form area and replace it */
  const formArea = document.getElementById('withdrawFormArea') || document.getElementById('formWrap');
  const target   = formArea || container;

  const closedHTML = `
    <div style="text-align:center;padding:48px 20px;max-width:400px;margin:0 auto;">
      <div style="font-size:58px;margin-bottom:16px;">ğŸ”’</div>
      <div style="font-family:'Sora',sans-serif;font-size:20px;font-weight:700;color:#0D1B3E;margin-bottom:10px;">Withdrawals Temporarily Closed</div>
      <div style="font-size:14px;color:#6B7A99;font-weight:600;line-height:1.7;">
        Withdrawals are currently unavailable.<br>
        Please check back later or contact support.
      </div>
    </div>`;

  /* Try to find the content area to replace */
  const pageInner = document.getElementById('pageInner')
    || document.getElementById('formContainer')
    || document.querySelector('.form-card')
    || document.querySelector('main');

  if (pageInner) {
    pageInner.innerHTML = closedHTML;
  } else {
    /* Fallback â€” show as Swal */
    Swal.fire({
      icon: 'info',
      title: 'ğŸ”’ Withdrawals Closed',
      html: '<div style="font-size:14px;color:#6B7A99;line-height:1.7;">Withdrawals are temporarily unavailable.<br>Please check back later.</div>',
      confirmButtonText: 'Go Back',
      confirmButtonColor: '#0052FF'
    }).then(() => window.history.back());
  }
}

function renderLockedState() {
  document.getElementById('mainContent').innerHTML = `
    <div class="section">
      <div class="no-invest-box">
        <div class="no-invest-emoji">ğŸ”’</div>
        <div class="no-invest-title">Withdrawals Require an Active Plan</div>
        <div class="no-invest-sub">
          You need at least one active investment plan to request a withdrawal.<br>
          Buy a plan first, earn your daily ROI, then cash out anytime!
        </div>
        <a href="plans.html" class="no-invest-cta">Browse Investment Plans</a>
      </div>
    </div>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WITHDRAWAL FORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderWithdrawForm() {
  /* Build quick amount buttons â€” only show amounts â‰¤ balance */
  const quickBtns = QUICK_AMOUNTS
    .filter(a => a <= currentBalance)
    .map(a => `
      <button class="qa-btn" data-amount="${a}" onclick="selectQuick(${a}, this)">
        â‚¦${fmtN(a)}
      </button>
    `).join('');

  document.getElementById('mainContent').innerHTML = `

    <!-- Info strip -->
    <div class="section">
      <div class="info-strip">
        <div class="info-strip-icon">â„¹ï¸</div>
        <div>
          <div class="info-strip-title">Manual Withdrawal â€” Processed Within 24 Hours</div>
          <div class="info-strip-sub">
            Your balance will be deducted immediately upon submission.
            Admin will review and transfer to your bank account within 24 hours.
            Minimum: <b>â‚¦${fmtN(MIN_WITHDRAW)}</b>
          </div>
        </div>
      </div>
    </div>

    <!-- Form card -->
    <div class="section">
      <div class="form-card">
        <div class="form-card-head">
          <div class="form-card-icon">ğŸ’¸</div>
          <div>
            <div class="form-card-title">Withdrawal Request</div>
            <div class="form-card-sub">Balance: â‚¦${fmtFull(currentBalance)}</div>
          </div>
        </div>

        <div class="form-body">

          <!-- Quick amount selector -->
          ${quickBtns ? `
            <div class="amount-section">
              <div class="amount-lbl"><i class="fas fa-bolt" style="color:var(--warning);"></i> Quick Select</div>
              <div class="quick-amounts" id="quickAmountsGrid">
                ${quickBtns}
              </div>
            </div>

            <div class="form-divider"><span>or enter custom</span></div>
          ` : ''}

          <!-- Amount input -->
          <div class="input-group">
            <div class="ig-label"><i class="fas fa-naira-sign"></i> Withdrawal Amount</div>
            <div class="ig-row">
              <div class="ig-prefix">â‚¦</div>
              <input
                class="ig-input"
                id="withdrawAmount"
                type="number"
                placeholder="Min â‚¦${fmtN(MIN_WITHDRAW)}"
                min="${MIN_WITHDRAW}"
                max="${currentBalance}"
                oninput="onAmountInput(this.value)"
              />
            </div>
          </div>

          <!-- Amount preview -->
          <div class="amt-preview" id="amtPreview">
            <!-- Top: requested amount + fee -->
            <div class="ap-top">
              <div>
                <div class="ap-lbl">You Request</div>
                <div class="ap-amt" id="previewAmt">â‚¦0</div>
              </div>
              <div style="text-align:right;">
                <div class="ap-lbl">10% Charge</div>
                <div class="ap-amt" id="previewFee">â‚¦0</div>
              </div>
            </div>
            <!-- Bottom: you receive -->
            <div class="ap-receive">
              <div>
                <div class="ap-receive-lbl">âœ… You Will Receive</div>
                <div class="ap-receive-amt" id="previewReceive">â‚¦0</div>
              </div>
              <div style="text-align:right;">
                <div class="ap-receive-lbl">Balance After</div>
                <div class="ap-bal" id="previewBal">â‚¦0</div>
              </div>
            </div>
          </div>

          <div class="form-divider"><span>bank details</span></div>

          <!-- Bank Name -->
          <div class="input-group">
            <div class="ig-label"><i class="fas fa-university"></i> Bank Name</div>
            <input
              class="ig-plain"
              id="bankName"
              type="text"
              placeholder="e.g. Opay, PalmPay, GTBank, Access..."
            />
          </div>

          <!-- Account Name -->
          <div class="input-group">
            <div class="ig-label"><i class="fas fa-user"></i> Account Name</div>
            <input
              class="ig-plain"
              id="accountName"
              type="text"
              placeholder="Enter your full account name"
            />
          </div>

          <!-- Account Number -->
          <div class="input-group">
            <div class="ig-label"><i class="fas fa-credit-card"></i> Account Number</div>
            <input
              class="ig-plain"
              id="accountNumber"
              type="tel"
              maxlength="10"
              placeholder="10-digit account number"
            />
          </div>

          <!-- Submit -->
          <button class="submit-btn" id="submitWdlBtn" onclick="submitWithdrawal()">
            <i class="fas fa-paper-plane"></i>
            Submit Withdrawal Request
          </button>

        </div>
      </div>
    </div>
  `;
}

/* â”€â”€ Quick amount click â”€â”€ */
function selectQuick(amount, btn) {
  document.querySelectorAll('.qa-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedAmount = amount;
  document.getElementById('withdrawAmount').value = amount;
  updatePreview(amount);
}

/* â”€â”€ Custom amount typed â”€â”€ */
function onAmountInput(val) {
  document.querySelectorAll('.qa-btn').forEach(b => b.classList.remove('active'));
  const n = parseInt(val) || 0;
  selectedAmount = n;
  if (n >= MIN_WITHDRAW) {
    updatePreview(n);
  } else {
    document.getElementById('amtPreview').classList.remove('show');
  }
}

const WITHDRAWAL_FEE_PCT = 15; /* 15% withdrawal processing fee */

function updatePreview(amount) {
  const preview   = document.getElementById('amtPreview');
  const fee       = Math.round(amount * WITHDRAWAL_FEE_PCT / 100);
  const receive   = Math.max(0, amount - fee);
  const remaining = Math.max(0, currentBalance - amount);

  document.getElementById('previewAmt').textContent     = 'â‚¦' + fmtN(amount);
  document.getElementById('previewFee').textContent     = 'â‚¦' + fmtN(fee);
  document.getElementById('previewReceive').textContent = 'â‚¦' + fmtN(receive);
  document.getElementById('previewBal').textContent     = 'â‚¦' + fmtFull(remaining);
  preview.classList.add('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBMIT WITHDRAWAL
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. Validate all fields
   2. Confirm with user
   3. Run Firestore transaction:
      - Deduct from user balance immediately
      - Create withdrawal document with ALL
        user info for admin panel
   4. Show success + update UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function submitWithdrawal() {
  const btn           = document.getElementById('submitWdlBtn');
  const amountVal     = parseInt(document.getElementById('withdrawAmount').value) || 0;
  const bankName      = document.getElementById('bankName').value.trim();
  const accountName   = document.getElementById('accountName').value.trim();
  const accountNumber = document.getElementById('accountNumber').value.trim();

  /* â”€â”€ Validation â”€â”€ */
  if (amountVal < MIN_WITHDRAW) {
    Swal.fire({ icon:'warning', title:'Amount Too Low', text:`Minimum withdrawal is â‚¦${fmtN(MIN_WITHDRAW)}.`, confirmButtonColor:'#FF4D6D' });
    return;
  }
  if (amountVal > currentBalance) {
    Swal.fire({ icon:'warning', title:'Insufficient Balance', text:`Your balance is â‚¦${fmtFull(currentBalance)}. You cannot withdraw more than your balance.`, confirmButtonColor:'#FF4D6D' });
    return;
  }
  if (!bankName) {
    Swal.fire({ icon:'warning', title:'Bank Name Required', text:'Please enter your bank name.', confirmButtonColor:'#FF4D6D' });
    return;
  }
  if (!accountName) {
    Swal.fire({ icon:'warning', title:'Account Name Required', text:'Please enter your account name.', confirmButtonColor:'#FF4D6D' });
    return;
  }
  if (!accountNumber || accountNumber.length < 8) {
    Swal.fire({ icon:'warning', title:'Invalid Account Number', text:'Please enter a valid account number (minimum 8 digits).', confirmButtonColor:'#FF4D6D' });
    return;
  }

  /* â”€â”€ Confirmation dialog â”€â”€ */
  const confirm = await Swal.fire({
    icon: 'warning',
    title: 'Confirm Withdrawal',
    html: `
      <div style="font-family:'Plus Jakarta Sans',sans-serif;text-align:left;">
        <div style="background:#FFF0F3;border-radius:12px;padding:14px;margin-bottom:10px;">
          <div style="font-size:11px;color:#6B7A99;font-weight:700;text-transform:uppercase;margin-bottom:6px;">Withdrawal Summary</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
            <span style="font-size:13px;color:#6B7A99;">You Request</span>
            <span style="font-size:16px;font-weight:700;color:#FF4D6D;">â‚¦${fmtN(amountVal)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:8px;border-bottom:1px dashed #ffd0d9;">
            <span style="font-size:13px;color:#6B7A99;">10% Charge</span>
            <span style="font-size:14px;font-weight:700;color:#FF4D6D;">- â‚¦${fmtN(Math.round(amountVal * 0.10))}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:13px;font-weight:700;color:#0D1B3E;">âœ… You Receive</span>
            <span style="font-size:20px;font-weight:800;color:#00C48C;font-family:'Sora',sans-serif;">â‚¦${fmtN(Math.round(amountVal * 0.90))}</span>
          </div>
        </div>
        <div style="background:#F0F4FF;border-radius:10px;padding:11px 14px;font-size:13px;line-height:1.7;margin-bottom:10px;">
          <b>Bank:</b> ${bankName}<br>
          <b>Account Name:</b> ${accountName}<br>
          <b>Account Number:</b> ${accountNumber}
        </div>
        <div style="font-size:12px;color:#6B7A99;text-align:center;">
          Balance after: <b style="color:#0D1B3E;">â‚¦${fmtFull(currentBalance - amountVal)}</b>
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'âœ… Yes, Request Withdrawal',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#FF4D6D',
    cancelButtonColor: '#6B7A99'
  });

  if (!confirm.isConfirmed) return;

  /* â”€â”€ Processing â”€â”€ */
  btn.disabled = true;
  Swal.fire({
    title: 'Processing...',
    html: '<div style="font-family:\'Plus Jakarta Sans\',sans-serif;color:#6B7A99;font-size:13px;">Deducting balance and submitting request...</div>',
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const userRef     = db.collection('users').doc(currentUserId);
    const refCode     = 'WDL-' + Date.now().toString(36).toUpperCase().slice(-6);

    /* â”€â”€ ATOMIC TRANSACTION: deduct + create record â”€â”€ */
    let wdlId = null;
    await db.runTransaction(async (tx) => {
      const uSnap = await tx.get(userRef);
      if (!uSnap.exists) throw new Error('Account not found.');

      const latestBalance = Number(uSnap.data().balance || 0);
      if (amountVal > latestBalance) {
        throw new Error(`Insufficient balance. Current balance: â‚¦${fmtFull(latestBalance)}`);
      }

      /* Deduct from user balance */
      tx.update(userRef, {
        balance: firebase.firestore.FieldValue.increment(-amountVal)
      });

      /* Create withdrawal document â€” ALL info admin needs â”€â”€ */
      const wdlRef = db.collection('withdrawals').doc();
      wdlId = wdlRef.id;

      tx.set(wdlRef, {
        /* User identity */
        userId:       currentUserId,
        userEmail:    currentUserId ? (currentUserData.email || '') : '',
        userName:     currentUserData.fullName || currentUserData.username || 'Unknown',
        userPhone:    currentUserData.phone || '',
        userUsername: currentUserData.username || '',

        /* Withdrawal details */
        amount:        amountVal,
        feeAmount:     Math.round(amountVal * WITHDRAWAL_FEE_PCT / 100),
        receiveAmount: Math.round(amountVal * (1 - WITHDRAWAL_FEE_PCT / 100)),
        refCode,
        status:        'pending',   /* admin changes to approved / rejected */

        /* Bank account details */
        bankName,
        accountName,
        accountNumber,

        /* Balance snapshot for admin reference */
        balanceBefore: currentBalance,
        balanceAfter:  currentBalance - amountVal,

        /* Timestamps */
        requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt:   firebase.firestore.FieldValue.serverTimestamp(),

        /* Admin fields (to be filled by admin) */
        adminNote:   '',
        processedAt: null
      });
    });

    /* â”€â”€ Update local balance â”€â”€ */
    currentBalance -= amountVal;
    document.getElementById('balanceDisplay').textContent = fmtFull(currentBalance);

    Swal.close();

    /* â”€â”€ Success dialog â”€â”€ */
    await Swal.fire({
      icon: 'success',
      title: 'âœ… Withdrawal Submitted!',
      html: `
        <div style="font-family:'Plus Jakarta Sans',sans-serif;text-align:center;">
          <div style="font-size:14px;color:#0D1B3E;font-weight:700;margin-bottom:6px;">â‚¦${fmtN(amountVal)} requested</div>
          <div style="font-size:13px;color:#6B7A99;margin-bottom:14px;">Your balance has been debited. Admin will process within 24 hours.</div>
          <div style="background:#FFF0F3;border-radius:10px;padding:10px 14px;display:inline-block;margin-bottom:10px;">
            <div style="font-size:11px;color:#6B7A99;font-weight:700;">Reference Code</div>
            <div style="font-size:16px;font-weight:800;color:#FF4D6D;letter-spacing:1px;">${refCode}</div>
          </div>
          <div style="font-size:12px;color:#6B7A99;">New balance: <b style="color:#0D1B3E;">â‚¦${fmtFull(currentBalance)}</b></div>
        </div>
      `,
      confirmButtonText: 'Done',
      confirmButtonColor: '#FF4D6D'
    });

    /* Reset form & reload history */
    renderWithdrawForm();
    await loadHistory();

  } catch(err) {
    console.error('Withdrawal error:', err);
    Swal.fire({
      icon: 'error',
      title: 'Withdrawal Failed',
      text: err.message || 'Something went wrong. Please try again.',
      confirmButtonColor: '#FF4D6D'
    });
  } finally {
    const b = document.getElementById('submitWdlBtn');
    if (b) b.disabled = false;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD WITHDRAWAL HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadHistory() {
  try {
    const rawSnap = await db.collection('withdrawals')
      .where('userId', '==', currentUserId)
      .get();

    /* Sort newest first client-side â€” no composite index needed */
    const snap = { docs: rawSnap.docs.sort((a, b) => {
      const at = a.data().requestedAt ? a.data().requestedAt.toMillis() : 0;
      const bt = b.data().requestedAt ? b.data().requestedAt.toMillis() : 0;
      return bt - at;
    }).slice(0, 20), empty: rawSnap.empty };

    const list = document.getElementById('wdlList');
    list.innerHTML = '';

    /* Update pending pill */
    const pendingCount = rawSnap.docs.filter(d => d.data().status === 'pending').length;
    if (pendingCount > 0) {
      document.getElementById('pendingPill').style.display = 'block';
      document.getElementById('pendingCount').textContent  = pendingCount;
    } else {
      document.getElementById('pendingPill').style.display = 'none';
    }

    if (snap.empty) {
      list.innerHTML = `
        <div class="empty-history">
          <div class="empty-history-emoji">ğŸ“­</div>
          <div class="empty-history-title">No Withdrawals Yet</div>
          <div class="empty-history-sub">Your withdrawal history will appear here.</div>
        </div>`;
      return;
    }

    const iconMap  = { pending:'â³', approved:'âœ…', rejected:'âŒ' };
    const labelMap = { pending:'Pending', approved:'Approved', rejected:'Rejected' };

    snap.docs.forEach((doc, i) => {
      const d      = doc.data();
      const status = d.status || 'pending';
      const dateStr = d.requestedAt
        ? d.requestedAt.toDate().toLocaleDateString('en-NG', {
            day:'2-digit', month:'short', year:'numeric',
            hour:'2-digit', minute:'2-digit'
          })
        : 'Just now';

      const item = document.createElement('div');
      item.className = 'wdl-item';
      item.style.animationDelay = (i * 0.05) + 's';
      item.innerHTML = `
        <div class="wdl-icon ${status}">${iconMap[status] || 'ğŸ’¸'}</div>
        <div class="wdl-info">
          <div class="wdl-amount">â‚¦${fmtN(d.amount)}</div>
          <div class="wdl-bank">${d.bankName || ''} â€¢ ${d.accountName || ''}</div>
          <div class="wdl-date">${dateStr}</div>
        </div>
        <div class="wdl-right">
          <div class="wdl-badge ${status}">${labelMap[status] || status}</div>
          <div class="wdl-ref">${d.refCode || ''}</div>
        </div>
      `;
      list.appendChild(item);
    });

  } catch(err) {
    console.error('History load error:', err);
    document.getElementById('wdlList').innerHTML = `
      <div class="empty-history">
        <div class="empty-history-emoji">ğŸ“­</div>
        <div class="empty-history-title">No Withdrawals Yet</div>
        <div class="empty-history-sub">Your withdrawal history will appear here.</div>
      </div>`;
  }
}

</script>
</body>
</html>

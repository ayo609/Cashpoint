<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cashpoint | My Investments</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  /* ========== ROOT VARIABLES ========== */
  :root {
    --primary: #0052FF;
    --primary-light: #3b7dff;
    --primary-dark: #0039b3;
    --accent: #00D4A0;
    --accent-dark: #00a87e;
    --warning: #FFB800;
    --danger: #FF4D6D;
    --success: #00C48C;
    --bg: #F0F4FF;
    --card: #ffffff;
    --text: #0D1B3E;
    --muted: #6B7A99;
    --border: #D8E0F0;
    --nav-h: 70px;
    --bottom-h: 72px;
  }

  /* ========== GLOBAL RESETS ========== */
  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }
  
  html { 
    scroll-behavior: smooth; 
  }

  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: calc(var(--bottom-h) + 20px);
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* ========== TOP BAR ========== */
  .topbar {
    position: sticky;
    top: 0;
    z-index: 900;
    height: var(--nav-h);
    background: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    gap: 12px;
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .topbar-logo {
    width: 38px;
    height: 38px;
    background: var(--primary);
    border-radius: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }

  .topbar-brand {
    font-family: 'Sora', sans-serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.3px;
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .topbar-clock {
    font-size: 12.5px;
    color: var(--muted);
    font-weight: 600;
    display: none;
  }

  @media (min-width: 520px) {
    .topbar-clock {
      display: block;
    }
  }

  .user-avatar {
    width: 38px;
    height: 38px;
    border-radius: 11px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    font-size: 15px;
    cursor: pointer;
  }

  .refresh-btn {
    width: 38px;
    height: 38px;
    border-radius: 11px;
    background: var(--bg);
    border: 1.5px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s;
  }

  .refresh-btn:hover {
    background: #dde6ff;
  }

  .refresh-btn.spinning {
    animation: spin 0.7s linear;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* ========== HERO SECTION ========== */
  .hero {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 55%, #001c6b 100%);
    padding: 28px 22px 96px;
    position: relative;
    overflow: hidden;
  }

  .hero::before {
    content: '';
    position: absolute;
    width: 360px;
    height: 360px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
    top: -100px;
    right: -80px;
  }

  .hero::after {
    content: '';
    position: absolute;
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: rgba(0, 212, 160, 0.1);
    bottom: -60px;
    left: -40px;
  }

  .hero-tag {
    font-size: 11.5px;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 5px;
    position: relative;
    z-index: 1;
  }

  .hero-title {
    font-family: 'Sora', sans-serif;
    font-size: clamp(22px, 5.5vw, 30px);
    font-weight: 700;
    color: #fff;
    margin-bottom: 6px;
    position: relative;
    z-index: 1;
  }

  .hero-sub {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.65);
    font-weight: 500;
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 7px;
  }

  .live-dot {
    width: 7px;
    height: 7px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
    flex-shrink: 0;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.6); opacity: 0.5; }
  }

  /* ========== STATS CARD ========== */
  .stats-outer {
    padding: 0 16px;
    margin-top: -56px;
    position: relative;
    z-index: 10;
  }

  .stats-card {
    background: white;
    border-radius: 22px;
    box-shadow: 0 14px 44px rgba(0, 82, 255, 0.14);
    padding: 20px 22px;
    display: flex;
    align-items: stretch;
    justify-content: space-around;
    gap: 0;
    animation: riseUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
  }

  @keyframes riseUp {
    from {
      opacity: 0;
      transform: translateY(22px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .stat-item {
    flex: 1;
    text-align: center;
    padding: 0 12px;
  }

  .stat-item+.stat-item {
    border-left: 1px solid var(--border);
  }

  .stat-val {
    font-family: 'Sora', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-lbl {
    font-size: 10.5px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* ========== SECTION STYLES ========== */
  .section {
    padding: 24px 16px 0;
  }

  .section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .section-title {
    font-family: 'Sora', sans-serif;
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
  }

  .sec-badge {
    background: var(--primary);
    color: white;
    border-radius: 99px;
    padding: 3px 11px;
    font-size: 12px;
    font-weight: 700;
  }

  /* ========== FILTER TABS ========== */
  .tabs-row {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 2px;
    margin-bottom: 16px;
  }

  .tabs-row::-webkit-scrollbar {
    display: none;
  }

  .tab-btn {
    flex-shrink: 0;
    padding: 8px 18px;
    border-radius: 99px;
    font-size: 13px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    border: 1.5px solid var(--border);
    background: white;
    color: var(--muted);
    transition: all 0.2s;
  }

  .tab-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .tab-btn:hover:not(.active) {
    background: var(--bg);
  }

  /* ========== INVESTMENT STACK ========== */
  .inv-stack {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* ========== INVESTMENT CARD ========== */
  .inv-card {
    background: white;
    border-radius: 22px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 82, 255, 0.08);
    transition: all 0.2s;
    animation: riseUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
  }

  .inv-card:hover {
    box-shadow: 0 10px 32px rgba(0, 82, 255, 0.14);
    transform: translateY(-2px);
  }

  .inv-card.completed {
    opacity: 0.7;
  }

  .inv-card-bar {
    height: 5px;
    width: 100%;
  }

  .inv-card-body {
    padding: 20px;
  }

  .inv-card-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 16px;
  }

  .inv-plan-name {
    font-family: 'Sora', sans-serif;
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
  }

  .inv-status-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 12px;
    border-radius: 99px;
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .ist-active {
    background: #E8FFF6;
    color: var(--success);
  }

  .ist-completed {
    background: #F0F4FF;
    color: var(--muted);
  }

  .pulse-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    animation: pulse 1.6s ease-in-out infinite;
  }

  .pd-green {
    background: var(--success);
  }

  .inv-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 14px;
  }

  .inv-det {
    background: var(--bg);
    border-radius: 11px;
    padding: 10px 12px;
  }

  .det-lbl {
    font-size: 10px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 3px;
  }

  .det-val {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
  }

  .det-val.green {
    color: var(--success);
  }

  .det-val.gold {
    color: var(--warning);
  }

  .det-val.blue {
    color: var(--primary);
  }

  .prog-wrap {
    margin-bottom: 14px;
  }

  .prog-meta {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
    margin-bottom: 7px;
  }

  .prog-track {
    background: var(--border);
    border-radius: 99px;
    height: 9px;
    overflow: hidden;
  }

  .prog-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    transition: width 0.7s ease;
  }

  .prog-fill.done {
    background: linear-gradient(90deg, var(--success), #00f5b0);
  }

  .roi-box {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--bg);
    border-radius: 13px;
    padding: 13px 16px;
    margin-bottom: 12px;
    gap: 10px;
  }

  .roi-box-left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }

  .roi-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: #E8F0FF;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    flex-shrink: 0;
  }

  .roi-label {
    font-size: 11.5px;
    font-weight: 700;
    color: var(--muted);
  }

  .roi-countdown {
    font-family: 'Sora', sans-serif;
    font-size: 17px;
    font-weight: 700;
    color: var(--primary);
    letter-spacing: 1px;
  }

  .roi-countdown.ready {
    color: var(--success);
    letter-spacing: 0;
    font-size: 14px;
  }

  .earned-banner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #E8FFF6, #d0fff0);
    border-radius: 12px;
    padding: 12px 16px;
  }

  .earned-lbl {
    font-size: 11px;
    font-weight: 700;
    color: var(--success);
    margin-bottom: 2px;
  }

  .earned-amt {
    font-family: 'Sora', sans-serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
  }

  .completed-banner {
    background: #F0F4FF;
    border-radius: 12px;
    padding: 12px 16px;
    text-align: center;
    font-size: 13px;
    font-weight: 700;
    color: var(--muted);
    margin-bottom: 12px;
  }

  /* ========== EMPTY STATE ========== */
  .empty-box {
    background: white;
    border-radius: 20px;
    padding: 50px 24px;
    text-align: center;
    box-shadow: 0 4px 16px rgba(0, 82, 255, 0.07);
  }

  .empty-emoji {
    font-size: 58px;
    margin-bottom: 14px;
  }

  .empty-title {
    font-family: 'Sora', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
  }

  .empty-sub {
    font-size: 14px;
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 22px;
  }

  .empty-cta {
    display: inline-block;
    padding: 13px 30px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 99px;
    font-size: 14px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    text-decoration: none;
    box-shadow: 0 6px 20px rgba(0, 82, 255, 0.28);
    transition: all 0.15s;
  }

  .empty-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 28px rgba(0, 82, 255, 0.36);
  }

  /* ========== ROI TOAST ========== */
  .roi-toast {
    position: fixed;
    top: 80px;
    right: 16px;
    z-index: 9999;
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 82, 255, 0.18);
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
    max-width: 300px;
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(60px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .toast-icon {
    font-size: 24px;
    flex-shrink: 0;
  }

  .toast-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 2px;
  }

  .toast-sub {
    font-size: 11.5px;
    color: var(--muted);
    font-weight: 600;
  }

  /* ========== SKELETON LOADING ========== */
  .skeleton {
    background: linear-gradient(90deg, #e8edf5 25%, #f4f7fc 50%, #e8edf5 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 9px;
  }

  @keyframes shimmer {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  .skel-card {
    background: white;
    border-radius: 22px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0, 82, 255, 0.07);
  }

  .skel-bar {
    height: 5px;
  }

  .skel-body {
    padding: 20px;
  }

  /* ========== BOTTOM NAVIGATION ========== */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--bottom-h);
    background: white;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 8px;
    z-index: 999;
    box-shadow: 0 -4px 24px rgba(0, 82, 255, 0.09);
  }

  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 14px;
    flex: 1;
    max-width: 74px;
    transition: background 0.2s;
    cursor: pointer;
  }

  .nav-item:hover {
    background: var(--bg);
  }

  .nav-item i {
    font-size: 20px;
    color: var(--muted);
    transition: all 0.2s;
  }

  .nav-item span {
    font-size: 10.5px;
    font-weight: 700;
    color: var(--muted);
    transition: color 0.2s;
  }

  .nav-item.active i,
  .nav-item.active span {
    color: var(--primary);
  }

  .nav-item.active i {
    transform: translateY(-2px);
  }

  .nav-center {
    width: 52px;
    height: 52px;
    border-radius: 16px;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 22px rgba(0, 82, 255, 0.38);
    text-decoration: none;
    transition: transform 0.2s;
    margin-bottom: 10px;
    flex-shrink: 0;
  }

  .nav-center:hover {
    transform: translateY(-3px);
  }

  .nav-center i {
    color: white;
    font-size: 21px;
  }

  .page-bottom {
    height: 16px;
  }
</style>
</head>
<body>

<!-- ========== TOP BAR ========== -->
<div class="topbar">
  <div class="topbar-left">
    <div class="topbar-logo">üí∞</div>
    <span class="topbar-brand">My Investments</span>
  </div>
  <div class="topbar-right">
    <span class="topbar-clock" id="topClock">--:--</span>
    <div class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">
      <i class="fas fa-sync-alt"></i>
    </div>
    <div class="user-avatar" id="avatarBox">?</div>
  </div>
</div>

<!-- ========== HERO SECTION ========== -->
<div class="hero">
  <div class="hero-tag">My Portfolio</div>
  <div class="hero-title">Active Investments üìà</div>
  <div class="hero-sub">
    <div class="live-dot"></div>
    <span id="heroSub">Loading your portfolio...</span>
  </div>
</div>

<!-- ========== STATS CARD ========== -->
<div class="stats-outer">
  <div class="stats-card">
    <div class="stat-item">
      <div class="stat-val" id="statBalance">‚Ç¶0</div>
      <div class="stat-lbl">Balance</div>
    </div>
    <div class="stat-item">
      <div class="stat-val" id="statInvested">‚Ç¶0</div>
      <div class="stat-lbl">Invested</div>
    </div>
    <div class="stat-item">
      <div class="stat-val" id="statEarnings">‚Ç¶0</div>
      <div class="stat-lbl">Total Earned</div>
    </div>
  </div>
</div>

<!-- ========== INVESTMENTS SECTION ========== -->
<div class="section">
  <div class="section-head">
    <div class="section-title">Investment Plans</div>
    <div class="sec-badge" id="invCountBadge">0</div>
  </div>

  <!-- Filter Tabs -->
  <div class="tabs-row">
    <button class="tab-btn active" onclick="filterInvs('all', this)">All</button>
    <button class="tab-btn" onclick="filterInvs('active', this)">Active</button>
    <button class="tab-btn" onclick="filterInvs('completed', this)">Completed</button>
  </div>

  <!-- Investment Stack -->
  <div class="inv-stack" id="invStack">
    <!-- Skeleton Loaders -->
    <div class="skel-card">
      <div class="skeleton skel-bar"></div>
      <div class="skel-body">
        <div class="skeleton" style="height:17px;width:55%;margin-bottom:14px;"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
          <div class="skeleton" style="height:52px;border-radius:11px;"></div>
          <div class="skeleton" style="height:52px;border-radius:11px;"></div>
          <div class="skeleton" style="height:52px;border-radius:11px;"></div>
          <div class="skeleton" style="height:52px;border-radius:11px;"></div>
        </div>
        <div class="skeleton" style="height:9px;margin-bottom:14px;"></div>
        <div class="skeleton" style="height:50px;border-radius:13px;"></div>
      </div>
    </div>
    <div class="skel-card">
      <div class="skeleton skel-bar"></div>
      <div class="skel-body">
        <div class="skeleton" style="height:17px;width:48%;margin-bottom:14px;"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
          <div class="skeleton" style="height:52px;border-radius:11px;"></div>
          <div class="skeleton" style="height:52px;border-radius:11px;"></div>
          <div class="skeleton" style="height:52px;border-radius:11px;"></div>
          <div class="skeleton" style="height:52px;border-radius:11px;"></div>
        </div>
        <div class="skeleton" style="height:9px;margin-bottom:14px;"></div>
        <div class="skeleton" style="height:50px;border-radius:13px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="page-bottom"></div>

<!-- ========== BOTTOM NAVIGATION ========== -->
<div class="bottom-nav">
  <a href="home.html" class="nav-item">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </a>
  <a href="plans.html" class="nav-item">
    <i class="fas fa-chart-line"></i>
    <span>Plans</span>
  </a>
  <a href="investments.html" class="nav-center">
    <i class="fas fa-wallet"></i>
  </a>
  <a href="referrals.html" class="nav-item">
    <i class="fas fa-users"></i>
    <span>Referrals</span>
  </a>
  <a href="dashboard.html" class="nav-item">
    <i class="fas fa-user-circle"></i>
    <span>Profile</span>
  </a>
</div>

<!-- ========== JAVASCRIPT ========== -->
<script>
(function() {
  'use strict';

  /* ========== FIREBASE CONFIGURATION ========== */
  const firebaseConfig = {
    apiKey: "AIzaSyCFwefJ8rxZUDLbDsRHnHdA-28zPs49rlo",
    authDomain: "cashpoint-ac4f4.firebaseapp.com",
    projectId: "cashpoint-ac4f4",
    storageBucket: "cashpoint-ac4f4.firebasestorage.app",
    messagingSenderId: "16133206416",
    appId: "1:16133206416:web:a093f4e153ad2c9bcc8315"
  };

  // Initialize Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  /* ========== FIREBASE SERVICES ========== */
  const auth = firebase.auth();
  const db = firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  /* ========== CONSTANTS ========== */
  const MS_PER_DAY = 24 * 60 * 60 * 1000;
  const REFRESH_INTERVAL = 60000; // 60 seconds

  /* ========== GLOBAL STATE ========== */
  let currentUser = null;
  let currentUserId = null;
  let allInvestments = [];
  let currentFilter = 'all';
  let refreshInterval = null;
  let isPageLoaded = false;

  /* ========== UTILITY FUNCTIONS ========== */

  /**
   * Format currency with NGN symbol
   */
  function formatMoney(amount) {
    return '‚Ç¶' + Number(amount || 0).toLocaleString('en-NG', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  /**
   * Format short currency (K, M suffixes)
   */
  function formatShort(amount) {
    const value = Number(amount || 0);
    if (value >= 1000000) return '‚Ç¶' + (value / 1000000).toFixed(2) + 'M';
    if (value >= 1000) return '‚Ç¶' + (value / 1000).toFixed(1) + 'K';
    return '‚Ç¶' + value.toLocaleString('en-NG');
  }

  /**
   * Update live clock in topbar
   */
  function updateLiveClock() {
    const now = new Date();
    document.getElementById('topClock').textContent = now.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  /**
   * Get color based on plan name
   */
  function getPlanColor(planName) {
    const name = (planName || '').toLowerCase();
    
    if (name.includes('basic')) return '#6B7A99';
    if (name.includes('starter')) return '#4CAF50';
    if (name.includes('silver')) return '#78909C';
    if (name.includes('gold')) return '#FFB800';
    if (name.includes('platinum')) return '#0052FF';
    if (name.includes('diamond')) return '#00C48C';
    if (name.includes('elite')) return '#9B59B6';
    if (name.includes('vip')) return '#FF4D6D';
    if (name.includes('ultimate')) return '#001c6b';
    
    return '#0052FF';
  }

  /* ========== AUTHENTICATION ========== */

  /**
   * Handle authentication state changes
   */
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    currentUser = user;
    currentUserId = user.uid;

    // Clear any existing refresh interval
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }

    // Initial data load
    await loadInvestments();

    // Set up periodic refresh
    refreshInterval = setInterval(() => {
      refreshData();
    }, REFRESH_INTERVAL);

    // Mark page as loaded
    isPageLoaded = true;
  });

  /* ========== DATA LOADING ========== */

  /**
   * Load all investments and user data from Firestore
   */
  async function loadInvestments() {
    try {
      // Load user data first
      await loadUserData();

      // Then load investments - WITH orderBy now that index exists
      await loadInvestmentData();

    } catch (error) {
      console.error('Error loading investments:', error);
      
      // Check if it's an index error (index might still be building)
      if (error.code === 'failed-precondition' || error.message.includes('index')) {
        Swal.fire({
          icon: 'info',
          title: 'Index Building',
          text: 'Your database index is still being built. Please wait a few minutes and refresh.',
          confirmButtonColor: '#0052FF'
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load investment data. Please refresh the page.',
          confirmButtonColor: '#0052FF'
        });
      }
    }
  }

  /**
   * Load user data from Firestore
   */
  async function loadUserData() {
    const userDoc = await db.collection('users').doc(currentUserId).get();
    
    if (!userDoc.exists) {
      await auth.signOut();
      window.location.href = 'login.html';
      return;
    }

    const userData = userDoc.data();

    // Update UI with user data
    document.getElementById('statBalance').textContent = formatShort(userData.balance);
    document.getElementById('statInvested').textContent = formatShort(userData.totalInvested);
    document.getElementById('statEarnings').textContent = formatShort(userData.totalEarnings);

    // Set avatar
    const firstName = (userData.fullName || userData.username || 'User').split(' ')[0];
    document.getElementById('avatarBox').textContent = firstName.charAt(0).toUpperCase();

    return userData;
  }

  /**
   * Load investment data from Firestore - USING INDEX NOW
   */
  async function loadInvestmentData() {
    // Use orderBy now that index exists
    const investmentsSnapshot = await db.collection('investments')
      .where('userId', '==', currentUserId)
      .orderBy('createdAt', 'desc')
      .get();

    allInvestments = investmentsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    // Check for and credit any missed ROI
    await checkAndCreditMissedROI();

    // Update UI
    updateInvestmentStats();
    renderInvestments();
  }

  /**
   * Refresh data (called by interval)
   */
  async function refreshData() {
    if (!isPageLoaded) return;
    
    try {
      await loadInvestmentData();
    } catch (error) {
      console.error('Error refreshing data:', error);
    }
  }

  /* ========== ROI CREDITING ========== */

  /**
   * Check for and credit any missed ROI cycles
   */
  async function checkAndCreditMissedROI() {
    const now = Date.now();
    const activeInvestments = allInvestments.filter(inv => inv.status === 'active');
    
    let totalCredited = 0;
    const creditedPlans = [];

    for (const inv of activeInvestments) {
      const activationTime = inv.activationTime?.toMillis() || now;
      const lastROITime = inv.lastROI?.toMillis() || activationTime;
      
      // Calculate cycles
      const cyclesPassed = Math.floor((now - activationTime) / MS_PER_DAY);
      const cyclesCredited = Math.floor((lastROITime - activationTime) / MS_PER_DAY);
      
      // Check if plan duration has expired
      const durationDays = inv.durationDays || 30;
      if (cyclesPassed >= durationDays) {
        await completeInvestment(inv.id);
        continue;
      }
      
      const missedCycles = cyclesPassed - cyclesCredited;
      
      if (missedCycles > 0) {
        const amount = inv.dailyROI * missedCycles;
        await creditInvestment(inv.id, amount, missedCycles);
        totalCredited += amount;
        creditedPlans.push(inv.planName);
      }
    }

    if (totalCredited > 0) {
      showROIToast(totalCredited, creditedPlans);
      
      // Reload data to reflect changes
      await loadUserData();
    }
  }

  /**
   * Credit a specific investment
   */
  async function creditInvestment(investmentId, amount, cycles) {
    try {
      await db.runTransaction(async (transaction) => {
        const userRef = db.collection('users').doc(currentUserId);
        const invRef = db.collection('investments').doc(investmentId);
        
        const userDoc = await transaction.get(userRef);
        const invDoc = await transaction.get(invRef);
        
        if (!userDoc.exists || !invDoc.exists) return;
        
        // Update user balance
        transaction.update(userRef, {
          balance: FieldValue.increment(amount),
          totalEarnings: FieldValue.increment(amount)
        });
        
        // Update investment
        transaction.update(invRef, {
          lastROI: FieldValue.serverTimestamp(),
          totalEarned: FieldValue.increment(amount)
        });
        
        // Create ROI log
        const logRef = db.collection('roi_logs').doc();
        transaction.set(logRef, {
          userId: currentUserId,
          invId: investmentId,
          planName: invDoc.data().planName,
          amount: amount,
          cycles: cycles,
          creditedAt: FieldValue.serverTimestamp()
        });
      });
    } catch (error) {
      console.error('Error crediting investment:', error);
    }
  }

  /**
   * Complete an investment
   */
  async function completeInvestment(investmentId) {
    try {
      await db.collection('investments').doc(investmentId).update({
        status: 'completed',
        completedAt: FieldValue.serverTimestamp()
      });
    } catch (error) {
      console.error('Error completing investment:', error);
    }
  }

  /* ========== UI UPDATES ========== */

  /**
   * Update investment statistics in header
   */
  function updateInvestmentStats() {
    const activeCount = allInvestments.filter(i => i.status === 'active').length;
    document.getElementById('heroSub').textContent = 
      `${activeCount} active plan${activeCount !== 1 ? 's' : ''} earning daily`;
    document.getElementById('invCountBadge').textContent = allInvestments.length;
  }

  /**
   * Render investments based on current filter
   */
  function renderInvestments() {
    const stack = document.getElementById('invStack');
    stack.innerHTML = '';
    
    const filtered = filterInvestments();
    
    if (filtered.length === 0) {
      renderEmptyState(stack);
      return;
    }
    
    filtered.forEach((investment, index) => {
      const card = createInvestmentCard(investment, index);
      stack.appendChild(card);
    });
  }

  /**
   * Filter investments based on current filter
   */
  function filterInvestments() {
    return allInvestments.filter(inv => {
      if (currentFilter === 'active') return inv.status === 'active';
      if (currentFilter === 'completed') return inv.status === 'completed';
      return true;
    });
  }

  /**
   * Create an investment card element
   */
  function createInvestmentCard(inv, index) {
    const card = document.createElement('div');
    card.className = 'inv-card' + (inv.status === 'completed' ? ' completed' : '');
    card.style.animationDelay = (index * 0.06) + 's';
    
    const now = Date.now();
    const activationTime = inv.activationTime?.toMillis() || now;
    const durationDays = inv.durationDays || 30;
    
    // Calculate progress
    const daysPassed = Math.floor((now - activationTime) / MS_PER_DAY);
    const daysLeft = Math.max(0, durationDays - daysPassed);
    const progress = Math.min((daysPassed / durationDays) * 100, 100);
    
    // Calculate next ROI
    const cyclesCompleted = Math.floor((now - activationTime) / MS_PER_DAY);
    const nextROITime = activationTime + ((cyclesCompleted + 1) * MS_PER_DAY);
    const timeToNextROI = nextROITime - now;
    
    // Calculate total earned
    const totalEarned = (inv.dailyROI || 0) * daysPassed;
    
    // Format dates
    const startDate = new Date(activationTime).toLocaleDateString('en-NG', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
    
    const endDate = new Date(activationTime + (durationDays * MS_PER_DAY)).toLocaleDateString('en-NG', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
    
    // Status tag
    const statusTag = inv.status === 'active' 
      ? `<span class="inv-status-tag ist-active"><div class="pulse-dot pd-green"></div> Active</span>`
      : `<span class="inv-status-tag ist-completed"><i class="fas fa-check-circle"></i> Completed</span>`;
    
    // Countdown display
    let countdownDisplay = '--:--:--';
    let countdownClass = '';
    
    if (inv.status === 'active') {
      if (timeToNextROI <= 0) {
        countdownDisplay = '‚úì Crediting Soon';
        countdownClass = 'ready';
      } else {
        const hours = Math.floor(timeToNextROI / 3600000);
        const minutes = Math.floor((timeToNextROI % 3600000) / 60000);
        const seconds = Math.floor((timeToNextROI % 60000) / 1000);
        countdownDisplay = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }
    }
    
    card.innerHTML = `
      <div class="inv-card-bar" style="background:${getPlanColor(inv.planName)};"></div>
      <div class="inv-card-body">
        <div class="inv-card-head">
          <div class="inv-plan-name">${inv.planName || 'Investment Plan'}</div>
          ${statusTag}
        </div>
        
        <div class="inv-details">
          <div class="inv-det">
            <div class="det-lbl">Amount</div>
            <div class="det-val">${formatMoney(inv.amount || inv.capital)}</div>
          </div>
          <div class="inv-det">
            <div class="det-lbl">Daily ROI</div>
            <div class="det-val green">${formatMoney(inv.dailyROI)}</div>
          </div>
          <div class="inv-det">
            <div class="det-lbl">Start</div>
            <div class="det-val" style="font-size:12px;">${startDate}</div>
          </div>
          <div class="inv-det">
            <div class="det-lbl">End</div>
            <div class="det-val" style="font-size:12px;">${endDate}</div>
          </div>
          <div class="inv-det">
            <div class="det-lbl">Progress</div>
            <div class="det-val blue">${daysPassed}/${durationDays}</div>
          </div>
          <div class="inv-det">
            <div class="det-lbl">Days Left</div>
            <div class="det-val">${daysLeft}</div>
          </div>
        </div>
        
        <div class="prog-wrap">
          <div class="prog-meta">
            <span>Plan Progress</span>
            <span>${progress.toFixed(1)}%</span>
          </div>
          <div class="prog-track">
            <div class="prog-fill" style="width: ${progress}%;"></div>
          </div>
        </div>
        
        ${inv.status === 'active' ? `
          <div class="roi-box">
            <div class="roi-box-left">
              <div class="roi-icon">‚è±</div>
              <div>
                <div class="roi-label">Next ROI Credit</div>
                <div class="roi-countdown ${countdownClass}" id="cd_${inv.id}">${countdownDisplay}</div>
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:10.5px;color:var(--muted);">Daily</div>
              <div style="font-size:15px;font-weight:700;color:var(--success);">${formatMoney(inv.dailyROI)}</div>
            </div>
          </div>
        ` : `
          <div class="completed-banner">
            ‚úÖ Completed on ${endDate}
          </div>
        `}
        
        <div class="earned-banner">
          <div class="earned-left">
            <div class="earned-lbl">Total Earned</div>
            <div class="earned-amt">${formatMoney(totalEarned)}</div>
          </div>
          <div class="earned-right">üìä</div>
        </div>
      </div>
    `;
    
    // Store data for countdown updates
    if (inv.status === 'active') {
      card.setAttribute('data-next-roi', nextROITime);
      card.setAttribute('data-inv-id', inv.id);
    }
    
    return card;
  }

  /**
   * Render empty state
   */
  function renderEmptyState(stack) {
    const messages = {
      all: 'You haven\'t made any investments yet.',
      active: 'No active investments. Choose a plan to start earning!',
      completed: 'No completed investments yet.'
    };
    
    stack.innerHTML = `
      <div class="empty-box">
        <div class="empty-emoji">üì≠</div>
        <div class="empty-title">No Investments Found</div>
        <div class="empty-sub">${messages[currentFilter]}</div>
        ${currentFilter !== 'completed' ? '<a href="plans.html" class="empty-cta">Browse Plans</a>' : ''}
      </div>`;
  }

  /**
   * Update all countdown displays
   */
  function updateCountdownDisplays() {
    const now = Date.now();
    
    document.querySelectorAll('.inv-card[data-next-roi]').forEach(card => {
      const invId = card.getAttribute('data-inv-id');
      const nextROITime = parseInt(card.getAttribute('data-next-roi'));
      const timerEl = document.getElementById(`cd_${invId}`);
      
      if (!timerEl || isNaN(nextROITime)) return;
      
      const timeLeft = nextROITime - now;
      
      if (timeLeft <= 0) {
        timerEl.textContent = '‚úì Crediting Soon';
        timerEl.classList.add('ready');
      } else {
        const hours = Math.floor(timeLeft / 3600000);
        const minutes = Math.floor((timeLeft % 3600000) / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        
        timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        timerEl.classList.remove('ready');
      }
    });
  }

  /* ========== NOTIFICATIONS ========== */

  /**
   * Show ROI credited toast
   */
  function showROIToast(amount, plans) {
    const existingToast = document.getElementById('roiToast');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.id = 'roiToast';
    toast.className = 'roi-toast';
    toast.innerHTML = `
      <div class="toast-icon">üí∞</div>
      <div>
        <div class="toast-title">ROI Credited! +${formatMoney(amount)}</div>
        <div class="toast-sub">${plans.join(', ')} added to balance</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      if (toast.parentNode) toast.remove();
    }, 4500);
  }

  /* ========== EVENT HANDLERS ========== */

  /**
   * Filter investments by status
   */
  window.filterInvs = function(filter, button) {
    currentFilter = filter;
    
    // Update active tab
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    button.classList.add('active');
    
    // Re-render
    renderInvestments();
  };

  /**
   * Manual refresh
   */
  window.manualRefresh = async function() {
    const btn = document.getElementById('refreshBtn');
    btn.classList.add('spinning');
    
    await loadInvestments();
    
    setTimeout(() => {
      btn.classList.remove('spinning');
    }, 700);
  };

  /* ========== INITIALIZATION ========== */

  // Start live clock
  updateLiveClock();
  setInterval(updateLiveClock, 1000);

  // Set up countdown updates
  setInterval(() => {
    if (isPageLoaded) {
      updateCountdownDisplays();
    }
  }, 1000);

})();
</script>
</body>
</html>
